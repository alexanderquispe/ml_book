<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Machine Learning for wage prediction | Machine Learning and Causal Inference</title>
  <meta name="description" content="Chapter 8 Machine Learning for wage prediction | Machine Learning and Causal Inference" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Machine Learning for wage prediction | Machine Learning and Causal Inference" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Machine Learning for wage prediction | Machine Learning and Causal Inference" />
  
  
  

<meta name="author" content="Alexander Quispe" />


<meta name="date" content="2021-11-04" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="testing-the-convergence-hypothesis.html"/>

<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Machine Learning and Causal Inference</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Predictive Inference 1</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#data"><i class="fa fa-check"></i><b>1.1</b> Data</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data-analysis"><i class="fa fa-check"></i><b>1.2</b> Data Analysis</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#r-and-python-code"><i class="fa fa-check"></i><b>1.2.1</b> R and Python code</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#prediction-question"><i class="fa fa-check"></i><b>1.3</b> Prediction Question</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#basic-model"><i class="fa fa-check"></i><b>1.3.1</b> Basic Model:</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#flexible-model"><i class="fa fa-check"></i><b>1.3.2</b> Flexible Model:</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#lasso-model"><i class="fa fa-check"></i><b>1.3.3</b> Lasso Model:</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#data-splitting"><i class="fa fa-check"></i><b>1.4</b> Data Splitting</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html"><i class="fa fa-check"></i><b>2</b> Predictive Inference The Gender Wage Gap</a>
<ul>
<li class="chapter" data-level="2.1" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#data-analysis-1"><i class="fa fa-check"></i><b>2.1</b> Data analysis</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#ols-regression"><i class="fa fa-check"></i><b>2.1.1</b> OLS Regression</a></li>
<li class="chapter" data-level="2.1.2" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#ols-regression-with-controls"><i class="fa fa-check"></i><b>2.1.2</b> Ols regression with controls</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#partialling-out-using-ols"><i class="fa fa-check"></i><b>2.2</b> Partialling-Out using ols</a></li>
<li class="chapter" data-level="2.3" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#partialling-out-using-lasso"><i class="fa fa-check"></i><b>2.3</b> Partialling-Out using lasso</a></li>
<li class="chapter" data-level="2.4" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#extra-flexible-model"><i class="fa fa-check"></i><b>2.4</b> “Extra” flexible model</a></li>
<li class="chapter" data-level="2.5" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#laso-extra-flexible-model"><i class="fa fa-check"></i><b>2.5</b> Laso “Extra” Flexible model</a></li>
<li class="chapter" data-level="2.6" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#summarize-the-results"><i class="fa fa-check"></i><b>2.6</b> Summarize the results</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html"><i class="fa fa-check"></i><b>3</b> Simple Exercise on Overfitting</a>
<ul>
<li class="chapter" data-level="3.1" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html#first-set-pn"><i class="fa fa-check"></i><b>3.1</b> 1. First set p=n</a></li>
<li class="chapter" data-level="3.2" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html#second-set-pn2."><i class="fa fa-check"></i><b>3.2</b> 2. Second, set p=n/2.</a></li>
<li class="chapter" data-level="3.3" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html#third-set-pn-.05"><i class="fa fa-check"></i><b>3.3</b> 3. Third, set p/n =.05</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="vaccine-rct-examples.html"><a href="vaccine-rct-examples.html"><i class="fa fa-check"></i><b>4</b> Vaccine RCT Examples</a>
<ul>
<li class="chapter" data-level="4.1" data-path="vaccine-rct-examples.html"><a href="vaccine-rct-examples.html#polio-rct"><i class="fa fa-check"></i><b>4.1</b> Polio RCT</a></li>
<li class="chapter" data-level="4.2" data-path="vaccine-rct-examples.html"><a href="vaccine-rct-examples.html#pfizerbntx-covid-19-rct"><i class="fa fa-check"></i><b>4.2</b> Pfizer/BNTX Covid-19 RCT</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="penalized-linear-regressions-a-simulation-experiment.html"><a href="penalized-linear-regressions-a-simulation-experiment.html"><i class="fa fa-check"></i><b>5</b> Penalized Linear Regressions: A Simulation Experiment</a>
<ul>
<li class="chapter" data-level="5.1" data-path="penalized-linear-regressions-a-simulation-experiment.html"><a href="penalized-linear-regressions-a-simulation-experiment.html#data-generating-process-approximately-sparse"><i class="fa fa-check"></i><b>5.1</b> Data Generating Process: Approximately Sparse</a></li>
<li class="chapter" data-level="5.2" data-path="penalized-linear-regressions-a-simulation-experiment.html"><a href="penalized-linear-regressions-a-simulation-experiment.html#data-generating-process-approximately-sparse-small-dense-part"><i class="fa fa-check"></i><b>5.2</b> Data Generating Process: Approximately Sparse + Small Dense Part</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="simulation-design.html"><a href="simulation-design.html"><i class="fa fa-check"></i><b>6</b> Simulation Design</a>
<ul>
<li class="chapter" data-level="6.1" data-path="simulation-design.html"><a href="simulation-design.html#example-1"><i class="fa fa-check"></i><b>6.1</b> Example 1</a></li>
<li class="chapter" data-level="6.2" data-path="simulation-design.html"><a href="simulation-design.html#example-2"><i class="fa fa-check"></i><b>6.2</b> Example 2</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html"><i class="fa fa-check"></i><b>7</b> Testing the Convergence Hypothesis</a>
<ul>
<li class="chapter" data-level="7.1" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#introduction"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#data-analysis-2"><i class="fa fa-check"></i><b>7.2</b> Data analysis</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#ols"><i class="fa fa-check"></i><b>7.2.1</b> OLS</a></li>
<li class="chapter" data-level="7.2.2" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#lasso"><i class="fa fa-check"></i><b>7.2.2</b> Lasso</a></li>
<li class="chapter" data-level="7.2.3" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#summary-results"><i class="fa fa-check"></i><b>7.2.3</b> Summary results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html"><i class="fa fa-check"></i><b>8</b> Machine Learning for wage prediction</a>
<ul>
<li class="chapter" data-level="8.1" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#data-1"><i class="fa fa-check"></i><b>8.1</b> Data</a></li>
<li class="chapter" data-level="8.2" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#analysis"><i class="fa fa-check"></i><b>8.2</b> Analysis</a></li>
<li class="chapter" data-level="8.3" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#ols-1"><i class="fa fa-check"></i><b>8.3</b> OLS</a></li>
<li class="chapter" data-level="8.4" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#lasso-ridge-and-elastic-net"><i class="fa fa-check"></i><b>8.4</b> Lasso, Ridge and Elastic Net</a></li>
<li class="chapter" data-level="8.5" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#non-linear-models"><i class="fa fa-check"></i><b>8.5</b> Non-linear models</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#regression-trees"><i class="fa fa-check"></i><b>8.5.1</b> Regression Trees</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#random-forest-and-boosted-trees"><i class="fa fa-check"></i><b>8.6</b> Random Forest and Boosted Trees</a></li>
<li class="chapter" data-level="8.7" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#results"><i class="fa fa-check"></i><b>8.7</b> Results</a></li>
<li class="chapter" data-level="8.8" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#ensemble-learning"><i class="fa fa-check"></i><b>8.8</b> Ensemble learning</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Machine Learning and Causal Inference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="machine-learning-for-wage-prediction" class="section level1" number="8">
<h1><span class="header-section-number">Chapter 8</span> Machine Learning for wage prediction</h1>
<p>We illustrate how to predict an outcome variable Y in a high-dimensional setting, where the number of covariates <span class="math inline">\(p\)</span> is large in relation to the sample size <span class="math inline">\(n\)</span>. So far we have used linear prediction rules, e.g. Lasso regression, for estimation. Now, we also consider nonlinear prediction rules including tree-based methods.</p>
<div id="data-1" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> Data</h2>
<p>Again, we consider data from the U.S. March Supplement of the Current Population Survey (CPS) in 2015. The preproccessed sample consists of <span class="math inline">\(5150\)</span> never-married individuals.</p>
<style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
</style>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="machine-learning-for-wage-prediction.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;./data/wage2015_subsample_inference.Rdata&quot;</span>)</span>
<span id="cb1-2"><a href="machine-learning-for-wage-prediction.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data)</span></code></pre></div>
<pre><code>## [1] 5150   20</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="machine-learning-for-wage-prediction.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Importing relevant libraries</span></span>
<span id="cb3-2"><a href="machine-learning-for-wage-prediction.html#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="machine-learning-for-wage-prediction.html#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-4"><a href="machine-learning-for-wage-prediction.html#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyreadr</span>
<span id="cb3-5"><a href="machine-learning-for-wage-prediction.html#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb3-6"><a href="machine-learning-for-wage-prediction.html#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-7"><a href="machine-learning-for-wage-prediction.html#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb3-8"><a href="machine-learning-for-wage-prediction.html#cb3-8" aria-hidden="true" tabindex="-1"></a>rdata_read <span class="op">=</span> pyreadr.read_r(<span class="st">&quot;./data/wage2015_subsample_inference.Rdata&quot;</span>)</span>
<span id="cb3-9"><a href="machine-learning-for-wage-prediction.html#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting the data frame from rdata_read</span></span>
<span id="cb3-10"><a href="machine-learning-for-wage-prediction.html#cb3-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> rdata_read[<span class="st">&quot;data&quot;</span>]</span>
<span id="cb3-11"><a href="machine-learning-for-wage-prediction.html#cb3-11" aria-hidden="true" tabindex="-1"></a>data.shape</span></code></pre></div>
<pre><code>## (5150, 20)</code></pre>
</div>
</div>
<p>The outcomes <span class="math inline">\(Y_i\)</span>’s are hourly (log) wages of never-married workers living in the U.S. The raw regressors <span class="math inline">\(Z_i\)</span>’s consist of a variety of characteristics, including experience, education and industry and occupation indicators.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="machine-learning-for-wage-prediction.html#cb5-1" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">subset</span>(data, <span class="at">select=</span><span class="sc">-</span><span class="fu">c</span>(lwage,wage)) <span class="co"># regressors</span></span>
<span id="cb5-2"><a href="machine-learning-for-wage-prediction.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Z)</span></code></pre></div>
<pre><code>##  [1] &quot;sex&quot;  &quot;shs&quot;  &quot;hsg&quot;  &quot;scl&quot;  &quot;clg&quot;  &quot;ad&quot;   &quot;mw&quot;   &quot;so&quot;   &quot;we&quot;   &quot;ne&quot;  
## [11] &quot;exp1&quot; &quot;exp2&quot; &quot;exp3&quot; &quot;exp4&quot; &quot;occ&quot;  &quot;occ2&quot; &quot;ind&quot;  &quot;ind2&quot;</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="machine-learning-for-wage-prediction.html#cb7-1" aria-hidden="true" tabindex="-1"></a>Z <span class="op">=</span> data.loc[:, <span class="st">&#39;sex&#39;</span>:<span class="st">&#39;ind2&#39;</span>]</span>
<span id="cb7-2"><a href="machine-learning-for-wage-prediction.html#cb7-2" aria-hidden="true" tabindex="-1"></a>Z.columns</span></code></pre></div>
<pre><code>## Index([&#39;sex&#39;, &#39;shs&#39;, &#39;hsg&#39;, &#39;scl&#39;, &#39;clg&#39;, &#39;ad&#39;, &#39;mw&#39;, &#39;so&#39;, &#39;we&#39;, &#39;ne&#39;, &#39;exp1&#39;,
##        &#39;exp2&#39;, &#39;exp3&#39;, &#39;exp4&#39;, &#39;occ&#39;, &#39;occ2&#39;, &#39;ind&#39;, &#39;ind2&#39;],
##       dtype=&#39;object&#39;)</code></pre>
</div>
</div>
<p>The following figure shows the weekly wage distribution from the US survey data.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="machine-learning-for-wage-prediction.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(data<span class="sc">$</span>wage, <span class="at">xlab=</span> <span class="st">&quot;hourly wage&quot;</span>, <span class="at">main =</span> <span class="st">&quot;Empirical wage distribution from the US survey data&quot;</span>, </span>
<span id="cb9-2"><a href="machine-learning-for-wage-prediction.html#cb9-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">breaks =</span> <span class="dv">35</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="machine-learning-for-wage-prediction.html#cb10-1" aria-hidden="true" tabindex="-1"></a>plt.hist(data.wage , bins <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">550</span>, <span class="dv">20</span>) )</span></code></pre></div>
<pre><code>## (array([2.783e+03, 1.858e+03, 3.520e+02, 9.200e+01, 3.600e+01, 1.100e+01,
##        5.000e+00, 3.000e+00, 0.000e+00, 2.000e+00, 1.000e+00, 0.000e+00,
##        1.000e+00, 1.000e+00, 0.000e+00, 1.000e+00, 0.000e+00, 0.000e+00,
##        0.000e+00, 1.000e+00, 0.000e+00, 0.000e+00, 0.000e+00, 0.000e+00,
##        1.000e+00, 0.000e+00, 2.000e+00]), array([  0,  20,  40,  60,  80, 100, 120, 140, 160, 180, 200, 220, 240,
##        260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500,
##        520, 540]), &lt;BarContainer object of 27 artists&gt;)</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="machine-learning-for-wage-prediction.html#cb12-1" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;hourly wage&#39;</span>)</span>
<span id="cb12-2"><a href="machine-learning-for-wage-prediction.html#cb12-2" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Frequency&#39;</span>)</span>
<span id="cb12-3"><a href="machine-learning-for-wage-prediction.html#cb12-3" aria-hidden="true" tabindex="-1"></a>plt.title( <span class="st">&#39;Empirical wage distribution from the US survey data&#39;</span> )</span>
<span id="cb12-4"><a href="machine-learning-for-wage-prediction.html#cb12-4" aria-hidden="true" tabindex="-1"></a>plt.ylim((<span class="dv">0</span>, <span class="dv">3000</span>))</span></code></pre></div>
<pre><code>## (0.0, 3000.0)</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="machine-learning-for-wage-prediction.html#cb14-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
<p>Wages show a high degree of skewness. Hence, wages are transformed in almost all studies by the logarithm.</p>
</div>
<div id="analysis" class="section level2" number="8.2">
<h2><span class="header-section-number">8.2</span> Analysis</h2>
<p>Due to the skewness of the data, we are considering log wages which leads to the following regression model</p>
<p><span class="math display">\[log(wage) = g(Z) + \epsilon.\]</span></p>
<p>We will estimate the two sets of prediction rules: Linear and Nonlinear Models.
In linear models, we estimate the prediction rule of the form</p>
<p><span class="math display">\[\hat g(Z) = \hat \beta&#39;X.\]</span>
Again, we generate <span class="math inline">\(X\)</span> in two ways:</p>
<ol style="list-style-type: decimal">
<li><p>Basic Model: <span class="math inline">\(X\)</span> consists of a set of raw regressors (e.g. gender, experience, education indicators, regional indicators).</p></li>
<li><p>Flexible Model: <span class="math inline">\(X\)</span> consists of all raw regressors from the basic model plus occupation and industry indicators, transformations (e.g., <span class="math inline">\({exp}^2\)</span> and <span class="math inline">\({exp}^3\)</span>) and additional two-way interactions.</p></li>
</ol>
<p>To evaluate the out-of-sample performance, we split the data first.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="machine-learning-for-wage-prediction.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb15-2"><a href="machine-learning-for-wage-prediction.html#cb15-2" aria-hidden="true" tabindex="-1"></a>training   <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fu">nrow</span>(data)<span class="sc">*</span>(<span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-3"><a href="machine-learning-for-wage-prediction.html#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="machine-learning-for-wage-prediction.html#cb15-4" aria-hidden="true" tabindex="-1"></a>data_train <span class="ot">&lt;-</span> data[training,]</span>
<span id="cb15-5"><a href="machine-learning-for-wage-prediction.html#cb15-5" aria-hidden="true" tabindex="-1"></a>data_test  <span class="ot">&lt;-</span> data[<span class="sc">-</span>training,]</span>
<span id="cb15-6"><a href="machine-learning-for-wage-prediction.html#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="machine-learning-for-wage-prediction.html#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking dimensions</span></span>
<span id="cb15-8"><a href="machine-learning-for-wage-prediction.html#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data_test)</span></code></pre></div>
<pre><code>## [1] 1288   20</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="machine-learning-for-wage-prediction.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data_train)</span></code></pre></div>
<pre><code>## [1] 3862   20</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="machine-learning-for-wage-prediction.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting parameters to split the data </span></span>
<span id="cb19-2"><a href="machine-learning-for-wage-prediction.html#cb19-2" aria-hidden="true" tabindex="-1"></a>nrow   <span class="op">=</span> data.shape[<span class="dv">0</span>]</span>
<span id="cb19-3"><a href="machine-learning-for-wage-prediction.html#cb19-3" aria-hidden="true" tabindex="-1"></a>length <span class="op">=</span> <span class="bu">int</span>(nrow<span class="op">*</span>(<span class="dv">3</span><span class="op">/</span><span class="dv">4</span>))</span>
<span id="cb19-4"><a href="machine-learning-for-wage-prediction.html#cb19-4" aria-hidden="true" tabindex="-1"></a>data   <span class="op">=</span> data.reset_index().drop( <span class="st">&#39;rownames&#39;</span>, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb19-5"><a href="machine-learning-for-wage-prediction.html#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="machine-learning-for-wage-prediction.html#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the data</span></span>
<span id="cb19-7"><a href="machine-learning-for-wage-prediction.html#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> default_rng</span>
<span id="cb19-8"><a href="machine-learning-for-wage-prediction.html#cb19-8" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">30</span>)</span>
<span id="cb19-9"><a href="machine-learning-for-wage-prediction.html#cb19-9" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> default_rng()</span>
<span id="cb19-10"><a href="machine-learning-for-wage-prediction.html#cb19-10" aria-hidden="true" tabindex="-1"></a>training <span class="op">=</span> rng.choice(nrow, size <span class="op">=</span> length, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-11"><a href="machine-learning-for-wage-prediction.html#cb19-11" aria-hidden="true" tabindex="-1"></a>training_bool <span class="op">=</span> data.index.isin( training )</span>
<span id="cb19-12"><a href="machine-learning-for-wage-prediction.html#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="machine-learning-for-wage-prediction.html#cb19-13" aria-hidden="true" tabindex="-1"></a>data_train <span class="op">=</span> data.iloc[training,:]</span>
<span id="cb19-14"><a href="machine-learning-for-wage-prediction.html#cb19-14" aria-hidden="true" tabindex="-1"></a>data_test  <span class="op">=</span> data[<span class="op">~</span>training_bool]</span>
<span id="cb19-15"><a href="machine-learning-for-wage-prediction.html#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="machine-learning-for-wage-prediction.html#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking dimensions</span></span>
<span id="cb19-17"><a href="machine-learning-for-wage-prediction.html#cb19-17" aria-hidden="true" tabindex="-1"></a>data_test.shape</span></code></pre></div>
<pre><code>## (1288, 20)</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="machine-learning-for-wage-prediction.html#cb21-1" aria-hidden="true" tabindex="-1"></a>data_train.shape</span></code></pre></div>
<pre><code>## (3862, 20)</code></pre>
</div>
</div>
<p>We construct the two different model matrices <span class="math inline">\(X_{basic}\)</span> and <span class="math inline">\(X_{flex}\)</span> for both the training and the test sample:</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="machine-learning-for-wage-prediction.html#cb23-1" aria-hidden="true" tabindex="-1"></a>X_basic <span class="ot">&lt;-</span>  <span class="st">&quot;sex + exp1 + exp2+ shs + hsg+ scl + clg + mw + so + we + occ2+ ind2&quot;</span></span>
<span id="cb23-2"><a href="machine-learning-for-wage-prediction.html#cb23-2" aria-hidden="true" tabindex="-1"></a>X_flex  <span class="ot">&lt;-</span> <span class="st">&quot;sex + exp1 + exp2 + shs+hsg+scl+clg+occ2+ind2+mw+so+we + (exp1+exp2+exp3+exp4)*(shs+hsg+scl+clg+occ2+ind2+mw+so+we)&quot;</span></span>
<span id="cb23-3"><a href="machine-learning-for-wage-prediction.html#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="machine-learning-for-wage-prediction.html#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Formulas</span></span>
<span id="cb23-5"><a href="machine-learning-for-wage-prediction.html#cb23-5" aria-hidden="true" tabindex="-1"></a>formula_basic <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">&quot;lwage&quot;</span>, <span class="st">&quot;~&quot;</span>, X_basic))</span>
<span id="cb23-6"><a href="machine-learning-for-wage-prediction.html#cb23-6" aria-hidden="true" tabindex="-1"></a>formula_flex <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">&quot;lwage&quot;</span>, <span class="st">&quot;~&quot;</span>, X_flex))</span>
<span id="cb23-7"><a href="machine-learning-for-wage-prediction.html#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="machine-learning-for-wage-prediction.html#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Models</span></span>
<span id="cb23-9"><a href="machine-learning-for-wage-prediction.html#cb23-9" aria-hidden="true" tabindex="-1"></a>model_X_basic_train <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(formula_basic,data_train)</span>
<span id="cb23-10"><a href="machine-learning-for-wage-prediction.html#cb23-10" aria-hidden="true" tabindex="-1"></a>model_X_basic_test  <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(formula_basic,data_test)</span>
<span id="cb23-11"><a href="machine-learning-for-wage-prediction.html#cb23-11" aria-hidden="true" tabindex="-1"></a>p_basic <span class="ot">&lt;-</span> <span class="fu">dim</span>(model_X_basic_train)[<span class="dv">2</span>] <span class="co"># regressors</span></span>
<span id="cb23-12"><a href="machine-learning-for-wage-prediction.html#cb23-12" aria-hidden="true" tabindex="-1"></a>model_X_flex_train <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(formula_flex,data_train)</span>
<span id="cb23-13"><a href="machine-learning-for-wage-prediction.html#cb23-13" aria-hidden="true" tabindex="-1"></a>model_X_flex_test <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(formula_flex,data_test)</span>
<span id="cb23-14"><a href="machine-learning-for-wage-prediction.html#cb23-14" aria-hidden="true" tabindex="-1"></a>p_flex <span class="ot">&lt;-</span> <span class="fu">dim</span>(model_X_flex_train)[<span class="dv">2</span>] <span class="co"># regressors</span></span>
<span id="cb23-15"><a href="machine-learning-for-wage-prediction.html#cb23-15" aria-hidden="true" tabindex="-1"></a>Y_train <span class="ot">&lt;-</span> data_train<span class="sc">$</span>lwage</span>
<span id="cb23-16"><a href="machine-learning-for-wage-prediction.html#cb23-16" aria-hidden="true" tabindex="-1"></a>Y_test <span class="ot">&lt;-</span> data_test<span class="sc">$</span>lwage</span>
<span id="cb23-17"><a href="machine-learning-for-wage-prediction.html#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="machine-learning-for-wage-prediction.html#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions</span></span>
<span id="cb23-19"><a href="machine-learning-for-wage-prediction.html#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(model_X_basic_train)</span></code></pre></div>
<pre><code>## [1] 3862   52</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="machine-learning-for-wage-prediction.html#cb25-1" aria-hidden="true" tabindex="-1"></a>p_basic</span></code></pre></div>
<pre><code>## [1] 52</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="machine-learning-for-wage-prediction.html#cb27-1" aria-hidden="true" tabindex="-1"></a>p_flex</span></code></pre></div>
<pre><code>## [1] 246</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="machine-learning-for-wage-prediction.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Importing relevant libraries </span></span>
<span id="cb29-2"><a href="machine-learning-for-wage-prediction.html#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb29-3"><a href="machine-learning-for-wage-prediction.html#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb29-4"><a href="machine-learning-for-wage-prediction.html#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> patsy</span>
<span id="cb29-5"><a href="machine-learning-for-wage-prediction.html#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="machine-learning-for-wage-prediction.html#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Formulas</span></span>
<span id="cb29-7"><a href="machine-learning-for-wage-prediction.html#cb29-7" aria-hidden="true" tabindex="-1"></a>formula_basic <span class="op">=</span>  <span class="st">&quot;lwage ~ sex + exp1 + exp2+ shs + hsg+ scl + clg + mw + so + we + occ2+ ind2&quot;</span></span>
<span id="cb29-8"><a href="machine-learning-for-wage-prediction.html#cb29-8" aria-hidden="true" tabindex="-1"></a>formula_flex  <span class="op">=</span> <span class="st">&quot;lwage ~ sex + exp1 + exp2 + shs+hsg+scl+clg+occ2+ind2+mw+so+we + (exp1+exp2+exp3+exp4)*(shs+hsg+scl+clg+occ2+ind2+mw+so+we)&quot;</span></span>
<span id="cb29-9"><a href="machine-learning-for-wage-prediction.html#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="machine-learning-for-wage-prediction.html#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Models</span></span>
<span id="cb29-11"><a href="machine-learning-for-wage-prediction.html#cb29-11" aria-hidden="true" tabindex="-1"></a>y_basic_train, model_X_basic_train <span class="op">=</span> patsy.dmatrices(formula_basic, data_train, return_type<span class="op">=</span><span class="st">&#39;dataframe&#39;</span>)</span>
<span id="cb29-12"><a href="machine-learning-for-wage-prediction.html#cb29-12" aria-hidden="true" tabindex="-1"></a>y_basic_test , model_X_basic_test   <span class="op">=</span> patsy.dmatrices(formula_basic, data_test, return_type<span class="op">=</span><span class="st">&#39;dataframe&#39;</span>)</span>
<span id="cb29-13"><a href="machine-learning-for-wage-prediction.html#cb29-13" aria-hidden="true" tabindex="-1"></a>p_basic <span class="op">=</span> model_X_basic_train.shape[ <span class="dv">1</span> ] <span class="co"># regressors</span></span>
<span id="cb29-14"><a href="machine-learning-for-wage-prediction.html#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="machine-learning-for-wage-prediction.html#cb29-15" aria-hidden="true" tabindex="-1"></a>y_flex_train, model_X_flex_train <span class="op">=</span> patsy.dmatrices(formula_flex, data_train, return_type<span class="op">=</span><span class="st">&#39;dataframe&#39;</span>)</span>
<span id="cb29-16"><a href="machine-learning-for-wage-prediction.html#cb29-16" aria-hidden="true" tabindex="-1"></a>y_flex_test , model_X_flex_test  <span class="op">=</span> patsy.dmatrices(formula_flex, data_test,  return_type<span class="op">=</span><span class="st">&#39;dataframe&#39;</span>)</span>
<span id="cb29-17"><a href="machine-learning-for-wage-prediction.html#cb29-17" aria-hidden="true" tabindex="-1"></a>p_flex <span class="op">=</span> model_X_flex_train.shape[ <span class="dv">1</span> ] <span class="co"># regressors</span></span>
<span id="cb29-18"><a href="machine-learning-for-wage-prediction.html#cb29-18" aria-hidden="true" tabindex="-1"></a>Y_train <span class="op">=</span> data_train[<span class="st">&#39;lwage&#39;</span>]</span>
<span id="cb29-19"><a href="machine-learning-for-wage-prediction.html#cb29-19" aria-hidden="true" tabindex="-1"></a>Y_test  <span class="op">=</span> data_test[<span class="st">&#39;lwage&#39;</span>]</span>
<span id="cb29-20"><a href="machine-learning-for-wage-prediction.html#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="machine-learning-for-wage-prediction.html#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensions</span></span>
<span id="cb29-22"><a href="machine-learning-for-wage-prediction.html#cb29-22" aria-hidden="true" tabindex="-1"></a>model_X_basic_train.shape</span></code></pre></div>
<pre><code>## (3862, 52)</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="machine-learning-for-wage-prediction.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(p_basic)</span></code></pre></div>
<pre><code>## 52</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="machine-learning-for-wage-prediction.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(p_flex)</span></code></pre></div>
<pre><code>## 246</code></pre>
</div>
</div>
<p>As known from our first lab, the basic model consists of <span class="math inline">\(10\)</span> regressors and the flexible model of <span class="math inline">\(246\)</span> regressors. Let us fit our models to the training sample using the two different model specifications. We are starting by running a simple ols regression.</p>
</div>
<div id="ols-1" class="section level2" number="8.3">
<h2><span class="header-section-number">8.3</span> OLS</h2>
<p>We fit the basic model to our training data by running an ols regression and compute the mean squared error on the test sample.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="machine-learning-for-wage-prediction.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS (basic model)</span></span>
<span id="cb35-2"><a href="machine-learning-for-wage-prediction.html#cb35-2" aria-hidden="true" tabindex="-1"></a>fit.lm.basic <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula_basic, data_train)</span>
<span id="cb35-3"><a href="machine-learning-for-wage-prediction.html#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="machine-learning-for-wage-prediction.html#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute out-of-sample performance</span></span>
<span id="cb35-5"><a href="machine-learning-for-wage-prediction.html#cb35-5" aria-hidden="true" tabindex="-1"></a>yhat.lm.basic <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.lm.basic, <span class="at">newdata=</span>data_test)</span>
<span id="cb35-6"><a href="machine-learning-for-wage-prediction.html#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The mean squared error (MSE) using the basic model is equal to&quot;</span> , <span class="fu">mean</span>((Y_test<span class="sc">-</span>yhat.lm.basic)<span class="sc">^</span><span class="dv">2</span>)) <span class="co"># MSE OLS (basic model)</span></span></code></pre></div>
<pre><code>## The mean squared error (MSE) using the basic model is equal to 0.2293541</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="machine-learning-for-wage-prediction.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS (basic model)</span></span>
<span id="cb37-2"><a href="machine-learning-for-wage-prediction.html#cb37-2" aria-hidden="true" tabindex="-1"></a>lm_basic <span class="op">=</span> sm.OLS( Y_train, model_X_basic_train )</span>
<span id="cb37-3"><a href="machine-learning-for-wage-prediction.html#cb37-3" aria-hidden="true" tabindex="-1"></a>fit_lm_basic <span class="op">=</span> lm_basic.fit()</span>
<span id="cb37-4"><a href="machine-learning-for-wage-prediction.html#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="machine-learning-for-wage-prediction.html#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute out-of-sample performance</span></span>
<span id="cb37-6"><a href="machine-learning-for-wage-prediction.html#cb37-6" aria-hidden="true" tabindex="-1"></a>yhat_lm_basic <span class="op">=</span> fit_lm_basic.predict( model_X_basic_test )</span>
<span id="cb37-7"><a href="machine-learning-for-wage-prediction.html#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="ss">f&quot;The mean squared error (MSE) using the basic model is equal to , </span><span class="sc">{np.</span>mean((Y_test<span class="op">-</span>yhat_lm_basic)<span class="op">**</span><span class="dv">2</span>)<span class="sc">}</span><span class="ss"> &quot;</span>) <span class="co"># MSE OLS (basic model)    </span></span></code></pre></div>
<pre><code>## The mean squared error (MSE) using the basic model is equal to , 0.22818615112815013</code></pre>
</div>
</div>
<p>To determine the out-of-sample <span class="math inline">\(MSE\)</span> and the standard error in one step, we can use the function <em>lm</em>:</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="machine-learning-for-wage-prediction.html#cb39-1" aria-hidden="true" tabindex="-1"></a>MSE.lm.basic <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.lm.basic)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb39-2"><a href="machine-learning-for-wage-prediction.html#cb39-2" aria-hidden="true" tabindex="-1"></a>MSE.lm.basic</span></code></pre></div>
<pre><code>## [1] 0.22935406 0.01564666</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="machine-learning-for-wage-prediction.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS (basic model)</span></span>
<span id="cb41-2"><a href="machine-learning-for-wage-prediction.html#cb41-2" aria-hidden="true" tabindex="-1"></a>resid_basic <span class="op">=</span> (Y_test<span class="op">-</span>yhat_lm_basic)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb41-3"><a href="machine-learning-for-wage-prediction.html#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="machine-learning-for-wage-prediction.html#cb41-4" aria-hidden="true" tabindex="-1"></a>MSE_lm_basic <span class="op">=</span> sm.OLS( resid_basic , np.ones( resid_basic.shape[<span class="dv">0</span>] ) ).fit().summary2().tables[<span class="dv">1</span>].iloc[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">2</span>]</span>
<span id="cb41-5"><a href="machine-learning-for-wage-prediction.html#cb41-5" aria-hidden="true" tabindex="-1"></a>MSE_lm_basic</span></code></pre></div>
<pre><code>## Coef.       0.228186
## Std.Err.    0.015958
## Name: const, dtype: float64</code></pre>
</div>
</div>
<p>We also compute the out-of-sample <span class="math inline">\(R^2\)</span>:</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="machine-learning-for-wage-prediction.html#cb43-1" aria-hidden="true" tabindex="-1"></a>R2.lm.basic <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> MSE.lm.basic[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb43-2"><a href="machine-learning-for-wage-prediction.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The R^2 using the basic model is equal to&quot;</span>,R2.lm.basic) <span class="co"># MSE OLS (basic model) </span></span></code></pre></div>
<pre><code>## The R^2 using the basic model is equal to 0.2819899</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="machine-learning-for-wage-prediction.html#cb45-1" aria-hidden="true" tabindex="-1"></a>R2_lm_basic <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ( MSE_lm_basic[<span class="dv">0</span>]<span class="op">/</span>Y_test.var() )</span>
<span id="cb45-2"><a href="machine-learning-for-wage-prediction.html#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="ss">f&quot;The R^2 using the basic model is equal to, </span><span class="sc">{</span>R2_lm_basic<span class="sc">}</span><span class="ss">&quot;</span> ) <span class="co"># MSE OLS (basic model) </span></span></code></pre></div>
<pre><code>## The R^2 using the basic model is equal to, 0.28398713111832197</code></pre>
</div>
</div>
<p>We repeat the same procedure for the flexible model.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="machine-learning-for-wage-prediction.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS (flexible model)</span></span>
<span id="cb47-2"><a href="machine-learning-for-wage-prediction.html#cb47-2" aria-hidden="true" tabindex="-1"></a>fit.lm.flex <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula_flex, data_train)</span>
<span id="cb47-3"><a href="machine-learning-for-wage-prediction.html#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="machine-learning-for-wage-prediction.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the out-of-sample performance</span></span>
<span id="cb47-5"><a href="machine-learning-for-wage-prediction.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">warn=</span><span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb47-6"><a href="machine-learning-for-wage-prediction.html#cb47-6" aria-hidden="true" tabindex="-1"></a>yhat.lm.flex <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.lm.flex, <span class="at">newdata=</span>data_test)</span>
<span id="cb47-7"><a href="machine-learning-for-wage-prediction.html#cb47-7" aria-hidden="true" tabindex="-1"></a>MSE.lm.flex  <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.lm.flex)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb47-8"><a href="machine-learning-for-wage-prediction.html#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="machine-learning-for-wage-prediction.html#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co"># MSE and R squared</span></span>
<span id="cb47-10"><a href="machine-learning-for-wage-prediction.html#cb47-10" aria-hidden="true" tabindex="-1"></a>R2.lm.flex   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> MSE.lm.flex[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb47-11"><a href="machine-learning-for-wage-prediction.html#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The R^2 using the flexible model is equal to&quot;</span>,R2.lm.flex) <span class="co"># MSE OLS (flexible model) </span></span></code></pre></div>
<pre><code>## The R^2 using the flexible model is equal to 0.2383204</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="machine-learning-for-wage-prediction.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS (flex model)</span></span>
<span id="cb49-2"><a href="machine-learning-for-wage-prediction.html#cb49-2" aria-hidden="true" tabindex="-1"></a>lm_flex <span class="op">=</span> sm.OLS( Y_train, model_X_flex_train )</span>
<span id="cb49-3"><a href="machine-learning-for-wage-prediction.html#cb49-3" aria-hidden="true" tabindex="-1"></a>fit_lm_flex <span class="op">=</span> lm_flex.fit()</span>
<span id="cb49-4"><a href="machine-learning-for-wage-prediction.html#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="machine-learning-for-wage-prediction.html#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the out-of-sample performance</span></span>
<span id="cb49-6"><a href="machine-learning-for-wage-prediction.html#cb49-6" aria-hidden="true" tabindex="-1"></a>yhat_lm_flex <span class="op">=</span> fit_lm_flex.predict( model_X_flex_test )</span>
<span id="cb49-7"><a href="machine-learning-for-wage-prediction.html#cb49-7" aria-hidden="true" tabindex="-1"></a>resid_flex <span class="op">=</span> (Y_test<span class="op">-</span>yhat_lm_flex)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb49-8"><a href="machine-learning-for-wage-prediction.html#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="machine-learning-for-wage-prediction.html#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co"># MSE and R squared</span></span>
<span id="cb49-10"><a href="machine-learning-for-wage-prediction.html#cb49-10" aria-hidden="true" tabindex="-1"></a>MSE_lm_flex <span class="op">=</span> sm.OLS( resid_flex , np.ones( resid_flex.shape[<span class="dv">0</span>] ) ).fit().summary2().tables[<span class="dv">1</span>].iloc[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">2</span>]</span>
<span id="cb49-11"><a href="machine-learning-for-wage-prediction.html#cb49-11" aria-hidden="true" tabindex="-1"></a>MSE_lm_flex</span></code></pre></div>
<pre><code>## Coef.       0.247651
## Std.Err.    0.016709
## Name: const, dtype: float64</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="machine-learning-for-wage-prediction.html#cb51-1" aria-hidden="true" tabindex="-1"></a>R2_lm_flex <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ( MSE_lm_flex[<span class="dv">0</span>]<span class="op">/</span>Y_test.var() )</span>
<span id="cb51-2"><a href="machine-learning-for-wage-prediction.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="ss">f&quot;The R^2 using the flex model is equal to, </span><span class="sc">{</span>R2_lm_flex<span class="sc">}</span><span class="ss">&quot;</span> ) <span class="co"># MSE OLS (flex model) </span></span></code></pre></div>
<pre><code>## The R^2 using the flex model is equal to, 0.22290844960856848</code></pre>
</div>
</div>
<p>We observe that ols regression works better for the basic model with smaller <span class="math inline">\(p/n\)</span> ratio. We are proceeding by running lasso regressions and its versions.</p>
</div>
<div id="lasso-ridge-and-elastic-net" class="section level2" number="8.4">
<h2><span class="header-section-number">8.4</span> Lasso, Ridge and Elastic Net</h2>
<p>Considering the basic model, we run a lasso/post-lasso regression first and then we compute the measures for the out-of-sample performance. Note that applying the package <em>hdm</em> and the function <em>rlasso</em> we rely on a theoretical based choice of the penalty level <span class="math inline">\(\lambda\)</span> in the lasso regression.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="machine-learning-for-wage-prediction.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lasso and versions</span></span>
<span id="cb53-2"><a href="machine-learning-for-wage-prediction.html#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hdm) </span>
<span id="cb53-3"><a href="machine-learning-for-wage-prediction.html#cb53-3" aria-hidden="true" tabindex="-1"></a>fit.rlasso      <span class="ot">&lt;-</span> <span class="fu">rlasso</span>(formula_basic, data_train, <span class="at">post=</span><span class="cn">FALSE</span>)</span>
<span id="cb53-4"><a href="machine-learning-for-wage-prediction.html#cb53-4" aria-hidden="true" tabindex="-1"></a>fit.rlasso.post <span class="ot">&lt;-</span> <span class="fu">rlasso</span>(formula_basic, data_train, <span class="at">post=</span><span class="cn">TRUE</span>)</span></code></pre></div>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="machine-learning-for-wage-prediction.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb54-2"><a href="machine-learning-for-wage-prediction.html#cb54-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>)</span>
<span id="cb54-3"><a href="machine-learning-for-wage-prediction.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hdmpy</span>
<span id="cb54-4"><a href="machine-learning-for-wage-prediction.html#cb54-4" aria-hidden="true" tabindex="-1"></a>fit_rlasso <span class="op">=</span> hdmpy.rlasso( model_X_basic_train.to_numpy() , Y_train.to_numpy().reshape( Y_train.size , <span class="dv">1</span> ) , post <span class="op">=</span> <span class="va">False</span> )</span>
<span id="cb54-5"><a href="machine-learning-for-wage-prediction.html#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="machine-learning-for-wage-prediction.html#cb54-6" aria-hidden="true" tabindex="-1"></a>fit_rlasso_post <span class="op">=</span> hdmpy.rlasso( model_X_basic_train.to_numpy() , Y_train.to_numpy().reshape( Y_train.size , <span class="dv">1</span> ) , post <span class="op">=</span> <span class="va">True</span> )</span></code></pre></div>
</div>
</div>
<p><strong>Estimating the predictions from rlasso models</strong></p>
<p>We have to know that the residuals output come from this formula:</p>
<ol>
<li>
<code>x1 = x - np.ones( (x.shape[1] , 1) ) @ x.mean( axis = 0 )</code>
</li>
<li>
<code>beta = model.est[‘beta’].loc[ fit_rlasso.est[‘index’].iloc[:, 0].to_list(), ].to_numpy()</code>
</li>
<li>
<code>y1 = y - y.mean()</code>
</li>
<li>
<code>yhat = x1 @ beta + y.mean()</code>
</li>
</ol>
<p>So we have to apply those transformations to original test data</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="machine-learning-for-wage-prediction.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lasso and versions</span></span>
<span id="cb55-2"><a href="machine-learning-for-wage-prediction.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hdm) </span>
<span id="cb55-3"><a href="machine-learning-for-wage-prediction.html#cb55-3" aria-hidden="true" tabindex="-1"></a>yhat.rlasso   <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.rlasso, <span class="at">newdata=</span>data_test)</span>
<span id="cb55-4"><a href="machine-learning-for-wage-prediction.html#cb55-4" aria-hidden="true" tabindex="-1"></a>yhat.rlasso.post   <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.rlasso.post, <span class="at">newdata=</span>data_test)</span>
<span id="cb55-5"><a href="machine-learning-for-wage-prediction.html#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="machine-learning-for-wage-prediction.html#cb55-6" aria-hidden="true" tabindex="-1"></a>MSE.lasso <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.rlasso)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb55-7"><a href="machine-learning-for-wage-prediction.html#cb55-7" aria-hidden="true" tabindex="-1"></a>MSE.lasso.post <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.rlasso.post)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb55-8"><a href="machine-learning-for-wage-prediction.html#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="machine-learning-for-wage-prediction.html#cb55-9" aria-hidden="true" tabindex="-1"></a>R2.lasso <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.lasso[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb55-10"><a href="machine-learning-for-wage-prediction.html#cb55-10" aria-hidden="true" tabindex="-1"></a>R2.lasso.post <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.lasso.post[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb55-11"><a href="machine-learning-for-wage-prediction.html#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The R^2 using the basic model is equal to&quot;</span>,R2.lasso,<span class="st">&quot;for lasso and&quot;</span>,R2.lasso.post,<span class="st">&quot;for post-lasso&quot;</span>) <span class="co"># R^2 lasso/post-lasso (basic model) </span></span></code></pre></div>
<pre><code>## The R^2 using the basic model is equal to 0.2674345 for lasso and 0.2706874 for post-lasso</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="machine-learning-for-wage-prediction.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting mean of each variable</span></span>
<span id="cb57-2"><a href="machine-learning-for-wage-prediction.html#cb57-2" aria-hidden="true" tabindex="-1"></a>meanx <span class="op">=</span> model_X_basic_test.mean( axis <span class="op">=</span> <span class="dv">0</span> ).values.<span class="op">\</span></span>
<span id="cb57-3"><a href="machine-learning-for-wage-prediction.html#cb57-3" aria-hidden="true" tabindex="-1"></a>                        reshape( model_X_basic_test.shape[ <span class="dv">1</span> ] , <span class="dv">1</span> )</span>
<span id="cb57-4"><a href="machine-learning-for-wage-prediction.html#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="machine-learning-for-wage-prediction.html#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reducing the mean</span></span>
<span id="cb57-6"><a href="machine-learning-for-wage-prediction.html#cb57-6" aria-hidden="true" tabindex="-1"></a>new_x1 <span class="op">=</span> model_X_basic_test.to_numpy() <span class="op">-</span> <span class="op">\</span></span>
<span id="cb57-7"><a href="machine-learning-for-wage-prediction.html#cb57-7" aria-hidden="true" tabindex="-1"></a>                    (np.ones( ( model_X_basic_test.shape[ <span class="dv">0</span> ] , <span class="dv">1</span> ) ) <span class="op">@</span> meanx.T)</span>
<span id="cb57-8"><a href="machine-learning-for-wage-prediction.html#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="machine-learning-for-wage-prediction.html#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the significant variables</span></span>
<span id="cb57-10"><a href="machine-learning-for-wage-prediction.html#cb57-10" aria-hidden="true" tabindex="-1"></a>x1_est_rlasso <span class="op">=</span> new_x1[ :, fit_rlasso.est[<span class="st">&#39;index&#39;</span>].iloc[:, <span class="dv">0</span>].to_list()]</span>
<span id="cb57-11"><a href="machine-learning-for-wage-prediction.html#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="machine-learning-for-wage-prediction.html#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the coef. from significant variables</span></span>
<span id="cb57-13"><a href="machine-learning-for-wage-prediction.html#cb57-13" aria-hidden="true" tabindex="-1"></a>beta_rlasso <span class="op">=</span> fit_rlasso.est[<span class="st">&#39;beta&#39;</span>].loc[ fit_rlasso.est[<span class="st">&#39;index&#39;</span>].<span class="op">\</span></span>
<span id="cb57-14"><a href="machine-learning-for-wage-prediction.html#cb57-14" aria-hidden="true" tabindex="-1"></a>                                     iloc[:, <span class="dv">0</span>].to_list(), ].to_numpy()</span>
<span id="cb57-15"><a href="machine-learning-for-wage-prediction.html#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="machine-learning-for-wage-prediction.html#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="co"># yhat</span></span>
<span id="cb57-17"><a href="machine-learning-for-wage-prediction.html#cb57-17" aria-hidden="true" tabindex="-1"></a>yhat_rlasso <span class="op">=</span> (x1_est_rlasso <span class="op">@</span> beta_rlasso) <span class="op">+</span> np.mean( Y_test.to_numpy() )</span>
<span id="cb57-18"><a href="machine-learning-for-wage-prediction.html#cb57-18" aria-hidden="true" tabindex="-1"></a>residuals_rlasso <span class="op">=</span> Y_test.to_numpy().reshape( Y_test.to_numpy().size, <span class="dv">1</span>)  <span class="op">-</span> yhat_rlasso</span>
<span id="cb57-19"><a href="machine-learning-for-wage-prediction.html#cb57-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-20"><a href="machine-learning-for-wage-prediction.html#cb57-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting mean of each variable</span></span>
<span id="cb57-21"><a href="machine-learning-for-wage-prediction.html#cb57-21" aria-hidden="true" tabindex="-1"></a>meanx <span class="op">=</span> model_X_basic_test.mean( axis <span class="op">=</span> <span class="dv">0</span> ).values.<span class="op">\</span></span>
<span id="cb57-22"><a href="machine-learning-for-wage-prediction.html#cb57-22" aria-hidden="true" tabindex="-1"></a>                        reshape( model_X_basic_test.shape[ <span class="dv">1</span> ] , <span class="dv">1</span> )</span>
<span id="cb57-23"><a href="machine-learning-for-wage-prediction.html#cb57-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-24"><a href="machine-learning-for-wage-prediction.html#cb57-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Reducing the mean</span></span>
<span id="cb57-25"><a href="machine-learning-for-wage-prediction.html#cb57-25" aria-hidden="true" tabindex="-1"></a>new_x1 <span class="op">=</span> model_X_basic_test.to_numpy() <span class="op">-</span> <span class="op">\</span></span>
<span id="cb57-26"><a href="machine-learning-for-wage-prediction.html#cb57-26" aria-hidden="true" tabindex="-1"></a>                    (np.ones( ( model_X_basic_test.shape[ <span class="dv">0</span> ] , <span class="dv">1</span> ) ) <span class="op">@</span> meanx.T)</span>
<span id="cb57-27"><a href="machine-learning-for-wage-prediction.html#cb57-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-28"><a href="machine-learning-for-wage-prediction.html#cb57-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the significant variables</span></span>
<span id="cb57-29"><a href="machine-learning-for-wage-prediction.html#cb57-29" aria-hidden="true" tabindex="-1"></a>x1_est_rlasso_post <span class="op">=</span> new_x1[ :, fit_rlasso_post.est[<span class="st">&#39;index&#39;</span>].iloc[:, <span class="dv">0</span>].to_list()]</span>
<span id="cb57-30"><a href="machine-learning-for-wage-prediction.html#cb57-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-31"><a href="machine-learning-for-wage-prediction.html#cb57-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the coef. from significant variables</span></span>
<span id="cb57-32"><a href="machine-learning-for-wage-prediction.html#cb57-32" aria-hidden="true" tabindex="-1"></a>beta_rlasso_post <span class="op">=</span> fit_rlasso_post.est[<span class="st">&#39;beta&#39;</span>].loc[ fit_rlasso_post.est[<span class="st">&#39;index&#39;</span>].<span class="op">\</span></span>
<span id="cb57-33"><a href="machine-learning-for-wage-prediction.html#cb57-33" aria-hidden="true" tabindex="-1"></a>                                     iloc[:, <span class="dv">0</span>].to_list(), ].to_numpy()</span>
<span id="cb57-34"><a href="machine-learning-for-wage-prediction.html#cb57-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-35"><a href="machine-learning-for-wage-prediction.html#cb57-35" aria-hidden="true" tabindex="-1"></a><span class="co"># yhat</span></span>
<span id="cb57-36"><a href="machine-learning-for-wage-prediction.html#cb57-36" aria-hidden="true" tabindex="-1"></a>yhat_rlasso_post <span class="op">=</span> (x1_est_rlasso_post <span class="op">@</span> beta_rlasso_post) <span class="op">+</span> np.mean( Y_test.to_numpy() )</span>
<span id="cb57-37"><a href="machine-learning-for-wage-prediction.html#cb57-37" aria-hidden="true" tabindex="-1"></a>residuals_rlasso_post <span class="op">=</span> Y_test.to_numpy().reshape( Y_test.to_numpy().size, <span class="dv">1</span>)  <span class="op">-</span> yhat_rlasso_post</span>
<span id="cb57-38"><a href="machine-learning-for-wage-prediction.html#cb57-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-39"><a href="machine-learning-for-wage-prediction.html#cb57-39" aria-hidden="true" tabindex="-1"></a>MSE_lasso <span class="op">=</span> sm.OLS( ( residuals_rlasso )<span class="op">**</span><span class="dv">2</span> , np.ones( yhat_rlasso.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb57-40"><a href="machine-learning-for-wage-prediction.html#cb57-40" aria-hidden="true" tabindex="-1"></a>MSE_lasso_post <span class="op">=</span> sm.OLS( ( residuals_rlasso_post )<span class="op">**</span><span class="dv">2</span>  , np.ones( yhat_rlasso_post.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb57-41"><a href="machine-learning-for-wage-prediction.html#cb57-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-42"><a href="machine-learning-for-wage-prediction.html#cb57-42" aria-hidden="true" tabindex="-1"></a>R2_lasso <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> MSE_lasso.iloc[<span class="dv">0</span>, <span class="dv">0</span>]<span class="op">/</span> np.var( Y_test )</span>
<span id="cb57-43"><a href="machine-learning-for-wage-prediction.html#cb57-43" aria-hidden="true" tabindex="-1"></a>R2_lasso_post <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> MSE_lasso_post.iloc[<span class="dv">0</span>, <span class="dv">0</span>]<span class="op">/</span> np.var( Y_test )</span>
<span id="cb57-44"><a href="machine-learning-for-wage-prediction.html#cb57-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-45"><a href="machine-learning-for-wage-prediction.html#cb57-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="ss">f&quot;The R^2 using the basic model is equal to </span><span class="sc">{</span>R2_lasso<span class="sc">}</span><span class="ss">,for lasso and </span><span class="sc">{</span>R2_lasso_post<span class="sc">}</span><span class="ss"> for post-lasso&quot;</span>) <span class="co"># R^2 lasso/post-lasso (basic model) </span></span></code></pre></div>
<pre><code>## The R^2 using the basic model is equal to 0.243191670035374,for lasso and 0.243191670035374 for post-lasso</code></pre>
</div>
</div>
<p>Now, we repeat the same procedure for the flexible model.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="machine-learning-for-wage-prediction.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lasso and versions</span></span>
<span id="cb59-2"><a href="machine-learning-for-wage-prediction.html#cb59-2" aria-hidden="true" tabindex="-1"></a>fit.rlasso.flex  <span class="ot">&lt;-</span> <span class="fu">rlasso</span>(formula_flex, data_train, <span class="at">post=</span><span class="cn">FALSE</span>)</span>
<span id="cb59-3"><a href="machine-learning-for-wage-prediction.html#cb59-3" aria-hidden="true" tabindex="-1"></a>fit.rlasso.post.flex <span class="ot">&lt;-</span> <span class="fu">rlasso</span>(formula_flex, data_train, <span class="at">post=</span><span class="cn">TRUE</span>)</span>
<span id="cb59-4"><a href="machine-learning-for-wage-prediction.html#cb59-4" aria-hidden="true" tabindex="-1"></a>yhat.rlasso.flex   <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.rlasso.flex, <span class="at">newdata=</span>data_test)</span>
<span id="cb59-5"><a href="machine-learning-for-wage-prediction.html#cb59-5" aria-hidden="true" tabindex="-1"></a>yhat.rlasso.post.flex   <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.rlasso.post.flex, <span class="at">newdata=</span>data_test)</span>
<span id="cb59-6"><a href="machine-learning-for-wage-prediction.html#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="machine-learning-for-wage-prediction.html#cb59-7" aria-hidden="true" tabindex="-1"></a>MSE.lasso.flex <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.rlasso.flex)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb59-8"><a href="machine-learning-for-wage-prediction.html#cb59-8" aria-hidden="true" tabindex="-1"></a>MSE.lasso.post.flex <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.rlasso.post.flex)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb59-9"><a href="machine-learning-for-wage-prediction.html#cb59-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-10"><a href="machine-learning-for-wage-prediction.html#cb59-10" aria-hidden="true" tabindex="-1"></a>R2.lasso.flex <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.lasso.flex[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb59-11"><a href="machine-learning-for-wage-prediction.html#cb59-11" aria-hidden="true" tabindex="-1"></a>R2.lasso.post.flex <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.lasso.post.flex[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb59-12"><a href="machine-learning-for-wage-prediction.html#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The R^2 using the flexible model is equal to&quot;</span>,R2.lasso.flex,<span class="st">&quot;for lasso and&quot;</span>,R2.lasso.post.flex,<span class="st">&quot;for post-lasso&quot;</span>) <span class="co"># R^2 lasso/post-lasso (flexible model) </span></span></code></pre></div>
<pre><code>## The R^2 using the flexible model is equal to 0.2653058 for lasso and 0.2614714 for post-lasso</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="machine-learning-for-wage-prediction.html#cb61-1" aria-hidden="true" tabindex="-1"></a>fit_rlasso_flex <span class="op">=</span> hdmpy.rlasso( model_X_flex_train.to_numpy() , Y_train.to_numpy().reshape( Y_train.size , <span class="dv">1</span> ) , post <span class="op">=</span> <span class="va">False</span> )</span>
<span id="cb61-2"><a href="machine-learning-for-wage-prediction.html#cb61-2" aria-hidden="true" tabindex="-1"></a>fit_rlasso_post_flex <span class="op">=</span> hdmpy.rlasso( model_X_flex_train.to_numpy() , Y_train.to_numpy().reshape( Y_train.size , <span class="dv">1</span> ) , post <span class="op">=</span> <span class="va">True</span> )</span>
<span id="cb61-3"><a href="machine-learning-for-wage-prediction.html#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="machine-learning-for-wage-prediction.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting mean of each variable</span></span>
<span id="cb61-5"><a href="machine-learning-for-wage-prediction.html#cb61-5" aria-hidden="true" tabindex="-1"></a>meanx <span class="op">=</span> model_X_flex_test.mean( axis <span class="op">=</span> <span class="dv">0</span> ).values.<span class="op">\</span></span>
<span id="cb61-6"><a href="machine-learning-for-wage-prediction.html#cb61-6" aria-hidden="true" tabindex="-1"></a>                        reshape( model_X_flex_test.shape[ <span class="dv">1</span> ] , <span class="dv">1</span> )</span>
<span id="cb61-7"><a href="machine-learning-for-wage-prediction.html#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="machine-learning-for-wage-prediction.html#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Reducing the mean</span></span>
<span id="cb61-9"><a href="machine-learning-for-wage-prediction.html#cb61-9" aria-hidden="true" tabindex="-1"></a>new_x1 <span class="op">=</span> model_X_flex_test.to_numpy() <span class="op">-</span> <span class="op">\</span></span>
<span id="cb61-10"><a href="machine-learning-for-wage-prediction.html#cb61-10" aria-hidden="true" tabindex="-1"></a>                    (np.ones( ( model_X_flex_test.shape[ <span class="dv">0</span> ] , <span class="dv">1</span> ) ) <span class="op">@</span> meanx.T)</span>
<span id="cb61-11"><a href="machine-learning-for-wage-prediction.html#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="machine-learning-for-wage-prediction.html#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the significant variables</span></span>
<span id="cb61-13"><a href="machine-learning-for-wage-prediction.html#cb61-13" aria-hidden="true" tabindex="-1"></a>x1_est_rlasso_flex <span class="op">=</span> new_x1[ :, fit_rlasso_flex.est[<span class="st">&#39;index&#39;</span>].iloc[:, <span class="dv">0</span>].to_list()]</span>
<span id="cb61-14"><a href="machine-learning-for-wage-prediction.html#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="machine-learning-for-wage-prediction.html#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the coef. from significant variables</span></span>
<span id="cb61-16"><a href="machine-learning-for-wage-prediction.html#cb61-16" aria-hidden="true" tabindex="-1"></a>beta_rlasso_flex <span class="op">=</span> fit_rlasso_flex.est[<span class="st">&#39;beta&#39;</span>].loc[ fit_rlasso_flex.est[<span class="st">&#39;index&#39;</span>].<span class="op">\</span></span>
<span id="cb61-17"><a href="machine-learning-for-wage-prediction.html#cb61-17" aria-hidden="true" tabindex="-1"></a>                                     iloc[:, <span class="dv">0</span>].to_list(), ].to_numpy()</span>
<span id="cb61-18"><a href="machine-learning-for-wage-prediction.html#cb61-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-19"><a href="machine-learning-for-wage-prediction.html#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="co"># yhat</span></span>
<span id="cb61-20"><a href="machine-learning-for-wage-prediction.html#cb61-20" aria-hidden="true" tabindex="-1"></a>yhat_rlasso_flex <span class="op">=</span> (x1_est_rlasso_flex <span class="op">@</span> beta_rlasso_flex) <span class="op">+</span> np.mean( Y_test.to_numpy() )</span>
<span id="cb61-21"><a href="machine-learning-for-wage-prediction.html#cb61-21" aria-hidden="true" tabindex="-1"></a>residuals_rlasso_flex <span class="op">=</span> Y_test.to_numpy().reshape( Y_test.to_numpy().size, <span class="dv">1</span>)  <span class="op">-</span> yhat_rlasso_flex</span>
<span id="cb61-22"><a href="machine-learning-for-wage-prediction.html#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="machine-learning-for-wage-prediction.html#cb61-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting mean of each variable</span></span>
<span id="cb61-24"><a href="machine-learning-for-wage-prediction.html#cb61-24" aria-hidden="true" tabindex="-1"></a>meanx <span class="op">=</span> model_X_flex_test.mean( axis <span class="op">=</span> <span class="dv">0</span> ).values.<span class="op">\</span></span>
<span id="cb61-25"><a href="machine-learning-for-wage-prediction.html#cb61-25" aria-hidden="true" tabindex="-1"></a>                        reshape( model_X_flex_test.shape[ <span class="dv">1</span> ] , <span class="dv">1</span> )</span>
<span id="cb61-26"><a href="machine-learning-for-wage-prediction.html#cb61-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-27"><a href="machine-learning-for-wage-prediction.html#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Reducing the mean</span></span>
<span id="cb61-28"><a href="machine-learning-for-wage-prediction.html#cb61-28" aria-hidden="true" tabindex="-1"></a>new_x1 <span class="op">=</span> model_X_flex_test.to_numpy() <span class="op">-</span> <span class="op">\</span></span>
<span id="cb61-29"><a href="machine-learning-for-wage-prediction.html#cb61-29" aria-hidden="true" tabindex="-1"></a>                    (np.ones( ( model_X_flex_test.shape[ <span class="dv">0</span> ] , <span class="dv">1</span> ) ) <span class="op">@</span> meanx.T)</span>
<span id="cb61-30"><a href="machine-learning-for-wage-prediction.html#cb61-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-31"><a href="machine-learning-for-wage-prediction.html#cb61-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the significant variables</span></span>
<span id="cb61-32"><a href="machine-learning-for-wage-prediction.html#cb61-32" aria-hidden="true" tabindex="-1"></a>x1_est_rlasso_post_flex <span class="op">=</span> new_x1[ :, fit_rlasso_post_flex.est[<span class="st">&#39;index&#39;</span>].iloc[:, <span class="dv">0</span>].to_list()]</span>
<span id="cb61-33"><a href="machine-learning-for-wage-prediction.html#cb61-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-34"><a href="machine-learning-for-wage-prediction.html#cb61-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the coef. from significant variables</span></span>
<span id="cb61-35"><a href="machine-learning-for-wage-prediction.html#cb61-35" aria-hidden="true" tabindex="-1"></a>beta_rlasso_post_flex <span class="op">=</span> fit_rlasso_post_flex.est[<span class="st">&#39;beta&#39;</span>].loc[ fit_rlasso_post_flex.est[<span class="st">&#39;index&#39;</span>].<span class="op">\</span></span>
<span id="cb61-36"><a href="machine-learning-for-wage-prediction.html#cb61-36" aria-hidden="true" tabindex="-1"></a>                                     iloc[:, <span class="dv">0</span>].to_list(), ].to_numpy()</span>
<span id="cb61-37"><a href="machine-learning-for-wage-prediction.html#cb61-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-38"><a href="machine-learning-for-wage-prediction.html#cb61-38" aria-hidden="true" tabindex="-1"></a><span class="co"># yhat</span></span>
<span id="cb61-39"><a href="machine-learning-for-wage-prediction.html#cb61-39" aria-hidden="true" tabindex="-1"></a>yhat_rlasso_post_flex <span class="op">=</span> (x1_est_rlasso_post_flex <span class="op">@</span> beta_rlasso_post_flex) <span class="op">+</span> np.mean( Y_test.to_numpy() )</span>
<span id="cb61-40"><a href="machine-learning-for-wage-prediction.html#cb61-40" aria-hidden="true" tabindex="-1"></a>residuals_rlasso_post_flex <span class="op">=</span> Y_test.to_numpy().reshape( Y_test.to_numpy().size, <span class="dv">1</span>)  <span class="op">-</span> yhat_rlasso_post_flex</span>
<span id="cb61-41"><a href="machine-learning-for-wage-prediction.html#cb61-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-42"><a href="machine-learning-for-wage-prediction.html#cb61-42" aria-hidden="true" tabindex="-1"></a>MSE_lasso_flex <span class="op">=</span> sm.OLS( ( residuals_rlasso_flex )<span class="op">**</span><span class="dv">2</span> , np.ones( yhat_rlasso_flex.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb61-43"><a href="machine-learning-for-wage-prediction.html#cb61-43" aria-hidden="true" tabindex="-1"></a>MSE_lasso_post_flex <span class="op">=</span> sm.OLS( ( residuals_rlasso_post_flex )<span class="op">**</span><span class="dv">2</span>  , np.ones( yhat_rlasso_post_flex.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb61-44"><a href="machine-learning-for-wage-prediction.html#cb61-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-45"><a href="machine-learning-for-wage-prediction.html#cb61-45" aria-hidden="true" tabindex="-1"></a>R2_lasso_flex <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> MSE_lasso.iloc[<span class="dv">0</span>, <span class="dv">0</span>]<span class="op">/</span> np.var( Y_test )</span>
<span id="cb61-46"><a href="machine-learning-for-wage-prediction.html#cb61-46" aria-hidden="true" tabindex="-1"></a>R2_lasso_post_flex <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> MSE_lasso_post_flex.iloc[<span class="dv">0</span>, <span class="dv">0</span>]<span class="op">/</span> np.var( Y_test )</span>
<span id="cb61-47"><a href="machine-learning-for-wage-prediction.html#cb61-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-48"><a href="machine-learning-for-wage-prediction.html#cb61-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="ss">f&quot;The R^2 using the basic model is equal to </span><span class="sc">{</span>R2_lasso_flex<span class="sc">}</span><span class="ss">,for lasso and </span><span class="sc">{</span>R2_lasso_post_flex<span class="sc">}</span><span class="ss"> for post-lasso&quot;</span>) <span class="co"># R^2 lasso/post-lasso (basic model) </span></span></code></pre></div>
<pre><code>## The R^2 using the basic model is equal to 0.243191670035374,for lasso and 0.23063053592807725 for post-lasso</code></pre>
</div>
</div>
<p>It is worth to notice that lasso regression works better for the more complex model.</p>
<p>In contrast to a theoretical based choice of the tuning parameter <span class="math inline">\(\lambda\)</span> in the lasso regression, we can also use cross-validation to determine the penalty level by applying the package <em>glmnet</em> and the function cv.glmnet. In this context, we also run a ridge and a elastic net regression by adjusting the parameter <em>alpha</em>.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="machine-learning-for-wage-prediction.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span></code></pre></div>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loaded glmnet 4.1-2</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="machine-learning-for-wage-prediction.html#cb66-1" aria-hidden="true" tabindex="-1"></a>fit.lasso.cv   <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(model_X_basic_train, Y_train, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb66-2"><a href="machine-learning-for-wage-prediction.html#cb66-2" aria-hidden="true" tabindex="-1"></a>fit.ridge      <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(model_X_basic_train, Y_train, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">alpha=</span><span class="dv">0</span>)</span>
<span id="cb66-3"><a href="machine-learning-for-wage-prediction.html#cb66-3" aria-hidden="true" tabindex="-1"></a>fit.elnet      <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(model_X_basic_train, Y_train, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">alpha=</span>.<span class="dv">5</span>)</span>
<span id="cb66-4"><a href="machine-learning-for-wage-prediction.html#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="machine-learning-for-wage-prediction.html#cb66-5" aria-hidden="true" tabindex="-1"></a>yhat.lasso.cv <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.lasso.cv, <span class="at">newx =</span> model_X_basic_test)</span>
<span id="cb66-6"><a href="machine-learning-for-wage-prediction.html#cb66-6" aria-hidden="true" tabindex="-1"></a>yhat.ridge    <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.ridge, <span class="at">newx =</span> model_X_basic_test)</span>
<span id="cb66-7"><a href="machine-learning-for-wage-prediction.html#cb66-7" aria-hidden="true" tabindex="-1"></a>yhat.elnet    <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.elnet, <span class="at">newx =</span> model_X_basic_test)</span>
<span id="cb66-8"><a href="machine-learning-for-wage-prediction.html#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="machine-learning-for-wage-prediction.html#cb66-9" aria-hidden="true" tabindex="-1"></a>MSE.lasso.cv <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.lasso.cv)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb66-10"><a href="machine-learning-for-wage-prediction.html#cb66-10" aria-hidden="true" tabindex="-1"></a>MSE.ridge    <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.ridge)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb66-11"><a href="machine-learning-for-wage-prediction.html#cb66-11" aria-hidden="true" tabindex="-1"></a>MSE.elnet    <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.elnet)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb66-12"><a href="machine-learning-for-wage-prediction.html#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="machine-learning-for-wage-prediction.html#cb66-13" aria-hidden="true" tabindex="-1"></a>R2.lasso.cv <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.lasso.cv[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb66-14"><a href="machine-learning-for-wage-prediction.html#cb66-14" aria-hidden="true" tabindex="-1"></a>R2.ridge    <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.ridge[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb66-15"><a href="machine-learning-for-wage-prediction.html#cb66-15" aria-hidden="true" tabindex="-1"></a>R2.elnet    <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.elnet[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb66-16"><a href="machine-learning-for-wage-prediction.html#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="machine-learning-for-wage-prediction.html#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co"># R^2 using cross-validation (basic model) </span></span>
<span id="cb66-18"><a href="machine-learning-for-wage-prediction.html#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;R^2 using cross-validation for lasso, ridge and elastic net in the basic model:&quot;</span>,R2.lasso.cv,R2.ridge,R2.elnet)</span></code></pre></div>
<pre><code>## R^2 using cross-validation for lasso, ridge and elastic net in the basic model: 0.2824847 0.2669501 0.28039</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="machine-learning-for-wage-prediction.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LassoCV</span>
<span id="cb68-2"><a href="machine-learning-for-wage-prediction.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb68-3"><a href="machine-learning-for-wage-prediction.html#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> RidgeCV, ElasticNetCV</span>
<span id="cb68-4"><a href="machine-learning-for-wage-prediction.html#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb68-5"><a href="machine-learning-for-wage-prediction.html#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="machine-learning-for-wage-prediction.html#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshaping Y variable</span></span>
<span id="cb68-7"><a href="machine-learning-for-wage-prediction.html#cb68-7" aria-hidden="true" tabindex="-1"></a>Y_vec <span class="op">=</span> Y_train.to_numpy().reshape( Y_train.to_numpy().size, <span class="dv">1</span>)</span>
<span id="cb68-8"><a href="machine-learning-for-wage-prediction.html#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="machine-learning-for-wage-prediction.html#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Scalar distribution</span></span>
<span id="cb68-10"><a href="machine-learning-for-wage-prediction.html#cb68-10" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb68-11"><a href="machine-learning-for-wage-prediction.html#cb68-11" aria-hidden="true" tabindex="-1"></a>scaler.fit( Y_vec )</span></code></pre></div>
<pre><code>## StandardScaler()</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="machine-learning-for-wage-prediction.html#cb70-1" aria-hidden="true" tabindex="-1"></a>std_Y <span class="op">=</span> scaler.transform( Y_vec )</span>
<span id="cb70-2"><a href="machine-learning-for-wage-prediction.html#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="machine-learning-for-wage-prediction.html#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Regressions</span></span>
<span id="cb70-4"><a href="machine-learning-for-wage-prediction.html#cb70-4" aria-hidden="true" tabindex="-1"></a>fit_lasso_cv_basic <span class="op">=</span> LassoCV(cv <span class="op">=</span> <span class="dv">10</span> , random_state <span class="op">=</span> <span class="dv">0</span> , normalize <span class="op">=</span> <span class="va">True</span> ).fit( model_X_basic_train, std_Y )</span>
<span id="cb70-5"><a href="machine-learning-for-wage-prediction.html#cb70-5" aria-hidden="true" tabindex="-1"></a>fit_ridge_basic <span class="op">=</span> ElasticNetCV( cv <span class="op">=</span> <span class="dv">10</span> , normalize <span class="op">=</span> <span class="va">True</span> , random_state <span class="op">=</span> <span class="dv">0</span> , l1_ratio <span class="op">=</span> <span class="fl">0.0001</span> ).fit( model_X_basic_train , std_Y )</span>
<span id="cb70-6"><a href="machine-learning-for-wage-prediction.html#cb70-6" aria-hidden="true" tabindex="-1"></a>fit_elnet_basic <span class="op">=</span> ElasticNetCV( cv <span class="op">=</span> <span class="dv">10</span> , normalize <span class="op">=</span> <span class="va">True</span> , random_state <span class="op">=</span> <span class="dv">0</span> , l1_ratio <span class="op">=</span> <span class="fl">0.5</span>, max_iter <span class="op">=</span> <span class="dv">100000</span> ).fit( model_X_basic_train , std_Y )</span>
<span id="cb70-7"><a href="machine-learning-for-wage-prediction.html#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="machine-learning-for-wage-prediction.html#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb70-9"><a href="machine-learning-for-wage-prediction.html#cb70-9" aria-hidden="true" tabindex="-1"></a>yhat_lasso_cv_basic <span class="op">=</span> scaler.inverse_transform( fit_lasso_cv_basic.predict( model_X_basic_test ) )</span>
<span id="cb70-10"><a href="machine-learning-for-wage-prediction.html#cb70-10" aria-hidden="true" tabindex="-1"></a>yhat_ridge_basic <span class="op">=</span> scaler.inverse_transform( fit_ridge_basic.predict( model_X_basic_test ) )</span>
<span id="cb70-11"><a href="machine-learning-for-wage-prediction.html#cb70-11" aria-hidden="true" tabindex="-1"></a>yhat_elnet_basic <span class="op">=</span> scaler.inverse_transform( fit_elnet_basic.predict( model_X_basic_test ) )</span>
<span id="cb70-12"><a href="machine-learning-for-wage-prediction.html#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="machine-learning-for-wage-prediction.html#cb70-13" aria-hidden="true" tabindex="-1"></a>MSE_lasso_cv_basic <span class="op">=</span> sm.OLS( ((Y_test <span class="op">-</span> yhat_lasso_cv_basic)<span class="op">**</span><span class="dv">2</span> ) , np.ones( yhat_lasso_cv_basic.shape )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb70-14"><a href="machine-learning-for-wage-prediction.html#cb70-14" aria-hidden="true" tabindex="-1"></a>MSE_ridge_basic <span class="op">=</span> sm.OLS( ((Y_test <span class="op">-</span> yhat_ridge_basic)<span class="op">**</span><span class="dv">2</span> ) , np.ones( yhat_ridge_basic.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb70-15"><a href="machine-learning-for-wage-prediction.html#cb70-15" aria-hidden="true" tabindex="-1"></a>MSE_elnet_basic <span class="op">=</span> sm.OLS( ((Y_test <span class="op">-</span> yhat_elnet_basic)<span class="op">**</span><span class="dv">2</span> ) , np.ones( yhat_elnet_basic.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb70-16"><a href="machine-learning-for-wage-prediction.html#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="co"># our coefficient of MSE_elnet are far from r output</span></span>
<span id="cb70-17"><a href="machine-learning-for-wage-prediction.html#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="machine-learning-for-wage-prediction.html#cb70-18" aria-hidden="true" tabindex="-1"></a>R2_lasso_cv_basic <span class="op">=</span> <span class="dv">1</span><span class="op">-</span> MSE_ridge_basic.iloc[<span class="dv">0</span>,<span class="dv">0</span>] <span class="op">/</span> np.var( Y_test )</span>
<span id="cb70-19"><a href="machine-learning-for-wage-prediction.html#cb70-19" aria-hidden="true" tabindex="-1"></a>R2_ridge_basic <span class="op">=</span> <span class="dv">1</span><span class="op">-</span> MSE_lasso_cv_basic.iloc[<span class="dv">0</span>,<span class="dv">0</span>] <span class="op">/</span> np.var( Y_test )</span>
<span id="cb70-20"><a href="machine-learning-for-wage-prediction.html#cb70-20" aria-hidden="true" tabindex="-1"></a>R2_elnet_basic <span class="op">=</span> <span class="dv">1</span><span class="op">-</span> MSE_elnet_basic.iloc[<span class="dv">0</span>,<span class="dv">0</span>] <span class="op">/</span> np.var( Y_test )</span>
<span id="cb70-21"><a href="machine-learning-for-wage-prediction.html#cb70-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-22"><a href="machine-learning-for-wage-prediction.html#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="ss">f&quot;R^2 using cross-validation for lasso, ridge and elastic net in the basic model: </span><span class="sc">{</span>R2_lasso_cv_basic<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>R2_ridge_basic<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>R2_elnet_basic<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<pre><code>## R^2 using cross-validation for lasso, ridge and elastic net in the basic model: 0.004530121996736747,0.28087507235726406,0.2777347888304399</code></pre>
</div>
</div>
<p>Note that the following calculations for the flexible model require significant computation time.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="machine-learning-for-wage-prediction.html#cb72-1" aria-hidden="true" tabindex="-1"></a>fit.lasso.cv.flex   <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(model_X_flex_train, Y_train, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb72-2"><a href="machine-learning-for-wage-prediction.html#cb72-2" aria-hidden="true" tabindex="-1"></a>fit.ridge.flex   <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(model_X_flex_train, Y_train, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">alpha=</span><span class="dv">0</span>)</span>
<span id="cb72-3"><a href="machine-learning-for-wage-prediction.html#cb72-3" aria-hidden="true" tabindex="-1"></a>fit.elnet.flex   <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(model_X_flex_train, Y_train, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">alpha=</span>.<span class="dv">5</span>)</span>
<span id="cb72-4"><a href="machine-learning-for-wage-prediction.html#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="machine-learning-for-wage-prediction.html#cb72-5" aria-hidden="true" tabindex="-1"></a>yhat.lasso.cv.flex    <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.lasso.cv.flex , <span class="at">newx =</span> model_X_flex_test)</span>
<span id="cb72-6"><a href="machine-learning-for-wage-prediction.html#cb72-6" aria-hidden="true" tabindex="-1"></a>yhat.ridge.flex    <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.ridge.flex , <span class="at">newx =</span> model_X_flex_test)</span>
<span id="cb72-7"><a href="machine-learning-for-wage-prediction.html#cb72-7" aria-hidden="true" tabindex="-1"></a>yhat.elnet.flex    <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.elnet.flex , <span class="at">newx =</span> model_X_flex_test)</span>
<span id="cb72-8"><a href="machine-learning-for-wage-prediction.html#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="machine-learning-for-wage-prediction.html#cb72-9" aria-hidden="true" tabindex="-1"></a>MSE.lasso.cv.flex  <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.lasso.cv.flex )<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb72-10"><a href="machine-learning-for-wage-prediction.html#cb72-10" aria-hidden="true" tabindex="-1"></a>MSE.ridge.flex  <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.ridge.flex )<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb72-11"><a href="machine-learning-for-wage-prediction.html#cb72-11" aria-hidden="true" tabindex="-1"></a>MSE.elnet.flex  <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.elnet.flex )<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb72-12"><a href="machine-learning-for-wage-prediction.html#cb72-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-13"><a href="machine-learning-for-wage-prediction.html#cb72-13" aria-hidden="true" tabindex="-1"></a>R2.lasso.cv.flex  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.lasso.cv.flex [<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb72-14"><a href="machine-learning-for-wage-prediction.html#cb72-14" aria-hidden="true" tabindex="-1"></a>R2.ridge.flex  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.ridge.flex [<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb72-15"><a href="machine-learning-for-wage-prediction.html#cb72-15" aria-hidden="true" tabindex="-1"></a>R2.elnet.flex  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.elnet.flex [<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb72-16"><a href="machine-learning-for-wage-prediction.html#cb72-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-17"><a href="machine-learning-for-wage-prediction.html#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="co"># R^2 using cross-validation (flexible model) </span></span>
<span id="cb72-18"><a href="machine-learning-for-wage-prediction.html#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;R^2 using cross-validation for lasso, ridge and elastic net in the flexible model:&quot;</span>,R2.lasso.cv.flex,R2.ridge.flex,R2.elnet.flex)</span></code></pre></div>
<pre><code>## R^2 using cross-validation for lasso, ridge and elastic net in the flexible model: 0.2751157 0.2710676 0.2761405</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb74"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="machine-learning-for-wage-prediction.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshaping Y variable</span></span>
<span id="cb74-2"><a href="machine-learning-for-wage-prediction.html#cb74-2" aria-hidden="true" tabindex="-1"></a>Y_vec <span class="op">=</span> Y_train.to_numpy().reshape( Y_train.to_numpy().size, <span class="dv">1</span>)</span>
<span id="cb74-3"><a href="machine-learning-for-wage-prediction.html#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="machine-learning-for-wage-prediction.html#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Scalar distribution</span></span>
<span id="cb74-5"><a href="machine-learning-for-wage-prediction.html#cb74-5" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb74-6"><a href="machine-learning-for-wage-prediction.html#cb74-6" aria-hidden="true" tabindex="-1"></a>scaler.fit( Y_vec )</span></code></pre></div>
<pre><code>## StandardScaler()</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="machine-learning-for-wage-prediction.html#cb76-1" aria-hidden="true" tabindex="-1"></a>std_Y <span class="op">=</span> scaler.transform( Y_vec )</span>
<span id="cb76-2"><a href="machine-learning-for-wage-prediction.html#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="machine-learning-for-wage-prediction.html#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Regressions</span></span>
<span id="cb76-4"><a href="machine-learning-for-wage-prediction.html#cb76-4" aria-hidden="true" tabindex="-1"></a>fit_lasso_cv_flex <span class="op">=</span> LassoCV(cv <span class="op">=</span> <span class="dv">10</span> , random_state <span class="op">=</span> <span class="dv">0</span> , normalize <span class="op">=</span> <span class="va">True</span> ).fit( model_X_flex_train, std_Y )</span>
<span id="cb76-5"><a href="machine-learning-for-wage-prediction.html#cb76-5" aria-hidden="true" tabindex="-1"></a>fit_ridge_flex <span class="op">=</span> ElasticNetCV( cv <span class="op">=</span> <span class="dv">10</span> , normalize <span class="op">=</span> <span class="va">True</span> , random_state <span class="op">=</span> <span class="dv">0</span> , l1_ratio <span class="op">=</span> <span class="fl">0.0001</span> ).fit( model_X_flex_train , std_Y )</span>
<span id="cb76-6"><a href="machine-learning-for-wage-prediction.html#cb76-6" aria-hidden="true" tabindex="-1"></a>fit_elnet_flex <span class="op">=</span> ElasticNetCV( cv <span class="op">=</span> <span class="dv">10</span> , normalize <span class="op">=</span> <span class="va">True</span> , random_state <span class="op">=</span> <span class="dv">0</span> , l1_ratio <span class="op">=</span> <span class="fl">0.5</span>, max_iter <span class="op">=</span> <span class="dv">100000</span> ).fit( model_X_flex_train , std_Y )</span>
<span id="cb76-7"><a href="machine-learning-for-wage-prediction.html#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="machine-learning-for-wage-prediction.html#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb76-9"><a href="machine-learning-for-wage-prediction.html#cb76-9" aria-hidden="true" tabindex="-1"></a>yhat_lasso_cv_flex <span class="op">=</span> scaler.inverse_transform( fit_lasso_cv_flex.predict( model_X_flex_test ) )</span>
<span id="cb76-10"><a href="machine-learning-for-wage-prediction.html#cb76-10" aria-hidden="true" tabindex="-1"></a>yhat_ridge_flex <span class="op">=</span> scaler.inverse_transform( fit_ridge_flex.predict( model_X_flex_test ) )</span>
<span id="cb76-11"><a href="machine-learning-for-wage-prediction.html#cb76-11" aria-hidden="true" tabindex="-1"></a>yhat_elnet_flex <span class="op">=</span> scaler.inverse_transform( fit_elnet_flex.predict( model_X_flex_test ) )</span>
<span id="cb76-12"><a href="machine-learning-for-wage-prediction.html#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="machine-learning-for-wage-prediction.html#cb76-13" aria-hidden="true" tabindex="-1"></a>MSE_lasso_cv_flex <span class="op">=</span> sm.OLS( ((Y_test <span class="op">-</span> yhat_lasso_cv_flex)<span class="op">**</span><span class="dv">2</span> ) , np.ones( yhat_lasso_cv_flex.shape )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb76-14"><a href="machine-learning-for-wage-prediction.html#cb76-14" aria-hidden="true" tabindex="-1"></a>MSE_ridge_flex <span class="op">=</span> sm.OLS( ((Y_test <span class="op">-</span> yhat_ridge_flex)<span class="op">**</span><span class="dv">2</span> ) , np.ones( yhat_ridge_flex.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb76-15"><a href="machine-learning-for-wage-prediction.html#cb76-15" aria-hidden="true" tabindex="-1"></a>MSE_elnet_flex <span class="op">=</span> sm.OLS( ((Y_test <span class="op">-</span> yhat_elnet_flex)<span class="op">**</span><span class="dv">2</span> ) , np.ones( yhat_elnet_flex.size )  ).fit().summary2().tables[<span class="dv">1</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb76-16"><a href="machine-learning-for-wage-prediction.html#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co"># our coefficient of MSE_elnet are far from r output</span></span>
<span id="cb76-17"><a href="machine-learning-for-wage-prediction.html#cb76-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-18"><a href="machine-learning-for-wage-prediction.html#cb76-18" aria-hidden="true" tabindex="-1"></a>R2_lasso_cv_flex <span class="op">=</span> <span class="dv">1</span><span class="op">-</span> MSE_ridge_flex.iloc[<span class="dv">0</span>,<span class="dv">0</span>] <span class="op">/</span> np.var( Y_test )</span>
<span id="cb76-19"><a href="machine-learning-for-wage-prediction.html#cb76-19" aria-hidden="true" tabindex="-1"></a>R2_ridge_flex <span class="op">=</span> <span class="dv">1</span><span class="op">-</span> MSE_lasso_cv_flex.iloc[<span class="dv">0</span>,<span class="dv">0</span>] <span class="op">/</span> np.var( Y_test )</span>
<span id="cb76-20"><a href="machine-learning-for-wage-prediction.html#cb76-20" aria-hidden="true" tabindex="-1"></a>R2_elnet_flex <span class="op">=</span> <span class="dv">1</span><span class="op">-</span> MSE_elnet_flex.iloc[<span class="dv">0</span>,<span class="dv">0</span>] <span class="op">/</span> np.var( Y_test )</span>
<span id="cb76-21"><a href="machine-learning-for-wage-prediction.html#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="machine-learning-for-wage-prediction.html#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="ss">f&quot;R^2 using cross-validation for lasso, ridge and elastic net in the basic model: </span><span class="sc">{</span>R2_lasso_cv_flex<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>R2_ridge_flex<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>R2_elnet_flex<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<pre><code>## R^2 using cross-validation for lasso, ridge and elastic net in the basic model: 0.01081068905038507,0.2777347888304399,0.26517365472314314</code></pre>
</div>
</div>
<p>The performance of the lasso regression with cross-validated penalty is quite similar to the performance of lasso using a theoretical based choice of the tuning parameter.</p>
</div>
<div id="non-linear-models" class="section level2" number="8.5">
<h2><span class="header-section-number">8.5</span> Non-linear models</h2>
<p>Besides linear regression models, we consider nonlinear regression models to build a predictive model. We are applying regression trees, random forests, boosted trees and neural nets to estimate the regression function <span class="math inline">\(g(X)\)</span>. First, we load the relevant libraries</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="machine-learning-for-wage-prediction.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code></pre></div>
<pre><code>## randomForest 4.6-14</code></pre>
<pre><code>## Type rfNews() to see new features/changes/bug fixes.</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="machine-learning-for-wage-prediction.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb81-2"><a href="machine-learning-for-wage-prediction.html#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nnet)</span>
<span id="cb81-3"><a href="machine-learning-for-wage-prediction.html#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm)</span></code></pre></div>
<pre><code>## Loaded gbm 2.1.8</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="machine-learning-for-wage-prediction.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb83-2"><a href="machine-learning-for-wage-prediction.html#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb83-3"><a href="machine-learning-for-wage-prediction.html#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="fu">import</span>(<span class="st">&quot;tensorflow&quot;</span>)</span></code></pre></div>
<pre><code>## Module(tensorflow)</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="machine-learning-for-wage-prediction.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">import</span>(<span class="st">&quot;keras&quot;</span>)</span></code></pre></div>
<pre><code>## Module(keras)</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="machine-learning-for-wage-prediction.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span></code></pre></div>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb88"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="machine-learning-for-wage-prediction.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>and we illustrate the application of regression trees.</p>
<div id="regression-trees" class="section level3" number="8.5.1">
<h3><span class="header-section-number">8.5.1</span> Regression Trees</h3>
<p>We fit a regression tree to the training data using the basic model. The variable <em>cp</em> controls the complexity of the regression tree, i.e. how deep we build the tree.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="machine-learning-for-wage-prediction.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tree</span></span>
<span id="cb89-2"><a href="machine-learning-for-wage-prediction.html#cb89-2" aria-hidden="true" tabindex="-1"></a>fit.trees <span class="ot">&lt;-</span> <span class="fu">rpart</span>(formula_basic, data_train,<span class="at">cp =</span> <span class="fl">0.001</span>)</span>
<span id="cb89-3"><a href="machine-learning-for-wage-prediction.html#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(fit.trees,<span class="at">leaf.round=</span><span class="dv">1</span>, <span class="at">space=</span><span class="dv">2</span>, <span class="at">yspace=</span><span class="dv">2</span>,<span class="at">split.space=</span><span class="dv">2</span>,<span class="at">shadow.col =</span> <span class="st">&quot;gray&quot;</span>,<span class="at">trace =</span> <span class="dv">1</span>) <span class="co"># plotting the tree</span></span></code></pre></div>
<pre><code>## cex 0.15   xlim c(0, 1)   ylim c(0, 1)</code></pre>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb91"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="machine-learning-for-wage-prediction.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>An important method to improve predictive performance is called “Pruning the Tree”. This
means the process of cutting down the branches of a tree. We apply pruning to the complex tree above to reduce the depth. Initially, we determine the optimal complexity of the regression tree.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="machine-learning-for-wage-prediction.html#cb92-1" aria-hidden="true" tabindex="-1"></a>bestcp<span class="ot">&lt;-</span> fit.trees<span class="sc">$</span>cptable[<span class="fu">which.min</span>(fit.trees<span class="sc">$</span>cptable[,<span class="st">&quot;xerror&quot;</span>]),<span class="st">&quot;CP&quot;</span>]</span>
<span id="cb92-2"><a href="machine-learning-for-wage-prediction.html#cb92-2" aria-hidden="true" tabindex="-1"></a>bestcp</span></code></pre></div>
<pre><code>## [1] 0.002556354</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb94"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="machine-learning-for-wage-prediction.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>Now, we can prune the tree and visualize the prediction rule.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="machine-learning-for-wage-prediction.html#cb95-1" aria-hidden="true" tabindex="-1"></a>fit.prunedtree <span class="ot">&lt;-</span> <span class="fu">prune</span>(fit.trees,<span class="at">cp=</span>bestcp)</span>
<span id="cb95-2"><a href="machine-learning-for-wage-prediction.html#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(fit.prunedtree,<span class="at">leaf.round=</span><span class="dv">1</span>, <span class="at">space=</span><span class="dv">3</span>, <span class="at">yspace=</span><span class="dv">3</span>, <span class="at">split.space=</span><span class="dv">7</span>, <span class="at">shadow.col =</span> <span class="st">&quot;gray&quot;</span>,<span class="at">trace =</span> <span class="dv">1</span>,<span class="at">yesno=</span><span class="dv">1</span>)</span></code></pre></div>
<pre><code>## cex 0.263   xlim c(0, 1)   ylim c(0, 1)</code></pre>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb97"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="machine-learning-for-wage-prediction.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>E.g., in the pruned tree the predicted hourly log wage for high-school graduates with more than <span class="math inline">\(9.5\)</span> years of experience is <span class="math inline">\(2.8\)</span>, and otherwise is <span class="math inline">\(2.6\)</span>.</p>
<p>Finally, we calculate the mean-squared error and the <span class="math inline">\(R^2\)</span> on the test sample to evaluate the out-of-sample performance of the pruned tree.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="machine-learning-for-wage-prediction.html#cb98-1" aria-hidden="true" tabindex="-1"></a>bestcp<span class="ot">&lt;-</span> fit.trees<span class="sc">$</span>cptable[<span class="fu">which.min</span>(fit.trees<span class="sc">$</span>cptable[,<span class="st">&quot;xerror&quot;</span>]),<span class="st">&quot;CP&quot;</span>]</span>
<span id="cb98-2"><a href="machine-learning-for-wage-prediction.html#cb98-2" aria-hidden="true" tabindex="-1"></a>bestcp</span></code></pre></div>
<pre><code>## [1] 0.002556354</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb100"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="machine-learning-for-wage-prediction.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>Now, we can prune the tree and visualize the prediction rule.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="machine-learning-for-wage-prediction.html#cb101-1" aria-hidden="true" tabindex="-1"></a>yhat.pt <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.prunedtree,<span class="at">newdata=</span>data_test)</span>
<span id="cb101-2"><a href="machine-learning-for-wage-prediction.html#cb101-2" aria-hidden="true" tabindex="-1"></a>MSE.pt  <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.pt)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb101-3"><a href="machine-learning-for-wage-prediction.html#cb101-3" aria-hidden="true" tabindex="-1"></a>R2.pt   <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.pt[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb101-4"><a href="machine-learning-for-wage-prediction.html#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="machine-learning-for-wage-prediction.html#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="co"># R^2 of the pruned tree</span></span>
<span id="cb101-6"><a href="machine-learning-for-wage-prediction.html#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;R^2 of the pruned tree:&quot;</span>,R2.pt)</span></code></pre></div>
<pre><code>## R^2 of the pruned tree: 0.2238947</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb103"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="machine-learning-for-wage-prediction.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<div id="random-forest-and-boosted-trees" class="section level2" number="8.6">
<h2><span class="header-section-number">8.6</span> Random Forest and Boosted Trees</h2>
<p>In the next step, we apply the more advanced tree-based methods random forest and boosted trees.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="machine-learning-for-wage-prediction.html#cb104-1" aria-hidden="true" tabindex="-1"></a>bestcp<span class="ot">&lt;-</span> fit.trees<span class="sc">$</span>cptable[<span class="fu">which.min</span>(fit.trees<span class="sc">$</span>cptable[,<span class="st">&quot;xerror&quot;</span>]),<span class="st">&quot;CP&quot;</span>]</span>
<span id="cb104-2"><a href="machine-learning-for-wage-prediction.html#cb104-2" aria-hidden="true" tabindex="-1"></a>bestcp</span></code></pre></div>
<pre><code>## [1] 0.002556354</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb106"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="machine-learning-for-wage-prediction.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>Now, we can prune the tree and visualize the prediction rule.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="machine-learning-for-wage-prediction.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Applying the methods</span></span>
<span id="cb107-2"><a href="machine-learning-for-wage-prediction.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># random forest</span></span>
<span id="cb107-3"><a href="machine-learning-for-wage-prediction.html#cb107-3" aria-hidden="true" tabindex="-1"></a>fit.rf       <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula_basic, <span class="at">ntree=</span><span class="dv">2000</span>, <span class="at">nodesize=</span><span class="dv">5</span>, <span class="at">data=</span>data_train)</span>
<span id="cb107-4"><a href="machine-learning-for-wage-prediction.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for tuning: adjust input &quot;mtry&quot; to change the number of variables randomly sampled as candidates at each split</span></span>
<span id="cb107-5"><a href="machine-learning-for-wage-prediction.html#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="machine-learning-for-wage-prediction.html#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="co"># boosting</span></span>
<span id="cb107-7"><a href="machine-learning-for-wage-prediction.html#cb107-7" aria-hidden="true" tabindex="-1"></a>fit.boost   <span class="ot">&lt;-</span> <span class="fu">gbm</span>(formula_basic, <span class="at">data=</span>data_train, <span class="at">distribution=</span> <span class="st">&quot;gaussian&quot;</span>, <span class="at">bag.fraction =</span> .<span class="dv">5</span>, <span class="at">interaction.depth=</span><span class="dv">2</span>, <span class="at">n.trees=</span><span class="dv">1000</span>, <span class="at">shrinkage=</span>.<span class="dv">01</span>)</span>
<span id="cb107-8"><a href="machine-learning-for-wage-prediction.html#cb107-8" aria-hidden="true" tabindex="-1"></a>best.boost  <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(fit.boost, <span class="at">plot.it =</span> <span class="cn">FALSE</span>) <span class="co"># cross-validation to determine when to stop</span></span></code></pre></div>
<pre><code>## OOB generally underestimates the optimal number of iterations although predictive performance is reasonably competitive. Using cv_folds&gt;1 when calling gbm usually results in improved predictive performance.</code></pre>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="machine-learning-for-wage-prediction.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Evaluating the methods</span></span>
<span id="cb109-2"><a href="machine-learning-for-wage-prediction.html#cb109-2" aria-hidden="true" tabindex="-1"></a>yhat.rf       <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.rf, <span class="at">newdata=</span>data_test) <span class="co"># prediction</span></span>
<span id="cb109-3"><a href="machine-learning-for-wage-prediction.html#cb109-3" aria-hidden="true" tabindex="-1"></a>yhat.boost    <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.boost, <span class="at">newdata=</span>data_test, <span class="at">n.trees=</span>best.boost)</span>
<span id="cb109-4"><a href="machine-learning-for-wage-prediction.html#cb109-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-5"><a href="machine-learning-for-wage-prediction.html#cb109-5" aria-hidden="true" tabindex="-1"></a>MSE.rf        <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.rf)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb109-6"><a href="machine-learning-for-wage-prediction.html#cb109-6" aria-hidden="true" tabindex="-1"></a>MSE.boost     <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>((Y_test<span class="sc">-</span>yhat.boost)<span class="sc">^</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>))<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb109-7"><a href="machine-learning-for-wage-prediction.html#cb109-7" aria-hidden="true" tabindex="-1"></a>R2.rf         <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.rf[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb109-8"><a href="machine-learning-for-wage-prediction.html#cb109-8" aria-hidden="true" tabindex="-1"></a>R2.boost      <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>MSE.boost[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">var</span>(Y_test)</span>
<span id="cb109-9"><a href="machine-learning-for-wage-prediction.html#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="machine-learning-for-wage-prediction.html#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="co"># printing R^2</span></span>
<span id="cb109-11"><a href="machine-learning-for-wage-prediction.html#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;R^2 of the random forest and boosted trees:&quot;</span>,R2.rf,R2.boost)</span></code></pre></div>
<pre><code>## R^2 of the random forest and boosted trees: 0.2695651 0.2786383</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb111"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="machine-learning-for-wage-prediction.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>To conclude, let us have a look at our results.</p>
</div>
<div id="results" class="section level2" number="8.7">
<h2><span class="header-section-number">8.7</span> Results</h2>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="machine-learning-for-wage-prediction.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xtable)</span>
<span id="cb112-2"><a href="machine-learning-for-wage-prediction.html#cb112-2" aria-hidden="true" tabindex="-1"></a>table<span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">15</span>, <span class="dv">3</span>)</span>
<span id="cb112-3"><a href="machine-learning-for-wage-prediction.html#cb112-3" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">1</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lm.basic</span>
<span id="cb112-4"><a href="machine-learning-for-wage-prediction.html#cb112-4" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lm.flex</span>
<span id="cb112-5"><a href="machine-learning-for-wage-prediction.html#cb112-5" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">3</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lasso</span>
<span id="cb112-6"><a href="machine-learning-for-wage-prediction.html#cb112-6" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">4</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lasso.post</span>
<span id="cb112-7"><a href="machine-learning-for-wage-prediction.html#cb112-7" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lasso.flex</span>
<span id="cb112-8"><a href="machine-learning-for-wage-prediction.html#cb112-8" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">6</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lasso.post.flex</span>
<span id="cb112-9"><a href="machine-learning-for-wage-prediction.html#cb112-9" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">7</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lasso.cv</span>
<span id="cb112-10"><a href="machine-learning-for-wage-prediction.html#cb112-10" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">8</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.ridge</span>
<span id="cb112-11"><a href="machine-learning-for-wage-prediction.html#cb112-11" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">9</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.elnet</span>
<span id="cb112-12"><a href="machine-learning-for-wage-prediction.html#cb112-12" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">10</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]   <span class="ot">&lt;-</span> MSE.lasso.cv.flex</span>
<span id="cb112-13"><a href="machine-learning-for-wage-prediction.html#cb112-13" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">11</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]  <span class="ot">&lt;-</span> MSE.ridge.flex</span>
<span id="cb112-14"><a href="machine-learning-for-wage-prediction.html#cb112-14" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">12</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]  <span class="ot">&lt;-</span> MSE.elnet.flex</span>
<span id="cb112-15"><a href="machine-learning-for-wage-prediction.html#cb112-15" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">13</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]  <span class="ot">&lt;-</span> MSE.rf</span>
<span id="cb112-16"><a href="machine-learning-for-wage-prediction.html#cb112-16" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">14</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]  <span class="ot">&lt;-</span> MSE.boost</span>
<span id="cb112-17"><a href="machine-learning-for-wage-prediction.html#cb112-17" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">15</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]  <span class="ot">&lt;-</span> MSE.pt</span>
<span id="cb112-18"><a href="machine-learning-for-wage-prediction.html#cb112-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-19"><a href="machine-learning-for-wage-prediction.html#cb112-19" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">1</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lm.basic</span>
<span id="cb112-20"><a href="machine-learning-for-wage-prediction.html#cb112-20" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">2</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lm.flex</span>
<span id="cb112-21"><a href="machine-learning-for-wage-prediction.html#cb112-21" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">3</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lasso</span>
<span id="cb112-22"><a href="machine-learning-for-wage-prediction.html#cb112-22" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">4</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lasso.post</span>
<span id="cb112-23"><a href="machine-learning-for-wage-prediction.html#cb112-23" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">5</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lasso.flex</span>
<span id="cb112-24"><a href="machine-learning-for-wage-prediction.html#cb112-24" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">6</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lasso.post.flex</span>
<span id="cb112-25"><a href="machine-learning-for-wage-prediction.html#cb112-25" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">7</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lasso.cv</span>
<span id="cb112-26"><a href="machine-learning-for-wage-prediction.html#cb112-26" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">8</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.ridge</span>
<span id="cb112-27"><a href="machine-learning-for-wage-prediction.html#cb112-27" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">9</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.elnet</span>
<span id="cb112-28"><a href="machine-learning-for-wage-prediction.html#cb112-28" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">10</span>,<span class="dv">3</span>]   <span class="ot">&lt;-</span> R2.lasso.cv.flex</span>
<span id="cb112-29"><a href="machine-learning-for-wage-prediction.html#cb112-29" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">11</span>,<span class="dv">3</span>]  <span class="ot">&lt;-</span> R2.ridge.flex</span>
<span id="cb112-30"><a href="machine-learning-for-wage-prediction.html#cb112-30" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">12</span>,<span class="dv">3</span>]  <span class="ot">&lt;-</span> R2.elnet.flex</span>
<span id="cb112-31"><a href="machine-learning-for-wage-prediction.html#cb112-31" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">13</span>,<span class="dv">3</span>]  <span class="ot">&lt;-</span> R2.rf</span>
<span id="cb112-32"><a href="machine-learning-for-wage-prediction.html#cb112-32" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">14</span>,<span class="dv">3</span>]  <span class="ot">&lt;-</span> R2.boost</span>
<span id="cb112-33"><a href="machine-learning-for-wage-prediction.html#cb112-33" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">15</span>,<span class="dv">3</span>]  <span class="ot">&lt;-</span> R2.pt</span>
<span id="cb112-34"><a href="machine-learning-for-wage-prediction.html#cb112-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-35"><a href="machine-learning-for-wage-prediction.html#cb112-35" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(table)<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;MSE&quot;</span>, <span class="st">&quot;S.E. for MSE&quot;</span>, <span class="st">&quot;R-squared&quot;</span>)</span>
<span id="cb112-36"><a href="machine-learning-for-wage-prediction.html#cb112-36" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(table)<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Least Squares (basic)&quot;</span>,<span class="st">&quot;Least Squares (flexible)&quot;</span>, <span class="st">&quot;Lasso&quot;</span>, <span class="st">&quot;Post-Lasso&quot;</span>,<span class="st">&quot;Lasso (flexible)&quot;</span>,<span class="st">&quot;Post-Lasso (flexible)&quot;</span>, </span>
<span id="cb112-37"><a href="machine-learning-for-wage-prediction.html#cb112-37" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Cross-Validated lasso&quot;</span>, <span class="st">&quot;Cross-Validated ridge&quot;</span>,<span class="st">&quot;Cross-Validated elnet&quot;</span>,<span class="st">&quot;Cross-Validated lasso (flexible)&quot;</span>,<span class="st">&quot;Cross-Validated ridge (flexible)&quot;</span>,<span class="st">&quot;Cross-Validated elnet (flexible)&quot;</span>,  </span>
<span id="cb112-38"><a href="machine-learning-for-wage-prediction.html#cb112-38" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Random Forest&quot;</span>,<span class="st">&quot;Boosted Trees&quot;</span>, <span class="st">&quot;Pruned Tree&quot;</span>)</span>
<span id="cb112-39"><a href="machine-learning-for-wage-prediction.html#cb112-39" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">xtable</span>(table, <span class="at">digits =</span><span class="dv">3</span>)</span>
<span id="cb112-40"><a href="machine-learning-for-wage-prediction.html#cb112-40" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tab,<span class="at">type=</span><span class="st">&quot;latex&quot;</span>) <span class="co"># set type=&quot;latex&quot; for printing table in LaTeX</span></span></code></pre></div>
<pre><code>## % latex table generated in R 4.1.1 by xtable 1.8-4 package
## % Thu Nov 04 12:18:07 2021
## \begin{table}[ht]
## \centering
## \begin{tabular}{rrrr}
##   \hline
##  &amp; MSE &amp; S.E. for MSE &amp; R-squared \\ 
##   \hline
## Least Squares (basic) &amp; 0.229 &amp; 0.016 &amp; 0.282 \\ 
##   Least Squares (flexible) &amp; 0.243 &amp; 0.016 &amp; 0.238 \\ 
##   Lasso &amp; 0.234 &amp; 0.015 &amp; 0.267 \\ 
##   Post-Lasso &amp; 0.233 &amp; 0.015 &amp; 0.271 \\ 
##   Lasso (flexible) &amp; 0.235 &amp; 0.015 &amp; 0.265 \\ 
##   Post-Lasso (flexible) &amp; 0.236 &amp; 0.016 &amp; 0.261 \\ 
##   Cross-Validated lasso &amp; 0.229 &amp; 0.015 &amp; 0.282 \\ 
##   Cross-Validated ridge &amp; 0.234 &amp; 0.015 &amp; 0.267 \\ 
##   Cross-Validated elnet &amp; 0.230 &amp; 0.015 &amp; 0.280 \\ 
##   Cross-Validated lasso (flexible) &amp; 0.232 &amp; 0.015 &amp; 0.275 \\ 
##   Cross-Validated ridge (flexible) &amp; 0.233 &amp; 0.015 &amp; 0.271 \\ 
##   Cross-Validated elnet (flexible) &amp; 0.231 &amp; 0.015 &amp; 0.276 \\ 
##   Random Forest &amp; 0.233 &amp; 0.015 &amp; 0.270 \\ 
##   Boosted Trees &amp; 0.230 &amp; 0.015 &amp; 0.279 \\ 
##   Pruned Tree &amp; 0.248 &amp; 0.016 &amp; 0.224 \\ 
##    \hline
## \end{tabular}
## \end{table}</code></pre>
<!-- html table generated in R 4.1.1 by xtable 1.8-4 package -->
<!-- Thu Nov 04 12:15:36 2021 -->
<table border="1">
<tr>
<th>
</th>
<th>
Weight OLS
</th>
<th>
Weight Lasso
</th>
</tr>
<tr>
<td align="right">
Constant
</td>
<td align="right">
-0.162
</td>
<td align="right">
-0.147
</td>
</tr>
<tr>
<td align="right">
Least Squares (basic)
</td>
<td align="right">
0.281
</td>
<td align="right">
0.293
</td>
</tr>
<tr>
<td align="right">
Post-Lasso (flexible)
</td>
<td align="right">
0.237
</td>
<td align="right">
0.223
</td>
</tr>
<tr>
<td align="right">
Cross-Validated elnet (flexible)
</td>
<td align="right">
-0.068
</td>
<td align="right">
-0.056
</td>
</tr>
<tr>
<td align="right">
Pruned Tree
</td>
<td align="right">
-0.140
</td>
<td align="right">
0.000
</td>
</tr>
<tr>
<td align="right">
Random Forest
</td>
<td align="right">
0.377
</td>
<td align="right">
0.344
</td>
</tr>
<tr>
<td align="right">
Boosted Trees
</td>
<td align="right">
0.367
</td>
<td align="right">
0.245
</td>
</tr>
</table>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb114"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb114-1"><a href="machine-learning-for-wage-prediction.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>Above, we displayed the results for a single split of data into the training and testing part. The table shows the test MSE in column 1 as well as the standard error in column 2 and the test <span class="math inline">\(R^2\)</span> in column 3. We see that the prediction rule produced by Elastic Net using the flexible model performs the best here, giving the lowest test MSE. Cross-Validated Lasso and Ridge, perform nearly as well. For any two of these methods, their testing MSEs are within one standard error of each other. Remarkably, OLS on a simple model performs extremely well, almost as well as best tree based method Random Forest. On the other hand, OLS on a flexible model with many regressors performs very poorly giving the highest test MSE. It is worth to notice that the nonlinear models, e.g. Random Forest, are not tuned. Thus, there is a lot of potential to improve the performance of the nonlinear methods we used in the analysis.</p>
</div>
<div id="ensemble-learning" class="section level2" number="8.8">
<h2><span class="header-section-number">8.8</span> Ensemble learning</h2>
<p>In the final step, we can build a prediction model by combing the strengths of the models we considered so far. This ensemble method is of the form
<span class="math display">\[ f(x) = \sum_{k=1}^K \alpha_k f_k(x) \]</span>
where the <span class="math inline">\(f_k\)</span>’s denote our prediction rules from the table above and the <span class="math inline">\(\alpha_k\)</span>’s are the corresponding weights.
We focus on the prediction rules based on OLS, Post-Lasso, Elastic Net, Pruned Tree, Random Forest, Boosted Trees, and Neural Network and combine these methods into an ensemble method. The weights can be determined by a simple ols regression:</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="machine-learning-for-wage-prediction.html#cb115-1" aria-hidden="true" tabindex="-1"></a>ensemble.ols <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>(Y_test<span class="sc">~</span> yhat.lm.basic <span class="sc">+</span> yhat.rlasso.post.flex <span class="sc">+</span> yhat.elnet.flex<span class="sc">+</span> yhat.pt<span class="sc">+</span> yhat.rf <span class="sc">+</span> yhat.boost))</span></code></pre></div>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb116"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb116-1"><a href="machine-learning-for-wage-prediction.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>Alternatively, we can determine the weights via lasso regression.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="machine-learning-for-wage-prediction.html#cb117-1" aria-hidden="true" tabindex="-1"></a>ensemble.lasso <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">rlasso</span>(Y_test<span class="sc">~</span> yhat.lm.basic <span class="sc">+</span> yhat.rlasso.post.flex <span class="sc">+</span> yhat.elnet.flex<span class="sc">+</span> yhat.pt<span class="sc">+</span> yhat.rf <span class="sc">+</span> yhat.boost))</span></code></pre></div>
<pre><code>## 
## Call:
## rlasso.formula(formula = Y_test ~ yhat.lm.basic + yhat.rlasso.post.flex + 
##     yhat.elnet.flex + yhat.pt + yhat.rf + yhat.boost)
## 
## Post-Lasso Estimation:  TRUE 
## 
## Total number of variables: 6
## Number of selected variables: 5 
## 
## Residuals: 
##       Min        1Q    Median        3Q       Max 
## -1.853465 -0.282571 -0.005527  0.263961  3.548724 
## 
##                       Estimate
## (Intercept)             -0.147
## yhat.lm.basic            0.293
## yhat.rlasso.post.flex    0.223
## yhat.elnet.flex         -0.056
## yhat.pt                  0.000
## yhat.rf                  0.344
## yhat.boost               0.245
## 
## Residual standard error: 0.4728
## Multiple R-squared:  0.3003
## Adjusted R-squared:  0.2976
## Joint significance test:
##  the sup score statistic for joint significance test is  3.53 with a p-value of  0.04</code></pre>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb119"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb119-1"><a href="machine-learning-for-wage-prediction.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>The estimated weights are shown in the following table.</p>
<div class="columns">
<div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="machine-learning-for-wage-prediction.html#cb120-1" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">7</span>, <span class="dv">2</span>)</span>
<span id="cb120-2"><a href="machine-learning-for-wage-prediction.html#cb120-2" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>,<span class="dv">1</span>]   <span class="ot">&lt;-</span> ensemble.ols<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb120-3"><a href="machine-learning-for-wage-prediction.html#cb120-3" aria-hidden="true" tabindex="-1"></a>table[<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>,<span class="dv">2</span>]   <span class="ot">&lt;-</span> ensemble.lasso<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb120-4"><a href="machine-learning-for-wage-prediction.html#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="machine-learning-for-wage-prediction.html#cb120-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-6"><a href="machine-learning-for-wage-prediction.html#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Weight OLS&quot;</span>, <span class="st">&quot;Weight Lasso&quot;</span>)</span>
<span id="cb120-7"><a href="machine-learning-for-wage-prediction.html#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Constant&quot;</span>,<span class="st">&quot;Least Squares (basic)&quot;</span>,<span class="st">&quot;Post-Lasso (flexible)&quot;</span>, <span class="st">&quot;Cross-Validated elnet (flexible)&quot;</span>, <span class="st">&quot;Pruned Tree&quot;</span>,</span>
<span id="cb120-8"><a href="machine-learning-for-wage-prediction.html#cb120-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Random Forest&quot;</span>,<span class="st">&quot;Boosted Trees&quot;</span>)</span>
<span id="cb120-9"><a href="machine-learning-for-wage-prediction.html#cb120-9" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">xtable</span>(table, <span class="at">digits =</span><span class="dv">3</span>)</span>
<span id="cb120-10"><a href="machine-learning-for-wage-prediction.html#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tab,<span class="at">type=</span><span class="st">&quot;latex&quot;</span>) <span class="co"># set type=&quot;latex&quot; for printing table in LaTeX</span></span></code></pre></div>
<pre><code>## % latex table generated in R 4.1.1 by xtable 1.8-4 package
## % Thu Nov 04 12:18:13 2021
## \begin{table}[ht]
## \centering
## \begin{tabular}{rrr}
##   \hline
##  &amp; Weight OLS &amp; Weight Lasso \\ 
##   \hline
## Constant &amp; -0.162 &amp; -0.147 \\ 
##   Least Squares (basic) &amp; 0.281 &amp; 0.293 \\ 
##   Post-Lasso (flexible) &amp; 0.237 &amp; 0.223 \\ 
##   Cross-Validated elnet (flexible) &amp; -0.068 &amp; -0.056 \\ 
##   Pruned Tree &amp; -0.140 &amp; 0.000 \\ 
##   Random Forest &amp; 0.377 &amp; 0.344 \\ 
##   Boosted Trees &amp; 0.367 &amp; 0.245 \\ 
##    \hline
## \end{tabular}
## \end{table}</code></pre>
<!-- html table generated in R 4.1.1 by xtable 1.8-4 package -->
<!-- Thu Nov 04 12:16:14 2021 -->
<table border="1">
<tr>
<th>
</th>
<th>
Weight OLS
</th>
<th>
Weight Lasso
</th>
</tr>
<tr>
<td align="right">
Constant
</td>
<td align="right">
-0.162
</td>
<td align="right">
-0.147
</td>
</tr>
<tr>
<td align="right">
Least Squares (basic)
</td>
<td align="right">
0.281
</td>
<td align="right">
0.293
</td>
</tr>
<tr>
<td align="right">
Post-Lasso (flexible)
</td>
<td align="right">
0.237
</td>
<td align="right">
0.223
</td>
</tr>
<tr>
<td align="right">
Cross-Validated elnet (flexible)
</td>
<td align="right">
-0.068
</td>
<td align="right">
-0.056
</td>
</tr>
<tr>
<td align="right">
Pruned Tree
</td>
<td align="right">
-0.140
</td>
<td align="right">
0.000
</td>
</tr>
<tr>
<td align="right">
Random Forest
</td>
<td align="right">
0.377
</td>
<td align="right">
0.344
</td>
</tr>
<tr>
<td align="right">
Boosted Trees
</td>
<td align="right">
0.367
</td>
<td align="right">
0.245
</td>
</tr>
</table>
</div><div class="column" style="width:1%;">
<p> 
<!-- an empty Div (with a white space), serving as
a column separator --></p>
</div><div class="column" style="width:49.5%;">
<div class="sourceCode" id="cb122"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="machine-learning-for-wage-prediction.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in process</span></span></code></pre></div>
</div>
</div>
<p>Further, the <span class="math inline">\(R^2\)</span> for the test sample gets improved from <span class="math inline">\(30\%\)</span> obtained by OLS to about <span class="math inline">\(31\%\)</span> obtained by the ensemble method. We see that it is very powerful to aggregate prediction rules into an ensemble rule. Nevertheless, it is worth to notice that we should compare the ensemble method and the single rules on an additional validation set to ensure a fair comparison.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="testing-the-convergence-hypothesis.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/alexanderquispe/ml_book/edit/master/18-ML_wage_prediction.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/alexanderquispe/ml_book/blob/master/18-ML_wage_prediction.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
