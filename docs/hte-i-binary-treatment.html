<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 22 HTE I: Binary treatment | Machine Learning and Causal Inference</title>
  <meta name="description" content="Chapter 22 HTE I: Binary treatment | Machine Learning and Causal Inference" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 22 HTE I: Binary treatment | Machine Learning and Causal Inference" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 22 HTE I: Binary treatment | Machine Learning and Causal Inference" />
  
  
  

<meta name="author" content="Alexander Quispe &amp; Anzony Quispe" />


<meta name="date" content="2021-11-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html"/>

<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Machine Learning and Causal Inference</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a></li>
<li class="chapter" data-level="2" data-path="predictive-inference.html"><a href="predictive-inference.html"><i class="fa fa-check"></i><b>2</b> Predictive Inference</a>
<ul>
<li class="chapter" data-level="2.1" data-path="predictive-inference.html"><a href="predictive-inference.html#data"><i class="fa fa-check"></i><b>2.1</b> Data</a></li>
<li class="chapter" data-level="2.2" data-path="predictive-inference.html"><a href="predictive-inference.html#data-analysis"><i class="fa fa-check"></i><b>2.2</b> Data Analysis</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="predictive-inference.html"><a href="predictive-inference.html#r-and-python-code"><i class="fa fa-check"></i><b>2.2.1</b> R and Python code</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="predictive-inference.html"><a href="predictive-inference.html#prediction-question"><i class="fa fa-check"></i><b>2.3</b> Prediction Question</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="predictive-inference.html"><a href="predictive-inference.html#basic-model"><i class="fa fa-check"></i><b>2.3.1</b> Basic Model:</a></li>
<li class="chapter" data-level="2.3.2" data-path="predictive-inference.html"><a href="predictive-inference.html#flexible-model"><i class="fa fa-check"></i><b>2.3.2</b> Flexible Model:</a></li>
<li class="chapter" data-level="2.3.3" data-path="predictive-inference.html"><a href="predictive-inference.html#lasso-model"><i class="fa fa-check"></i><b>2.3.3</b> Lasso Model:</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="predictive-inference.html"><a href="predictive-inference.html#data-splitting"><i class="fa fa-check"></i><b>2.4</b> Data Splitting</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html"><i class="fa fa-check"></i><b>3</b> Predictive Inference The Gender Wage Gap</a>
<ul>
<li class="chapter" data-level="3.1" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#data-analysis-1"><i class="fa fa-check"></i><b>3.1</b> Data analysis</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#ols-regression"><i class="fa fa-check"></i><b>3.1.1</b> OLS Regression</a></li>
<li class="chapter" data-level="3.1.2" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#ols-regression-with-controls"><i class="fa fa-check"></i><b>3.1.2</b> Ols regression with controls</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#partialling-out-using-ols"><i class="fa fa-check"></i><b>3.2</b> Partialling-Out using ols</a></li>
<li class="chapter" data-level="3.3" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#partialling-out-using-lasso"><i class="fa fa-check"></i><b>3.3</b> Partialling-Out using lasso</a></li>
<li class="chapter" data-level="3.4" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#extra-flexible-model"><i class="fa fa-check"></i><b>3.4</b> “Extra” flexible model</a></li>
<li class="chapter" data-level="3.5" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#laso-extra-flexible-model"><i class="fa fa-check"></i><b>3.5</b> Laso “Extra” Flexible model</a></li>
<li class="chapter" data-level="3.6" data-path="predictive-inference-the-gender-wage-gap.html"><a href="predictive-inference-the-gender-wage-gap.html#summarize-the-results"><i class="fa fa-check"></i><b>3.6</b> Summarize the results</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html"><i class="fa fa-check"></i><b>4</b> Simple Exercise on Overfitting</a>
<ul>
<li class="chapter" data-level="4.1" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html#first-set-pn"><i class="fa fa-check"></i><b>4.1</b> 1. First set p=n</a></li>
<li class="chapter" data-level="4.2" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html#second-set-pn2."><i class="fa fa-check"></i><b>4.2</b> 2. Second, set p=n/2.</a></li>
<li class="chapter" data-level="4.3" data-path="simple-exercise-on-overfitting.html"><a href="simple-exercise-on-overfitting.html#third-set-pn-.05"><i class="fa fa-check"></i><b>4.3</b> 3. Third, set p/n =.05</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="vaccine-rct-examples.html"><a href="vaccine-rct-examples.html"><i class="fa fa-check"></i><b>5</b> Vaccine RCT Examples</a>
<ul>
<li class="chapter" data-level="5.1" data-path="vaccine-rct-examples.html"><a href="vaccine-rct-examples.html#polio-rct"><i class="fa fa-check"></i><b>5.1</b> Polio RCT</a></li>
<li class="chapter" data-level="5.2" data-path="vaccine-rct-examples.html"><a href="vaccine-rct-examples.html#pfizerbntx-covid-19-rct"><i class="fa fa-check"></i><b>5.2</b> Pfizer/BNTX Covid-19 RCT</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="penalized-linear-regressions-a-simulation-experiment.html"><a href="penalized-linear-regressions-a-simulation-experiment.html"><i class="fa fa-check"></i><b>6</b> Penalized Linear Regressions: A Simulation Experiment</a>
<ul>
<li class="chapter" data-level="6.1" data-path="penalized-linear-regressions-a-simulation-experiment.html"><a href="penalized-linear-regressions-a-simulation-experiment.html#data-generating-process-approximately-sparse"><i class="fa fa-check"></i><b>6.1</b> Data Generating Process: Approximately Sparse</a></li>
<li class="chapter" data-level="6.2" data-path="penalized-linear-regressions-a-simulation-experiment.html"><a href="penalized-linear-regressions-a-simulation-experiment.html#data-generating-process-approximately-sparse-small-dense-part"><i class="fa fa-check"></i><b>6.2</b> Data Generating Process: Approximately Sparse + Small Dense Part</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="simulation-design.html"><a href="simulation-design.html"><i class="fa fa-check"></i><b>7</b> Simulation Design</a>
<ul>
<li class="chapter" data-level="7.1" data-path="simulation-design.html"><a href="simulation-design.html#example-1"><i class="fa fa-check"></i><b>7.1</b> Example 1</a></li>
<li class="chapter" data-level="7.2" data-path="simulation-design.html"><a href="simulation-design.html#example-2"><i class="fa fa-check"></i><b>7.2</b> Example 2</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html"><i class="fa fa-check"></i><b>8</b> Testing the Convergence Hypothesis</a>
<ul>
<li class="chapter" data-level="8.1" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#introduction"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#data-analysis-2"><i class="fa fa-check"></i><b>8.2</b> Data analysis</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#ols"><i class="fa fa-check"></i><b>8.2.1</b> OLS</a></li>
<li class="chapter" data-level="8.2.2" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#lasso"><i class="fa fa-check"></i><b>8.2.2</b> Lasso</a></li>
<li class="chapter" data-level="8.2.3" data-path="testing-the-convergence-hypothesis.html"><a href="testing-the-convergence-hypothesis.html#summary-results"><i class="fa fa-check"></i><b>8.2.3</b> Summary results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html"><i class="fa fa-check"></i><b>9</b> Machine Learning for wage prediction</a>
<ul>
<li class="chapter" data-level="9.1" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#data-1"><i class="fa fa-check"></i><b>9.1</b> Data</a></li>
<li class="chapter" data-level="9.2" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#analysis"><i class="fa fa-check"></i><b>9.2</b> Analysis</a></li>
<li class="chapter" data-level="9.3" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#ols-1"><i class="fa fa-check"></i><b>9.3</b> OLS</a></li>
<li class="chapter" data-level="9.4" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#lasso-ridge-and-elastic-net"><i class="fa fa-check"></i><b>9.4</b> Lasso, Ridge and Elastic Net</a></li>
<li class="chapter" data-level="9.5" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#non-linear-models"><i class="fa fa-check"></i><b>9.5</b> Non-linear models</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#regression-trees"><i class="fa fa-check"></i><b>9.5.1</b> Regression Trees</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#random-forest-and-boosted-trees"><i class="fa fa-check"></i><b>9.6</b> Random Forest and Boosted Trees</a></li>
<li class="chapter" data-level="9.7" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#results"><i class="fa fa-check"></i><b>9.7</b> Results</a></li>
<li class="chapter" data-level="9.8" data-path="machine-learning-for-wage-prediction.html"><a href="machine-learning-for-wage-prediction.html#ensemble-learning"><i class="fa fa-check"></i><b>9.8</b> Ensemble learning</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="deep-neural-networks-for-wage-prediction.html"><a href="deep-neural-networks-for-wage-prediction.html"><i class="fa fa-check"></i><b>10</b> Deep Neural Networks for Wage Prediction</a>
<ul>
<li class="chapter" data-level="10.1" data-path="deep-neural-networks-for-wage-prediction.html"><a href="deep-neural-networks-for-wage-prediction.html#data-preparation"><i class="fa fa-check"></i><b>10.1</b> Data Preparation</a></li>
<li class="chapter" data-level="10.2" data-path="deep-neural-networks-for-wage-prediction.html"><a href="deep-neural-networks-for-wage-prediction.html#neural-networks"><i class="fa fa-check"></i><b>10.2</b> Neural Networks</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="functional-approximations-by-trees-and-neural-networks.html"><a href="functional-approximations-by-trees-and-neural-networks.html"><i class="fa fa-check"></i><b>11</b> Functional Approximations by Trees and Neural Networks</a>
<ul>
<li class="chapter" data-level="11.1" data-path="functional-approximations-by-trees-and-neural-networks.html"><a href="functional-approximations-by-trees-and-neural-networks.html#functional-approximation-by-a-tree"><i class="fa fa-check"></i><b>11.1</b> Functional Approximation by a Tree</a></li>
<li class="chapter" data-level="11.2" data-path="functional-approximations-by-trees-and-neural-networks.html"><a href="functional-approximations-by-trees-and-neural-networks.html#functional-approximation-by-rf"><i class="fa fa-check"></i><b>11.2</b> Functional Approximation by RF</a></li>
<li class="chapter" data-level="11.3" data-path="functional-approximations-by-trees-and-neural-networks.html"><a href="functional-approximations-by-trees-and-neural-networks.html#boosted-trees"><i class="fa fa-check"></i><b>11.3</b> Boosted Trees</a></li>
<li class="chapter" data-level="11.4" data-path="functional-approximations-by-trees-and-neural-networks.html"><a href="functional-approximations-by-trees-and-neural-networks.html#same-example-with-a-neural-network"><i class="fa fa-check"></i><b>11.4</b> Same Example with a Neural Network</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><i class="fa fa-check"></i><b>12</b> Causal Identification in DAGs using Backdoor and Swigs, Equivalence Classes, Falsifiability Tests</a>
<ul>
<li class="chapter" data-level="12.1" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#graph-generation-and-plotting"><i class="fa fa-check"></i><b>12.1</b> Graph Generation and Plotting</a></li>
<li class="chapter" data-level="12.2" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#report-relatives-of-x2"><i class="fa fa-check"></i><b>12.2</b> Report Relatives of X2</a></li>
<li class="chapter" data-level="12.3" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#find-paths-between-d-and-y"><i class="fa fa-check"></i><b>12.3</b> Find Paths Between D and Y</a></li>
<li class="chapter" data-level="12.4" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#list-all-testable-implications-of-the-model"><i class="fa fa-check"></i><b>12.4</b> List All Testable Implications of the Model</a></li>
<li class="chapter" data-level="12.5" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#identification-by-backdoor-list-minimal-adjustment-sets-to-identify-causal-effecs-d-to-y"><i class="fa fa-check"></i><b>12.5</b> Identification by Backdoor: List minimal adjustment sets to identify causal effecs <span class="math inline">\(D \to Y\)</span></a></li>
<li class="chapter" data-level="12.6" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#identification-via-swig-and-d-separation"><i class="fa fa-check"></i><b>12.6</b> Identification via SWIG and D-separation</a></li>
<li class="chapter" data-level="12.7" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#deduce-conditional-exogeneity-or-ignorability-by-d-separation"><i class="fa fa-check"></i><b>12.7</b> Deduce Conditional Exogeneity or Ignorability by D-separation</a></li>
<li class="chapter" data-level="12.8" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#print-all-average-effects-identifiable-by-conditioning"><i class="fa fa-check"></i><b>12.8</b> Print All Average Effects Identifiable by Conditioning</a></li>
<li class="chapter" data-level="12.9" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#equivalence-classes"><i class="fa fa-check"></i><b>12.9</b> Equivalence Classes</a></li>
<li class="chapter" data-level="12.10" data-path="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html"><a href="causal-identification-in-dags-using-backdoor-and-swigs-equivalence-classes-falsifiability-tests.html#example-of-testing-dag-validity"><i class="fa fa-check"></i><b>12.10</b> Example of Testing DAG Validity</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="dosearch-for-causal-identification-in-dags.html"><a href="dosearch-for-causal-identification-in-dags.html"><i class="fa fa-check"></i><b>13</b> Dosearch for Causal Identification in DAGs</a></li>
<li class="chapter" data-level="14" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><i class="fa fa-check"></i><b>14</b> A Case Study: The Effect of Gun Ownership on Gun-Homicide Rates</a>
<ul>
<li class="chapter" data-level="14.1" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html#data-2"><i class="fa fa-check"></i><b>14.1</b> Data</a></li>
<li class="chapter" data-level="14.2" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html#preprocessing."><i class="fa fa-check"></i><b>14.2</b> Preprocessing.</a></li>
<li class="chapter" data-level="14.3" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html#the-effect-of-gun-ownership"><i class="fa fa-check"></i><b>14.3</b> The effect of gun ownership</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html#ols-2"><i class="fa fa-check"></i><b>14.3.1</b> OLS</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html#dml-algorithm"><i class="fa fa-check"></i><b>14.4</b> DML algorithm</a></li>
<li class="chapter" data-level="14.5" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html#lasso-1"><i class="fa fa-check"></i><b>14.5</b> Lasso</a>
<ul>
<li class="chapter" data-level="14.5.1" data-path="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html"><a href="a-case-study-the-effect-of-gun-ownership-on-gun-homicide-rates.html#random-forest"><i class="fa fa-check"></i><b>14.5.1</b> Random Forest</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="the-effect-of-gun-ownership-on-gun-homicide-rates-using-dml-for-neural-nets.html"><a href="the-effect-of-gun-ownership-on-gun-homicide-rates-using-dml-for-neural-nets.html"><i class="fa fa-check"></i><b>15</b> The Effect of Gun Ownership on Gun-Homicide Rates using DML for neural nets</a>
<ul>
<li class="chapter" data-level="15.1" data-path="the-effect-of-gun-ownership-on-gun-homicide-rates-using-dml-for-neural-nets.html"><a href="the-effect-of-gun-ownership-on-gun-homicide-rates-using-dml-for-neural-nets.html#dml-for-neural-nets"><i class="fa fa-check"></i><b>15.1</b> DML for neural nets</a></li>
<li class="chapter" data-level="15.2" data-path="the-effect-of-gun-ownership-on-gun-homicide-rates-using-dml-for-neural-nets.html"><a href="the-effect-of-gun-ownership-on-gun-homicide-rates-using-dml-for-neural-nets.html#estimating-the-effect-with-dlm-for-neural-nets"><i class="fa fa-check"></i><b>15.2</b> Estimating the effect with DLM for neural nets</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><i class="fa fa-check"></i><b>16</b> Inference on Predictive and Causal Effects in High-Dimensional Nonlinear Models</a>
<ul>
<li class="chapter" data-level="16.1" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#impact-of-401k-on-financial-wealth"><i class="fa fa-check"></i><b>16.1</b> Impact of 401(k) on Financial Wealth</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#data-3"><i class="fa fa-check"></i><b>16.1.1</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#double-ml-package"><i class="fa fa-check"></i><b>16.2</b> Double ML package</a></li>
<li class="chapter" data-level="16.3" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#estimating-the-ate-of-401k-eligibility-on-net-financial-assets"><i class="fa fa-check"></i><b>16.3</b> Estimating the ATE of 401(k) Eligibility on Net Financial Assets</a></li>
<li class="chapter" data-level="16.4" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#partially-linear-regression-models-plr"><i class="fa fa-check"></i><b>16.4</b> Partially Linear Regression Models (PLR)</a></li>
<li class="chapter" data-level="16.5" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#interactive-regression-model-irm"><i class="fa fa-check"></i><b>16.5</b> Interactive Regression Model (IRM)</a></li>
<li class="chapter" data-level="16.6" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#local-average-treatment-effects-of-401k-participation-on-net-financial-assets"><i class="fa fa-check"></i><b>16.6</b> Local Average Treatment Effects of 401(k) Participation on Net Financial Assets</a></li>
<li class="chapter" data-level="16.7" data-path="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html"><a href="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models.html#interactive-iv-model-iivm"><i class="fa fa-check"></i><b>16.7</b> Interactive IV Model (IIVM)</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><i class="fa fa-check"></i><b>17</b> Using Dagitty in the Analysis of Impact of 401(k) on Net Financial Wealth</a>
<ul>
<li class="chapter" data-level="17.1" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#graphs-for-401k-analsyis"><i class="fa fa-check"></i><b>17.1</b> Graphs for 401(K) Analsyis</a></li>
<li class="chapter" data-level="17.2" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#state-one-graph-where-f-determines-x-and-plot-it"><i class="fa fa-check"></i><b>17.2</b> State one graph (where F determines X) and plot it</a></li>
<li class="chapter" data-level="17.3" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#list-minimal-adjustment-sets-to-identify-causal-effecs-d-to-y"><i class="fa fa-check"></i><b>17.3</b> List minimal adjustment sets to identify causal effecs <span class="math inline">\(D \to Y\)</span></a></li>
<li class="chapter" data-level="17.4" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#what-is-the-underlying-principle"><i class="fa fa-check"></i><b>17.4</b> What is the underlying principle?</a></li>
<li class="chapter" data-level="17.5" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#another-graph-wherere-x-determine-f"><i class="fa fa-check"></i><b>17.5</b> Another Graph (wherere <span class="math inline">\(X\)</span> determine <span class="math inline">\(F\)</span>):</a></li>
<li class="chapter" data-level="17.6" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#one-more-graph-encompassing-previous-ones-where-f-x-are-jointly-determined-by-latent-factors-a.-we-can-allow-in-fact-the-whole-triple-d-f-x-to-be-jointly-determined-by-latent-factors-a."><i class="fa fa-check"></i><b>17.6</b> One more graph (encompassing previous ones), where (F, X) are jointly determined by latent factors <span class="math inline">\(A\)</span>. We can allow in fact the whole triple (D, F, X) to be jointly determined by latent factors <span class="math inline">\(A\)</span>.</a></li>
<li class="chapter" data-level="17.7" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#threat-to-idenitification-what-if-f-also-directly-affects-y-note-that-there-are-no-valid-adjustment-sets-in-this-case"><i class="fa fa-check"></i><b>17.7</b> Threat to Idenitification: What if <span class="math inline">\(F\)</span> also directly affects <span class="math inline">\(Y\)</span>? (Note that there are no valid adjustment sets in this case)</a></li>
<li class="chapter" data-level="17.8" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#introduce-match-amount-m-very-important-mediator-why-mediator.-m-is-not-observed.-luckily-adjusting-for-x-still-works-if-there-is-no-f-to-m-arrow."><i class="fa fa-check"></i><b>17.8</b> Introduce Match Amount <span class="math inline">\(M\)</span> (very important mediator, why mediator?). <span class="math inline">\(M\)</span> is not observed. Luckily adjusting for <span class="math inline">\(X\)</span> still works if there is no <span class="math inline">\(F \to M\)</span> arrow.</a></li>
<li class="chapter" data-level="17.9" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#if-there-is-f-to-m-arrow-then-adjusting-for-x-is-not-sufficient."><i class="fa fa-check"></i><b>17.9</b> If there is <span class="math inline">\(F \to M\)</span> arrow, then adjusting for <span class="math inline">\(X\)</span> is not sufficient.</a></li>
<li class="chapter" data-level="17.10" data-path="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html"><a href="using-dagitty-in-the-analysis-of-impact-of-401k-on-net-financial-wealth.html#question"><i class="fa fa-check"></i><b>17.10</b> Question:</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="doubledebiased-machine-learning-for-the-partially-linear-regression-model..html"><a href="doubledebiased-machine-learning-for-the-partially-linear-regression-model..html"><i class="fa fa-check"></i><b>18</b> Double/Debiased Machine Learning for the Partially Linear Regression Model.</a>
<ul>
<li class="chapter" data-level="18.1" data-path="doubledebiased-machine-learning-for-the-partially-linear-regression-model..html"><a href="doubledebiased-machine-learning-for-the-partially-linear-regression-model..html#dml-algorithm-1"><i class="fa fa-check"></i><b>18.1</b> DML algorithm</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><i class="fa fa-check"></i><b>19</b> Sensititivy Analysis for Unobserved Confounder with DML and Sensmakr</a>
<ul>
<li class="chapter" data-level="19.1" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html#here-we-experiment-with-using-package-sensemakr-in-conjunction-with-debiased-ml"><i class="fa fa-check"></i><b>19.1</b> Here we experiment with using package “sensemakr” in conjunction with debiased ML</a></li>
<li class="chapter" data-level="19.2" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html#we-will-work-on"><i class="fa fa-check"></i><b>19.2</b> We will work on:</a></li>
<li class="chapter" data-level="19.3" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html#take-out-village-fixed-effects-and-run-basic-linear-analysis"><i class="fa fa-check"></i><b>19.3</b> Take out village fixed effects and run basic linear analysis</a></li>
<li class="chapter" data-level="19.4" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html#we-first-use-lasso-for-partilling-out-controls"><i class="fa fa-check"></i><b>19.4</b> We first use Lasso for Partilling Out Controls</a></li>
<li class="chapter" data-level="19.5" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html#manual-bias-analysis"><i class="fa fa-check"></i><b>19.5</b> Manual Bias Analysis</a></li>
<li class="chapter" data-level="19.6" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html#bias-analysis-with-sensemakr"><i class="fa fa-check"></i><b>19.6</b> Bias Analysis with Sensemakr</a></li>
<li class="chapter" data-level="19.7" data-path="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html"><a href="sensititivy-analysis-for-unobserved-confounder-with-dml-and-sensmakr.html#next-we-use-random-forest-as-ml-tool-for-partialling-out"><i class="fa fa-check"></i><b>19.7</b> Next We use Random Forest as ML tool for Partialling Out</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html"><i class="fa fa-check"></i><b>20</b> Double/Debiased ML for Partially Linear IV Model</a>
<ul>
<li class="chapter" data-level="20.1" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html#partially-linear-iv-model"><i class="fa fa-check"></i><b>20.1</b> Partially Linear IV Model</a></li>
<li class="chapter" data-level="20.2" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html#example"><i class="fa fa-check"></i><b>20.2</b> Example</a></li>
<li class="chapter" data-level="20.3" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html#plivm-in-residualized-form"><i class="fa fa-check"></i><b>20.3</b> PLIVM in Residualized Form</a></li>
<li class="chapter" data-level="20.4" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html#dml-for-pliv-model"><i class="fa fa-check"></i><b>20.4</b> DML for PLIV Model</a></li>
<li class="chapter" data-level="20.5" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html#emprical-example-acemoglu-jonsohn-robinson-aer."><i class="fa fa-check"></i><b>20.5</b> Emprical Example: Acemoglu, Jonsohn, Robinson (AER).</a></li>
<li class="chapter" data-level="20.6" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html#examine-if-we-have-weak-instruments"><i class="fa fa-check"></i><b>20.6</b> Examine if we have weak instruments</a></li>
<li class="chapter" data-level="20.7" data-path="doubledebiased-ml-for-partially-linear-iv-model.html"><a href="doubledebiased-ml-for-partially-linear-iv-model.html#we-do-have-weak-instruments-because-t-stats-in-regression-tilde-d-sim-tilde-z-are-less-than-4-in-absolute-value"><i class="fa fa-check"></i><b>20.7</b> We do have weak instruments, because t-stats in regression <span class="math inline">\(\tilde D \sim \tilde Z\)</span> are less than 4 in absolute value</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html"><a href="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html"><i class="fa fa-check"></i><b>21</b> A Simple Example of Properties of IV estimator when Instruments are Weak</a>
<ul>
<li class="chapter" data-level="21.1" data-path="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html"><a href="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html#run-1000-trials-to-evaluate-distribution-of-the-iv-estimator"><i class="fa fa-check"></i><b>21.1</b> Run 1000 trials to evaluate distribution of the IV estimator</a></li>
<li class="chapter" data-level="21.2" data-path="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html"><a href="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html#plot-the-actual-distribution-against-the-normal-approximation-based-on-strong-instrument-assumption"><i class="fa fa-check"></i><b>21.2</b> Plot the Actual Distribution against the Normal Approximation (based on Strong Instrument Assumption)</a></li>
<li class="chapter" data-level="21.3" data-path="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html"><a href="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html#some-help-functions"><i class="fa fa-check"></i><b>21.3</b> Some Help Functions</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="hte-i-binary-treatment.html"><a href="hte-i-binary-treatment.html"><i class="fa fa-check"></i><b>22</b> HTE I: Binary treatment</a>
<ul>
<li class="chapter" data-level="22.1" data-path="hte-i-binary-treatment.html"><a href="hte-i-binary-treatment.html#pre-specified-hypotheses"><i class="fa fa-check"></i><b>22.1</b> Pre-specified hypotheses</a></li>
<li class="chapter" data-level="22.2" data-path="hte-i-binary-treatment.html"><a href="hte-i-binary-treatment.html#data-driven-hypotheses"><i class="fa fa-check"></i><b>22.2</b> Data-driven hypotheses</a>
<ul>
<li class="chapter" data-level="22.2.1" data-path="hte-i-binary-treatment.html"><a href="hte-i-binary-treatment.html#via-causal-trees"><i class="fa fa-check"></i><b>22.2.1</b> Via causal trees</a></li>
<li class="chapter" data-level="22.2.2" data-path="hte-i-binary-treatment.html"><a href="hte-i-binary-treatment.html#via-grf"><i class="fa fa-check"></i><b>22.2.2</b> Via grf</a></li>
</ul></li>
<li class="chapter" data-level="22.3" data-path="hte-i-binary-treatment.html"><a href="hte-i-binary-treatment.html#further-reading"><i class="fa fa-check"></i><b>22.3</b> Further reading</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Machine Learning and Causal Inference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hte-i-binary-treatment" class="section level1" number="22">
<h1><span class="header-section-number">Chapter 22</span> HTE I: Binary treatment</h1>
<p>Source RMD file: <a href="https://docs.google.com/uc?export=download&amp;id=1FSUi4WLfYYKnvWsNWypiQORhkqf5IlFP">link</a></p>
<p>In the previous chapter, we learned how to estimate the effect of a binary treatment averaged over the entire population. However, the average may obscure important details about how different individuals react to the treatment. In this chapter, we will learn how to estimate the <strong>conditional average treatment effect (CATE)</strong>,
<span class="math display" id="eq:cate">\[\begin{equation}
  \tag{22.1}
  \tau(x) := \mathop{\mathrm{E}}[Y_i(1) - Y_i(0) | X_i = x],
\end{equation}\]</span>
which is a “localized” version of the average treatment effect conditional on a vector of observable characteristics.</p>
<p>It’s often the case that <a href="hte-i-binary-treatment.html#eq:cate">(22.1)</a> is too general to be immediately useful, especially when the observable covariates are high-dimensional. It can be hard to estimate reliably without making strong modeling assumptions, and hard to summarize in a useful manner after estimation. In such situations, we will instead try to estimate treatment effect averages for simpler groups
<span class="math display" id="eq:cate-g">\[\begin{equation}
  \tag{22.2}
  \mathop{\mathrm{E}}[Y_i(1) - Y_i(0) | G_i = g],
\end{equation}\]</span>
where <span class="math inline">\(G_i\)</span> indexes subgroups of interest. Below you’ll learn how to estimate and test hypotheses about pre-defined subgroups, and also how to discover subgroups of interest from the data. In this tutorial, you will learn how to use estimates of <a href="hte-i-binary-treatment.html#eq:cate">(22.1)</a> to suggest relevant subgroups <span class="math inline">\(G_i\)</span> (and in the next chapters you will find out other uses of <a href="hte-i-binary-treatment.html#eq:cate">(22.1)</a> in policy learning and evaluation).</p>
<p>We’ll continue using the abridged version of the General Social Survey (GSS) <a href="https://gss.norc.org/Documents/reports/project-reports/GSSProject%20report32.pdf">(Smith, 2016)</a> dataset that was introduced in the previous chapter. In this dataset, individuals were sent to treatment or control with equal probability, so we are in a randomized setting. However, many of the techniques and code shown below should also work in an observational setting provided that unconfoundedness and overlap are satisfied (these assumptions were defined in the previous chapter).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="hte-i-binary-treatment.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The causalTree package is not in CRAN, the most common R repository.</span></span>
<span id="cb1-2"><a href="hte-i-binary-treatment.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># To install it, uncomment the next lines as appropriate.</span></span>
<span id="cb1-3"><a href="hte-i-binary-treatment.html#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;devtools&quot;)  # if you don&#39;t have this installed yet.</span></span>
<span id="cb1-4"><a href="hte-i-binary-treatment.html#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github(&#39;susanathey/causalTree&#39;) </span></span>
<span id="cb1-5"><a href="hte-i-binary-treatment.html#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(causalTree)</span>
<span id="cb1-6"><a href="hte-i-binary-treatment.html#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="hte-i-binary-treatment.html#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># use e.g., install.packages(&quot;grf&quot;) to install any of the following packages.</span></span>
<span id="cb1-8"><a href="hte-i-binary-treatment.html#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grf)</span>
<span id="cb1-9"><a href="hte-i-binary-treatment.html#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb1-10"><a href="hte-i-binary-treatment.html#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-11"><a href="hte-i-binary-treatment.html#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb1-12"><a href="hte-i-binary-treatment.html#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-13"><a href="hte-i-binary-treatment.html#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-14"><a href="hte-i-binary-treatment.html#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
<p>As with other chapters in this tutorial, the code below should still work by replacing the next snippet of code with a different dataset, provided that you update the key variables <code>treatment</code>, <code>outcome</code>, and <code>covariates</code> below. Also, please make sure to read the comments as they may be subtle differences depending on whether your dataset was created in a randomized or observational setting.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="hte-i-binary-treatment.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data</span></span>
<span id="cb2-2"><a href="hte-i-binary-treatment.html#cb2-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://docs.google.com/uc?id=1kSxrVci_EUcSr_Lg1JKk1l7Xd5I9zfRC&amp;export=download&quot;</span>)</span>
<span id="cb2-3"><a href="hte-i-binary-treatment.html#cb2-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb2-4"><a href="hte-i-binary-treatment.html#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="hte-i-binary-treatment.html#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment: does the the gov&#39;t spend too much on &quot;welfare&quot; (1) or &quot;assistance to the poor&quot; (0)</span></span>
<span id="cb2-6"><a href="hte-i-binary-treatment.html#cb2-6" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="st">&quot;w&quot;</span></span>
<span id="cb2-7"><a href="hte-i-binary-treatment.html#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="hte-i-binary-treatment.html#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome: 1 for &#39;yes&#39;, 0 for &#39;no&#39;</span></span>
<span id="cb2-9"><a href="hte-i-binary-treatment.html#cb2-9" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">&lt;-</span> <span class="st">&quot;y&quot;</span></span>
<span id="cb2-10"><a href="hte-i-binary-treatment.html#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="hte-i-binary-treatment.html#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional covariates</span></span>
<span id="cb2-12"><a href="hte-i-binary-treatment.html#cb2-12" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;polviews&quot;</span>, <span class="st">&quot;income&quot;</span>, <span class="st">&quot;educ&quot;</span>, <span class="st">&quot;marital&quot;</span>, <span class="st">&quot;sex&quot;</span>)</span></code></pre></div>
<div id="pre-specified-hypotheses" class="section level2" number="22.1">
<h2><span class="header-section-number">22.1</span> Pre-specified hypotheses</h2>
<p>We will begin by learning how to test pre-specified null hypotheses of the form
<span class="math display" id="eq:hte-hyp">\[\begin{equation}
  \tag{22.3}
  H_{0}: \mathop{\mathrm{E}}[Y(1) - Y(0) | G_i = 1] = \mathop{\mathrm{E}}[Y(1) - Y(0) | G_i = 0].
\end{equation}\]</span></p>
<p>That is, that the treatment effect is the same regardless of membership to some group
<span class="math inline">\(G_i\)</span>. Importantly, for now we’ll assume that the group <span class="math inline">\(G_i\)</span> was <strong>pre-specified</strong> – it was decided <em>before</em> looking at the data.</p>
<p>In a randomized setting, if the both the treatment <span class="math inline">\(W_i\)</span> and group membership <span class="math inline">\(G_i\)</span> are binary, we can write
<span class="math display" id="eq:linear">\[\begin{equation}
  \tag{22.4}
  \mathop{\mathrm{E}}[Y_i(W_i)|G_i] = \mathop{\mathrm{E}}[Y_i|W_i, G_i] = \beta_0 + \beta_w W_i + \beta_g G_i + \beta_{wg} W_i G_i
\end{equation}\]</span></p>
<p><font size=1>
When <span class="math inline">\(W_i\)</span> and <span class="math inline">\(G_i\)</span> are binary, this decomposition is true without loss of generality. Why?
</font></p>
<p>This allows us to write the average effects of <span class="math inline">\(W_i\)</span> and <span class="math inline">\(G_i\)</span> on <span class="math inline">\(Y_i\)</span> as
<span class="math display" id="eq:decomp">\[\begin{equation}
  \tag{22.5}
  \begin{aligned}
    \mathop{\mathrm{E}}[Y(1) | G_i=1] &amp;= \beta_0 + \beta_w W_i + \beta_g G_i + \beta_{wg} W_i G_i, \\
    \mathop{\mathrm{E}}[Y(1) | G_i=0] &amp;= \beta_0 + \beta_w W_i,  \\
    \mathop{\mathrm{E}}[Y(0) | G_i=1] &amp;= \beta_0 + \beta_g G_i,  \\
    \mathop{\mathrm{E}}[Y(0) | G_i=0] &amp;= \beta_0.
  \end{aligned}
\end{equation}\]</span></p>
<p>Rewriting the null hypothesis <a href="hte-i-binary-treatment.html#eq:hte-hyp">(22.3)</a> in terms of the decomposition <a href="hte-i-binary-treatment.html#eq:decomp">(22.5)</a>, we see that it boils down to a test about the coefficient in the interaction: <span class="math inline">\(\beta_{xw} = 0\)</span>. Here’s an example that tests whether the treatment effect is the same for “conservative” (<code>polviews</code> &lt; 4) and “liberal” (<code>polviews</code> <span class="math inline">\(\geq\)</span> 4) individuals.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="hte-i-binary-treatment.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only valid in randomized settings</span></span>
<span id="cb3-2"><a href="hte-i-binary-treatment.html#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="hte-i-binary-treatment.html#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppose this his group was defined prior to collecting the data</span></span>
<span id="cb3-4"><a href="hte-i-binary-treatment.html#cb3-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>conservative <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>polviews <span class="sc">&lt;</span> <span class="dv">4</span>)  <span class="co"># a binary group</span></span>
<span id="cb3-5"><a href="hte-i-binary-treatment.html#cb3-5" aria-hidden="true" tabindex="-1"></a>group <span class="ot">&lt;-</span> <span class="st">&#39;conservative&#39;</span></span>
<span id="cb3-6"><a href="hte-i-binary-treatment.html#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="hte-i-binary-treatment.html#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Recall from last chapter -- this is equivalent to running a t-test</span></span>
<span id="cb3-8"><a href="hte-i-binary-treatment.html#cb3-8" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste</span>(outcome, <span class="st">&#39; ~ &#39;</span>, treatment, <span class="st">&#39;*&#39;</span>, group))</span>
<span id="cb3-9"><a href="hte-i-binary-treatment.html#cb3-9" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span>data)</span>
<span id="cb3-10"><a href="hte-i-binary-treatment.html#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="at">type=</span><span class="st">&#39;HC2&#39;</span>))</span></code></pre></div>
<pre><code>## 
## t test of coefficients:
## 
##                      Estimate Std. Error t value  Pr(&gt;|t|)    
## (Intercept)         0.4836473  0.0050842  95.127 &lt; 2.2e-16 ***
## w                  -0.3789182  0.0058604 -64.657 &lt; 2.2e-16 ***
## conservativeTRUE   -0.1590214  0.0092479 -17.195 &lt; 2.2e-16 ***
## w:conservativeTRUE  0.1160034  0.0103710  11.185 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><font size=1>
Interpret the results above. The coefficient <span class="math inline">\(\beta_{xw}\)</span> is denoted by <code>w:conservativeTRUE</code>. Can we detect a difference in treatment effect for conservative vs liberal individuals? For whom is the effect larger?
</font></p>
<p>Sometimes there are many subgroups, leading to multiple hypotheses such as
<span class="math display" id="eq:mult-hyp">\[\begin{equation}
\tag{22.6}
H_0: \mathop{\mathrm{E}}[Y(1) - Y(0) \ | \  G_i = 1] = \mathop{\mathrm{E}}[Y(1) - Y(0) \ | \  G_i = g]
\qquad
\text{for many values of }g.
\end{equation}\]</span></p>
<p>In that case, we need to correct for the fact that we are testing for multiple hypotheses, or we will end up with many false positives. The <strong>Bonferroni correction</strong> <a href="https://en.wikipedia.org/wiki/Bonferroni_correction">(wiki)</a> is a common method for dealing with multiple hypothesis testing, though it is often too conservative to be useful. It is available via the function <code>p.adjust</code> from base <code>R</code>. The next snippet of code tests whether the treatment effect at each level of <code>polviews</code> is different from the treatment effect from <code>polviews</code> equals one.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="hte-i-binary-treatment.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only valid in randomized setting.</span></span>
<span id="cb5-2"><a href="hte-i-binary-treatment.html#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="hte-i-binary-treatment.html#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: these groups must be defined prior to collecting the data.</span></span>
<span id="cb5-4"><a href="hte-i-binary-treatment.html#cb5-4" aria-hidden="true" tabindex="-1"></a>group <span class="ot">&lt;-</span> <span class="st">&#39;polviews&#39;</span></span>
<span id="cb5-5"><a href="hte-i-binary-treatment.html#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="hte-i-binary-treatment.html#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear regression.</span></span>
<span id="cb5-7"><a href="hte-i-binary-treatment.html#cb5-7" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste</span>(outcome, <span class="st">&#39; ~ &#39;</span>, treatment, <span class="st">&#39;*&#39;</span>, <span class="st">&#39;factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb5-8"><a href="hte-i-binary-treatment.html#cb5-8" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span>data)</span>
<span id="cb5-9"><a href="hte-i-binary-treatment.html#cb5-9" aria-hidden="true" tabindex="-1"></a>ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="at">type=</span><span class="st">&#39;HC2&#39;</span>))</span>
<span id="cb5-10"><a href="hte-i-binary-treatment.html#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="hte-i-binary-treatment.html#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve the interaction coefficients</span></span>
<span id="cb5-12"><a href="hte-i-binary-treatment.html#cb5-12" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="st">&quot;w:&quot;</span>, x)))</span>
<span id="cb5-13"><a href="hte-i-binary-treatment.html#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="hte-i-binary-treatment.html#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve unadjusted p-values and </span></span>
<span id="cb5-15"><a href="hte-i-binary-treatment.html#cb5-15" aria-hidden="true" tabindex="-1"></a>unadj.p.value <span class="ot">&lt;-</span> ols.res[interact, <span class="dv">4</span>]</span>
<span id="cb5-16"><a href="hte-i-binary-treatment.html#cb5-16" aria-hidden="true" tabindex="-1"></a>adj.p.value <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(unadj.p.value, <span class="at">method=</span><span class="st">&#39;bonferroni&#39;</span>)</span>
<span id="cb5-17"><a href="hte-i-binary-treatment.html#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="hte-i-binary-treatment.html#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">estimate=</span><span class="fu">coef</span>(ols)[interact], <span class="at">std.err=</span>ols.res[interact,<span class="dv">2</span>], unadj.p.value, adj.p.value)</span></code></pre></div>
<pre><code>##                        estimate    std.err unadj.p.value  adj.p.value
## w:factor(polviews)2 -0.02424199 0.02733714  3.752056e-01 1.000000e+00
## w:factor(polviews)3 -0.05962335 0.02735735  2.930808e-02 1.758485e-01
## w:factor(polviews)4 -0.13461439 0.02534022  1.090684e-07 6.544105e-07
## w:factor(polviews)5 -0.16491540 0.02713505  1.235505e-09 7.413027e-09
## w:factor(polviews)6 -0.18007875 0.02751422  6.052625e-11 3.631575e-10
## w:factor(polviews)7 -0.18618443 0.03870554  1.514861e-06 9.089164e-06</code></pre>
<p>Another option is to use the <strong>Romano-Wolf</strong> correction, based on <a href="https://www.ssc.wisc.edu/~bhansen/718/RomanoWolf2005.pdf">Romano and Wolf (2005, Econometrica)</a>. This bootstrap-based procedure takes into account the underlying dependence structure of the test statistics in a way that improves power. The Romano-Wolf procedure is correct under minimal assumptions, and should be favored over Bonferroni in general.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="hte-i-binary-treatment.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Auxiliary function to computes adjusted p-values </span></span>
<span id="cb7-2"><a href="hte-i-binary-treatment.html#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># following the Romano-Wolf method.</span></span>
<span id="cb7-3"><a href="hte-i-binary-treatment.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># For a reference, see http://ftp.iza.org/dp12845.pdf page 8</span></span>
<span id="cb7-4"><a href="hte-i-binary-treatment.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  t.orig: vector of t-statistics from original model</span></span>
<span id="cb7-5"><a href="hte-i-binary-treatment.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  t.boot: matrix of t-statistics from bootstrapped models</span></span>
<span id="cb7-6"><a href="hte-i-binary-treatment.html#cb7-6" aria-hidden="true" tabindex="-1"></a>romano_wolf_correction <span class="ot">&lt;-</span> <span class="cf">function</span>(t.orig, t.boot) {</span>
<span id="cb7-7"><a href="hte-i-binary-treatment.html#cb7-7" aria-hidden="true" tabindex="-1"></a>  abs.t.orig <span class="ot">&lt;-</span> <span class="fu">abs</span>(t.orig)</span>
<span id="cb7-8"><a href="hte-i-binary-treatment.html#cb7-8" aria-hidden="true" tabindex="-1"></a>  abs.t.boot <span class="ot">&lt;-</span> <span class="fu">abs</span>(t.boot)</span>
<span id="cb7-9"><a href="hte-i-binary-treatment.html#cb7-9" aria-hidden="true" tabindex="-1"></a>  abs.t.sorted <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs.t.orig, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-10"><a href="hte-i-binary-treatment.html#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="hte-i-binary-treatment.html#cb7-11" aria-hidden="true" tabindex="-1"></a>  max.order <span class="ot">&lt;-</span> <span class="fu">order</span>(abs.t.orig, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-12"><a href="hte-i-binary-treatment.html#cb7-12" aria-hidden="true" tabindex="-1"></a>  rev.order <span class="ot">&lt;-</span> <span class="fu">order</span>(max.order)</span>
<span id="cb7-13"><a href="hte-i-binary-treatment.html#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="hte-i-binary-treatment.html#cb7-14" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">nrow</span>(t.boot)</span>
<span id="cb7-15"><a href="hte-i-binary-treatment.html#cb7-15" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">ncol</span>(t.boot)</span>
<span id="cb7-16"><a href="hte-i-binary-treatment.html#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="hte-i-binary-treatment.html#cb7-17" aria-hidden="true" tabindex="-1"></a>  p.adj <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S)</span>
<span id="cb7-18"><a href="hte-i-binary-treatment.html#cb7-18" aria-hidden="true" tabindex="-1"></a>  p.adj[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">apply</span>(abs.t.boot, <span class="dv">1</span>, max) <span class="sc">&gt;</span> abs.t.sorted[<span class="dv">1</span>])</span>
<span id="cb7-19"><a href="hte-i-binary-treatment.html#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>, S)) {</span>
<span id="cb7-20"><a href="hte-i-binary-treatment.html#cb7-20" aria-hidden="true" tabindex="-1"></a>    cur.index <span class="ot">&lt;-</span> max.order[s<span class="sc">:</span>S]</span>
<span id="cb7-21"><a href="hte-i-binary-treatment.html#cb7-21" aria-hidden="true" tabindex="-1"></a>    p.init <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">apply</span>(abs.t.boot[, cur.index, <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="dv">1</span>, max) <span class="sc">&gt;</span> abs.t.sorted[s])</span>
<span id="cb7-22"><a href="hte-i-binary-treatment.html#cb7-22" aria-hidden="true" tabindex="-1"></a>    p.adj[s] <span class="ot">&lt;-</span> <span class="fu">max</span>(p.init, p.adj[s<span class="dv">-1</span>])</span>
<span id="cb7-23"><a href="hte-i-binary-treatment.html#cb7-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-24"><a href="hte-i-binary-treatment.html#cb7-24" aria-hidden="true" tabindex="-1"></a>  p.adj[rev.order]</span>
<span id="cb7-25"><a href="hte-i-binary-treatment.html#cb7-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-26"><a href="hte-i-binary-treatment.html#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="hte-i-binary-treatment.html#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Computes adjusted p-values for linear regression (lm) models.</span></span>
<span id="cb7-28"><a href="hte-i-binary-treatment.html#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co">#    model: object of lm class (i.e., a linear reg model)</span></span>
<span id="cb7-29"><a href="hte-i-binary-treatment.html#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co">#    indices: vector of integers for the coefficients that will be tested</span></span>
<span id="cb7-30"><a href="hte-i-binary-treatment.html#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co">#    cov.type: type of standard error (to be passed to sandwich::vcovHC)</span></span>
<span id="cb7-31"><a href="hte-i-binary-treatment.html#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co">#    num.boot: number of null bootstrap samples. Increase to stabilize across runs.</span></span>
<span id="cb7-32"><a href="hte-i-binary-treatment.html#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: results are probabilitistic and may change slightly at every run. </span></span>
<span id="cb7-33"><a href="hte-i-binary-treatment.html#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-34"><a href="hte-i-binary-treatment.html#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Adapted from the p_adjust from from the hdm package, written by Philipp Bach.</span></span>
<span id="cb7-35"><a href="hte-i-binary-treatment.html#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/PhilippBach/hdm_prev/blob/master/R/p_adjust.R</span></span>
<span id="cb7-36"><a href="hte-i-binary-treatment.html#cb7-36" aria-hidden="true" tabindex="-1"></a>summary_rw_lm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, <span class="at">indices=</span><span class="cn">NULL</span>, <span class="at">cov.type=</span><span class="st">&quot;HC2&quot;</span>, <span class="at">num.boot=</span><span class="dv">10000</span>) {</span>
<span id="cb7-37"><a href="hte-i-binary-treatment.html#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="hte-i-binary-treatment.html#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(indices)) {</span>
<span id="cb7-39"><a href="hte-i-binary-treatment.html#cb7-39" aria-hidden="true" tabindex="-1"></a>    indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(<span class="fu">coef</span>(<span class="fu">summary</span>(model)))</span>
<span id="cb7-40"><a href="hte-i-binary-treatment.html#cb7-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-41"><a href="hte-i-binary-treatment.html#cb7-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Grab the original t values.</span></span>
<span id="cb7-42"><a href="hte-i-binary-treatment.html#cb7-42" aria-hidden="true" tabindex="-1"></a>  summary <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(model))[indices,,drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb7-43"><a href="hte-i-binary-treatment.html#cb7-43" aria-hidden="true" tabindex="-1"></a>  t.orig <span class="ot">&lt;-</span> summary[, <span class="st">&quot;t value&quot;</span>]</span>
<span id="cb7-44"><a href="hte-i-binary-treatment.html#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="hte-i-binary-treatment.html#cb7-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Null resampling.</span></span>
<span id="cb7-46"><a href="hte-i-binary-treatment.html#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is a trick to speed up bootstrapping linear models.</span></span>
<span id="cb7-47"><a href="hte-i-binary-treatment.html#cb7-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here, we don&#39;t really need to re-fit linear regressions, which would be a bit slow.</span></span>
<span id="cb7-48"><a href="hte-i-binary-treatment.html#cb7-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We know that betahat ~ N(beta, Sigma), and we have an estimate Sigmahat.</span></span>
<span id="cb7-49"><a href="hte-i-binary-treatment.html#cb7-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So we can approximate &quot;null t-values&quot; by</span></span>
<span id="cb7-50"><a href="hte-i-binary-treatment.html#cb7-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  - Draw beta.boot ~ N(0, Sigma-hat) --- note the 0 here, this is what makes it a *null* t-value.</span></span>
<span id="cb7-51"><a href="hte-i-binary-treatment.html#cb7-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  - Compute t.boot = beta.boot / sqrt(diag(Sigma.hat))</span></span>
<span id="cb7-52"><a href="hte-i-binary-treatment.html#cb7-52" aria-hidden="true" tabindex="-1"></a>  Sigma.hat <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(model, <span class="at">type=</span>cov.type)[indices, indices]</span>
<span id="cb7-53"><a href="hte-i-binary-treatment.html#cb7-53" aria-hidden="true" tabindex="-1"></a>  se.orig <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(Sigma.hat))</span>
<span id="cb7-54"><a href="hte-i-binary-treatment.html#cb7-54" aria-hidden="true" tabindex="-1"></a>  num.coef <span class="ot">&lt;-</span> <span class="fu">length</span>(se.orig)</span>
<span id="cb7-55"><a href="hte-i-binary-treatment.html#cb7-55" aria-hidden="true" tabindex="-1"></a>  beta.boot <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="at">n=</span>num.boot, <span class="at">mu=</span><span class="fu">rep</span>(<span class="dv">0</span>, num.coef), <span class="at">Sigma=</span>Sigma.hat)</span>
<span id="cb7-56"><a href="hte-i-binary-treatment.html#cb7-56" aria-hidden="true" tabindex="-1"></a>  t.boot <span class="ot">&lt;-</span> <span class="fu">sweep</span>(beta.boot, <span class="dv">2</span>, se.orig, <span class="st">&quot;/&quot;</span>)</span>
<span id="cb7-57"><a href="hte-i-binary-treatment.html#cb7-57" aria-hidden="true" tabindex="-1"></a>  p.adj <span class="ot">&lt;-</span> <span class="fu">romano_wolf_correction</span>(t.orig, t.boot)</span>
<span id="cb7-58"><a href="hte-i-binary-treatment.html#cb7-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-59"><a href="hte-i-binary-treatment.html#cb7-59" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">cbind</span>(summary[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>),<span class="at">drop=</span>F], p.adj)</span>
<span id="cb7-60"><a href="hte-i-binary-treatment.html#cb7-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(result) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Estimate&#39;</span>, <span class="st">&#39;Std. Error&#39;</span>, <span class="st">&#39;Orig. p-value&#39;</span>, <span class="st">&#39;Adj. p-value&#39;</span>)</span>
<span id="cb7-61"><a href="hte-i-binary-treatment.html#cb7-61" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb7-62"><a href="hte-i-binary-treatment.html#cb7-62" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="hte-i-binary-treatment.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This linear regression is only valid in a randomized setting.</span></span>
<span id="cb8-2"><a href="hte-i-binary-treatment.html#cb8-2" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste</span>(outcome, <span class="st">&#39; ~ &#39;</span>, treatment, <span class="st">&#39;*&#39;</span>, <span class="st">&#39;factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb8-3"><a href="hte-i-binary-treatment.html#cb8-3" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span>data)</span>
<span id="cb8-4"><a href="hte-i-binary-treatment.html#cb8-4" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="fu">paste0</span>(treatment, <span class="st">&quot;:&quot;</span>), x)))</span>
<span id="cb8-5"><a href="hte-i-binary-treatment.html#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="hte-i-binary-treatment.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying the romano-wolf correction.</span></span>
<span id="cb8-7"><a href="hte-i-binary-treatment.html#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>interact)</span></code></pre></div>
<pre><code>##                        Estimate Std. Error Orig. p-value Adj. p-value
## w:factor(polviews)2 -0.02424199 0.03034779  4.244098e-01       0.4271
## w:factor(polviews)3 -0.05962335 0.03015010  4.798896e-02       0.0768
## w:factor(polviews)4 -0.13461439 0.02822807  1.862258e-06       0.0000
## w:factor(polviews)5 -0.16491540 0.02957511  2.481093e-08       0.0000
## w:factor(polviews)6 -0.18007875 0.02966030  1.284150e-09       0.0000
## w:factor(polviews)7 -0.18618443 0.03790379  9.063658e-07       0.0000</code></pre>
<p><font size=1>
Compare the adjusted p-values under Romano-Wolf with those obtained via Bonferroni above.
</font></p>
<p>The Bonferroni and Romano-Wolf methods control the <strong>familywise error rate (FWER)</strong>, which is the (asymptotic) probability of rejecting even one true null hypothesis. In other words, for a significance level <span class="math inline">\(\alpha\)</span>, they guarantee that with probability <span class="math inline">\(1 - \alpha\)</span> we will make zero false discoveries. However, when the number of hypotheses being tested is very large, this criterion may be so stringent that it prevents us from being able to detect real effects. Instead, there exist alternative procedures that control the (asymptotic) <strong>false discovery rate (FDR)</strong>, defined as the expected proportion of true null hypotheses rejected among all hypotheses rejected. One such procedure is the Benjamini-Hochberg procedure, which is available in base R via <code>p.adjust(..., method="BH")</code>. For what remains we’ll stick with FWER control, but keep in mind that FDR control can also useful in exploratory analyses or settings in which there’s a very large number of hypotheses under consideration.</p>
<p>As in the previous chapter, when working with observational data under unconfoundedness and overlap, one can use AIPW scores <span class="math inline">\(\widehat{\Gamma}_i\)</span> in place of the raw outcomes <span class="math inline">\(Y_i\)</span>. In the next snippet, we construct AIPW scores using the <code>causal_forest</code> function from the <code>grf</code> package.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="hte-i-binary-treatment.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid in randomized settings and observational settings with unconfoundedness+overlap.</span></span>
<span id="cb10-2"><a href="hte-i-binary-treatment.html#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="hte-i-binary-treatment.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparing data to fit a causal forest</span></span>
<span id="cb10-4"><a href="hte-i-binary-treatment.html#cb10-4" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~ 0 +&quot;</span>, <span class="fu">paste0</span>(covariates, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb10-5"><a href="hte-i-binary-treatment.html#cb10-5" aria-hidden="true" tabindex="-1"></a>XX <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data)</span>
<span id="cb10-6"><a href="hte-i-binary-treatment.html#cb10-6" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> data[,treatment]</span>
<span id="cb10-7"><a href="hte-i-binary-treatment.html#cb10-7" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,outcome]</span>
<span id="cb10-8"><a href="hte-i-binary-treatment.html#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="hte-i-binary-treatment.html#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment or uncomment as appropriate.</span></span>
<span id="cb10-10"><a href="hte-i-binary-treatment.html#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomized setting with known and fixed probabilities (here: 0.5).</span></span>
<span id="cb10-11"><a href="hte-i-binary-treatment.html#cb10-11" aria-hidden="true" tabindex="-1"></a>forest.tau <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(XX, Y, W, <span class="at">W.hat=</span>.<span class="dv">5</span>) </span>
<span id="cb10-12"><a href="hte-i-binary-treatment.html#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Observational setting with unconf + overlap, unknown assignment probs.</span></span>
<span id="cb10-13"><a href="hte-i-binary-treatment.html#cb10-13" aria-hidden="true" tabindex="-1"></a>forest.tau <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(XX, Y, W) </span>
<span id="cb10-14"><a href="hte-i-binary-treatment.html#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="hte-i-binary-treatment.html#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get forest predictions. </span></span>
<span id="cb10-16"><a href="hte-i-binary-treatment.html#cb10-16" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau)<span class="sc">$</span>predictions </span>
<span id="cb10-17"><a href="hte-i-binary-treatment.html#cb10-17" aria-hidden="true" tabindex="-1"></a>m.hat <span class="ot">&lt;-</span> forest.tau<span class="sc">$</span>Y.hat  <span class="co"># E[Y|X] estimates</span></span>
<span id="cb10-18"><a href="hte-i-binary-treatment.html#cb10-18" aria-hidden="true" tabindex="-1"></a>e.hat <span class="ot">&lt;-</span> forest.tau<span class="sc">$</span>W.hat  <span class="co"># e(X) := E[W|X] estimates (or known quantity)</span></span>
<span id="cb10-19"><a href="hte-i-binary-treatment.html#cb10-19" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> forest.tau<span class="sc">$</span>predictions  <span class="co"># tau(X) estimates</span></span>
<span id="cb10-20"><a href="hte-i-binary-treatment.html#cb10-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-21"><a href="hte-i-binary-treatment.html#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicting mu.hat(X[i], 1) and mu.hat(X[i], 0) for obs in held-out sample</span></span>
<span id="cb10-22"><a href="hte-i-binary-treatment.html#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: to understand this, read equations 6-8 in this vignette</span></span>
<span id="cb10-23"><a href="hte-i-binary-treatment.html#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># https://grf-labs.github.io/grf/articles/muhats.html</span></span>
<span id="cb10-24"><a href="hte-i-binary-treatment.html#cb10-24" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.0</span> <span class="ot">&lt;-</span> m.hat <span class="sc">-</span> e.hat <span class="sc">*</span> tau.hat        <span class="co"># E[Y|X,W=0] = E[Y|X] - e(X)*tau(X)</span></span>
<span id="cb10-25"><a href="hte-i-binary-treatment.html#cb10-25" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.1</span> <span class="ot">&lt;-</span> m.hat <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> tau.hat  <span class="co"># E[Y|X,W=1] = E[Y|X] + (1 - e(X))*tau(X)</span></span>
<span id="cb10-26"><a href="hte-i-binary-treatment.html#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="hte-i-binary-treatment.html#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute AIPW scores</span></span>
<span id="cb10-28"><a href="hte-i-binary-treatment.html#cb10-28" aria-hidden="true" tabindex="-1"></a>aipw.scores <span class="ot">&lt;-</span> tau.hat <span class="sc">+</span> W <span class="sc">/</span> e.hat <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.1</span>) <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> W) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.0</span>)</span>
<span id="cb10-29"><a href="hte-i-binary-treatment.html#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="hte-i-binary-treatment.html#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate average treatment effect conditional on group membership</span></span>
<span id="cb10-31"><a href="hte-i-binary-treatment.html#cb10-31" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&#39;aipw.scores ~ factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb10-32"><a href="hte-i-binary-treatment.html#cb10-32" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">aipw.scores=</span>aipw.scores))</span>
<span id="cb10-33"><a href="hte-i-binary-treatment.html#cb10-33" aria-hidden="true" tabindex="-1"></a>ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb10-34"><a href="hte-i-binary-treatment.html#cb10-34" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols.res)) <span class="sc">!=</span> <span class="st">&#39;(Intercept)&#39;</span>)</span>
<span id="cb10-35"><a href="hte-i-binary-treatment.html#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>indices)</span></code></pre></div>
<pre><code>##                      Estimate Std. Error Orig. p-value Adj. p-value
## factor(polviews)2 -0.02872975 0.03212499  3.711626e-01       0.3737
## factor(polviews)3 -0.07252136 0.03192094  2.309962e-02       0.0359
## factor(polviews)4 -0.14101993 0.02989936  2.410828e-06       0.0000
## factor(polviews)5 -0.17680669 0.03132183  1.668983e-08       0.0000
## factor(polviews)6 -0.18209785 0.03141193  6.818186e-09       0.0000
## factor(polviews)7 -0.19965689 0.04010803  6.462445e-07       0.0000</code></pre>
<p>One can also construct AIPW scores using any other nonparametric method. Here’s how to do it by fitting flexible generalized linear models <code>glmnet</code> and <code>splines</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="hte-i-binary-treatment.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid randomized data and observational data with unconfoundedness+overlap.</span></span>
<span id="cb12-2"><a href="hte-i-binary-treatment.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: read the comments below carefully. </span></span>
<span id="cb12-3"><a href="hte-i-binary-treatment.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># In randomized settings, do not estimate forest.e and e.hat; use known assignment probs.</span></span>
<span id="cb12-4"><a href="hte-i-binary-treatment.html#cb12-4" aria-hidden="true" tabindex="-1"></a>fmla.xw <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;bs(&quot;</span>, covariates, <span class="st">&quot;, df=3, degree=3) *&quot;</span>, treatment, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb12-5"><a href="hte-i-binary-treatment.html#cb12-5" aria-hidden="true" tabindex="-1"></a>fmla.x <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;bs(&quot;</span>, covariates, <span class="st">&quot;, df=3, degree=3)&quot;</span>, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb12-6"><a href="hte-i-binary-treatment.html#cb12-6" aria-hidden="true" tabindex="-1"></a>XW <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.xw, data)</span>
<span id="cb12-7"><a href="hte-i-binary-treatment.html#cb12-7" aria-hidden="true" tabindex="-1"></a>XX <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.x, data)</span>
<span id="cb12-8"><a href="hte-i-binary-treatment.html#cb12-8" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,outcome]</span>
<span id="cb12-9"><a href="hte-i-binary-treatment.html#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="hte-i-binary-treatment.html#cb12-10" aria-hidden="true" tabindex="-1"></a>n.folds <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb12-11"><a href="hte-i-binary-treatment.html#cb12-11" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">seq</span>(n), <span class="fu">sort</span>(<span class="fu">seq</span>(n) <span class="sc">%%</span> n.folds))</span>
<span id="cb12-12"><a href="hte-i-binary-treatment.html#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="hte-i-binary-treatment.html#cb12-13" aria-hidden="true" tabindex="-1"></a>aipw.scores <span class="ot">&lt;-</span> <span class="fu">lapply</span>(indices, <span class="cf">function</span>(idx) {</span>
<span id="cb12-14"><a href="hte-i-binary-treatment.html#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="hte-i-binary-treatment.html#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fitting the outcome model</span></span>
<span id="cb12-16"><a href="hte-i-binary-treatment.html#cb12-16" aria-hidden="true" tabindex="-1"></a>  model.m <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(XW[<span class="sc">-</span>idx,], Y[<span class="sc">-</span>idx])  </span>
<span id="cb12-17"><a href="hte-i-binary-treatment.html#cb12-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-18"><a href="hte-i-binary-treatment.html#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict outcome E[Y|X,W=w] for w in {0, 1}</span></span>
<span id="cb12-19"><a href="hte-i-binary-treatment.html#cb12-19" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.0</span> <span class="ot">&lt;-</span> data</span>
<span id="cb12-20"><a href="hte-i-binary-treatment.html#cb12-20" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.0</span>[,treatment] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-21"><a href="hte-i-binary-treatment.html#cb12-21" aria-hidden="true" tabindex="-1"></a>  XW0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.xw, data<span class="fl">.0</span>)</span>
<span id="cb12-22"><a href="hte-i-binary-treatment.html#cb12-22" aria-hidden="true" tabindex="-1"></a>  mu.hat<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">predict</span>(model.m, XW0, <span class="at">s=</span><span class="st">&quot;lambda.min&quot;</span>)[idx,]</span>
<span id="cb12-23"><a href="hte-i-binary-treatment.html#cb12-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-24"><a href="hte-i-binary-treatment.html#cb12-24" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.1</span> <span class="ot">&lt;-</span> data</span>
<span id="cb12-25"><a href="hte-i-binary-treatment.html#cb12-25" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.1</span>[,treatment] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb12-26"><a href="hte-i-binary-treatment.html#cb12-26" aria-hidden="true" tabindex="-1"></a>  XW1 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.xw, data<span class="fl">.1</span>)</span>
<span id="cb12-27"><a href="hte-i-binary-treatment.html#cb12-27" aria-hidden="true" tabindex="-1"></a>  mu.hat<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">predict</span>(model.m, XW1, <span class="at">s=</span><span class="st">&quot;lambda.min&quot;</span>)[idx,]</span>
<span id="cb12-28"><a href="hte-i-binary-treatment.html#cb12-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-29"><a href="hte-i-binary-treatment.html#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fitting the propensity score model</span></span>
<span id="cb12-30"><a href="hte-i-binary-treatment.html#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Comment / uncomment the lines below as appropriate.</span></span>
<span id="cb12-31"><a href="hte-i-binary-treatment.html#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OBSERVATIONAL SETTING (with unconfoundedness+overlap):</span></span>
<span id="cb12-32"><a href="hte-i-binary-treatment.html#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># model.e &lt;- cv.glmnet(XX[-idx,], W[-idx], family=&quot;binomial&quot;)  </span></span>
<span id="cb12-33"><a href="hte-i-binary-treatment.html#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># e.hat &lt;- predict(model.e, XX[idx,], s=&quot;lambda.min&quot;, type=&quot;response&quot;)</span></span>
<span id="cb12-34"><a href="hte-i-binary-treatment.html#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RANDOMIZED SETTING</span></span>
<span id="cb12-35"><a href="hte-i-binary-treatment.html#cb12-35" aria-hidden="true" tabindex="-1"></a>  e.hat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.5</span>, <span class="fu">length</span>(idx))  </span>
<span id="cb12-36"><a href="hte-i-binary-treatment.html#cb12-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-37"><a href="hte-i-binary-treatment.html#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute CATE estimates</span></span>
<span id="cb12-38"><a href="hte-i-binary-treatment.html#cb12-38" aria-hidden="true" tabindex="-1"></a>  tau.hat <span class="ot">&lt;-</span> mu.hat<span class="fl">.1</span> <span class="sc">-</span> mu.hat<span class="fl">.0</span></span>
<span id="cb12-39"><a href="hte-i-binary-treatment.html#cb12-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-40"><a href="hte-i-binary-treatment.html#cb12-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute AIPW scores</span></span>
<span id="cb12-41"><a href="hte-i-binary-treatment.html#cb12-41" aria-hidden="true" tabindex="-1"></a>  aipw.scores <span class="ot">&lt;-</span> (tau.hat </span>
<span id="cb12-42"><a href="hte-i-binary-treatment.html#cb12-42" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span> W[idx] <span class="sc">/</span> e.hat <span class="sc">*</span> (Y[idx] <span class="sc">-</span>  mu.hat<span class="fl">.1</span>)</span>
<span id="cb12-43"><a href="hte-i-binary-treatment.html#cb12-43" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> W[idx]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> (Y[idx] <span class="sc">-</span>  mu.hat<span class="fl">.0</span>))</span>
<span id="cb12-44"><a href="hte-i-binary-treatment.html#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="hte-i-binary-treatment.html#cb12-45" aria-hidden="true" tabindex="-1"></a>  aipw.scores</span>
<span id="cb12-46"><a href="hte-i-binary-treatment.html#cb12-46" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb12-47"><a href="hte-i-binary-treatment.html#cb12-47" aria-hidden="true" tabindex="-1"></a>aipw.scores<span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">do.call</span>(c, aipw.scores))</span>
<span id="cb12-48"><a href="hte-i-binary-treatment.html#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="hte-i-binary-treatment.html#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate average treatment effect conditional on group membership</span></span>
<span id="cb12-50"><a href="hte-i-binary-treatment.html#cb12-50" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&#39;aipw.scores ~ factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb12-51"><a href="hte-i-binary-treatment.html#cb12-51" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">aipw.scores=</span>aipw.scores))</span>
<span id="cb12-52"><a href="hte-i-binary-treatment.html#cb12-52" aria-hidden="true" tabindex="-1"></a>ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb12-53"><a href="hte-i-binary-treatment.html#cb12-53" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols.res)) <span class="sc">!=</span> <span class="st">&#39;(Intercept)&#39;</span>)</span>
<span id="cb12-54"><a href="hte-i-binary-treatment.html#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>indices)</span></code></pre></div>
<pre><code>##                      Estimate Std. Error Orig. p-value Adj. p-value
## factor(polviews)2 -0.02431188 0.03025159  4.216022e-01       0.4196
## factor(polviews)3 -0.06078026 0.03005945  4.318542e-02       0.0716
## factor(polviews)4 -0.13363032 0.02815576  2.083662e-06       0.0000
## factor(polviews)5 -0.16498404 0.02949527  2.244685e-08       0.0000
## factor(polviews)6 -0.17926620 0.02958012  1.375097e-09       0.0000
## factor(polviews)7 -0.18695392 0.03776909  7.466598e-07       0.0000</code></pre>
</div>
<div id="data-driven-hypotheses" class="section level2" number="22.2">
<h2><span class="header-section-number">22.2</span> Data-driven hypotheses</h2>
<p>Pre-specifying hypotheses prior to looking at the data is in general good practice to avoid “p-hacking” (e.g., slicing the data into different subgroups until a significant result is found). However, valid tests can also be attained if by <strong>sample splitting</strong>: we can use a subset of the sample to find promising subgroups, then test hypotheses about these subgroups in the remaining sample. This kind of sample splitting for hypothesis testing is called <strong>honesty</strong>.</p>
<div id="via-causal-trees" class="section level3" number="22.2.1">
<h3><span class="header-section-number">22.2.1</span> Via causal trees</h3>
<p><strong>Causal trees</strong> <a href="PNAS,%202016">(Athey and Imbens)</a>](<a href="https://www.pnas.org/content/pnas/113/27/7353.full.pdf" class="uri">https://www.pnas.org/content/pnas/113/27/7353.full.pdf</a>) are an intuitive algorithm that is available in the randomized setting to discover subgroups with different treatment effects.</p>
<p>At a high level, the idea is to divide the sample into three subsets (not necessarily of equal size). The <code>splitting</code> subset is used to fit a decision tree whose objective is modified to maximize heterogeneity in treatment effect estimates across leaves. The <code>estimation</code> subset is then used to produce a valid estimate of the treatment effect at each leaf of the fitted tree. Finally, a <code>test</code> subset can be used to validate the tree estimates.</p>
<p>The next snippet uses <code>honest.causalTree</code> function from the <a href="https://github.com/susanathey/causalTree"><code>causalTree</code></a> package. For more details, see the <a href="https://github.com/susanathey/causalTree/blob/master/briefintro.pdf">causalTree documentation</a>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="hte-i-binary-treatment.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only valid for randomized data!</span></span>
<span id="cb14-2"><a href="hte-i-binary-treatment.html#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="hte-i-binary-treatment.html#cb14-3" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste</span>(outcome, <span class="st">&quot; ~&quot;</span>, <span class="fu">paste</span>(covariates, <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>))</span>
<span id="cb14-4"><a href="hte-i-binary-treatment.html#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="hte-i-binary-treatment.html#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividing data into three subsets</span></span>
<span id="cb14-6"><a href="hte-i-binary-treatment.html#cb14-6" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">seq</span>(<span class="fu">nrow</span>(data)), <span class="fu">sort</span>(<span class="fu">seq</span>(<span class="fu">nrow</span>(data)) <span class="sc">%%</span> <span class="dv">3</span>))</span>
<span id="cb14-7"><a href="hte-i-binary-treatment.html#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(indices) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;split&#39;</span>, <span class="st">&#39;est&#39;</span>, <span class="st">&#39;test&#39;</span>)</span>
<span id="cb14-8"><a href="hte-i-binary-treatment.html#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="hte-i-binary-treatment.html#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting the forest</span></span>
<span id="cb14-10"><a href="hte-i-binary-treatment.html#cb14-10" aria-hidden="true" tabindex="-1"></a>ct.unpruned <span class="ot">&lt;-</span> <span class="fu">honest.causalTree</span>(</span>
<span id="cb14-11"><a href="hte-i-binary-treatment.html#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula=</span>fmla,            <span class="co"># Define the model</span></span>
<span id="cb14-12"><a href="hte-i-binary-treatment.html#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>data[indices<span class="sc">$</span>split,],</span>
<span id="cb14-13"><a href="hte-i-binary-treatment.html#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment=</span>data[indices<span class="sc">$</span>split, treatment],</span>
<span id="cb14-14"><a href="hte-i-binary-treatment.html#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">est_data=</span>data[indices<span class="sc">$</span>est,],</span>
<span id="cb14-15"><a href="hte-i-binary-treatment.html#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">est_treatment=</span>data[indices<span class="sc">$</span>est, treatment],</span>
<span id="cb14-16"><a href="hte-i-binary-treatment.html#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsize=</span><span class="dv">1</span>,                 <span class="co"># Min. number of treatment and control cases in each leaf</span></span>
<span id="cb14-17"><a href="hte-i-binary-treatment.html#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">HonestSampleSize=</span><span class="fu">length</span>(indices<span class="sc">$</span>est), <span class="co">#  Num obs used in estimation after splitting</span></span>
<span id="cb14-18"><a href="hte-i-binary-treatment.html#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We recommend not changing the parameters below</span></span>
<span id="cb14-19"><a href="hte-i-binary-treatment.html#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">split.Rule=</span><span class="st">&quot;CT&quot;</span>,            <span class="co"># Define the splitting option</span></span>
<span id="cb14-20"><a href="hte-i-binary-treatment.html#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv.option=</span><span class="st">&quot;TOT&quot;</span>,            <span class="co"># Cross validation options</span></span>
<span id="cb14-21"><a href="hte-i-binary-treatment.html#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp=</span><span class="dv">0</span>,                       <span class="co"># Complexity parameter</span></span>
<span id="cb14-22"><a href="hte-i-binary-treatment.html#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">split.Honest=</span><span class="cn">TRUE</span>,          <span class="co"># Use honesty when splitting</span></span>
<span id="cb14-23"><a href="hte-i-binary-treatment.html#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv.Honest=</span><span class="cn">TRUE</span>              <span class="co"># Use honesty when performing cross-validation</span></span>
<span id="cb14-24"><a href="hte-i-binary-treatment.html#cb14-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-25"><a href="hte-i-binary-treatment.html#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="hte-i-binary-treatment.html#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Table of cross-validated values by tuning parameter.</span></span>
<span id="cb14-27"><a href="hte-i-binary-treatment.html#cb14-27" aria-hidden="true" tabindex="-1"></a>ct.cptable <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(ct.unpruned<span class="sc">$</span>cptable)</span>
<span id="cb14-28"><a href="hte-i-binary-treatment.html#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="hte-i-binary-treatment.html#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain optimal complexity parameter to prune tree.</span></span>
<span id="cb14-30"><a href="hte-i-binary-treatment.html#cb14-30" aria-hidden="true" tabindex="-1"></a>cp.selected <span class="ot">&lt;-</span> <span class="fu">which.min</span>(ct.cptable<span class="sc">$</span>xerror)</span>
<span id="cb14-31"><a href="hte-i-binary-treatment.html#cb14-31" aria-hidden="true" tabindex="-1"></a>cp.optimal <span class="ot">&lt;-</span> ct.cptable[cp.selected, <span class="st">&quot;CP&quot;</span>]</span>
<span id="cb14-32"><a href="hte-i-binary-treatment.html#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="hte-i-binary-treatment.html#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the tree at optimal complexity parameter.</span></span>
<span id="cb14-34"><a href="hte-i-binary-treatment.html#cb14-34" aria-hidden="true" tabindex="-1"></a>ct.pruned <span class="ot">&lt;-</span> <span class="fu">prune</span>(<span class="at">tree=</span>ct.unpruned, <span class="at">cp=</span>cp.optimal)</span>
<span id="cb14-35"><a href="hte-i-binary-treatment.html#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="hte-i-binary-treatment.html#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict point estimates (on estimation sample)</span></span>
<span id="cb14-37"><a href="hte-i-binary-treatment.html#cb14-37" aria-hidden="true" tabindex="-1"></a>tau.hat.est <span class="ot">&lt;-</span> <span class="fu">predict</span>(ct.pruned, <span class="at">newdata=</span>data[indices<span class="sc">$</span>est,])</span>
<span id="cb14-38"><a href="hte-i-binary-treatment.html#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="hte-i-binary-treatment.html#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a factor column &#39;leaf&#39; indicating leaf assignment in the estimation set</span></span>
<span id="cb14-40"><a href="hte-i-binary-treatment.html#cb14-40" aria-hidden="true" tabindex="-1"></a>num.leaves <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(tau.hat.est))</span>
<span id="cb14-41"><a href="hte-i-binary-treatment.html#cb14-41" aria-hidden="true" tabindex="-1"></a>leaf <span class="ot">&lt;-</span> <span class="fu">factor</span>(tau.hat.est, <span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(tau.hat.est)), <span class="at">labels =</span> <span class="fu">seq</span>(num.leaves))</span></code></pre></div>
<p>Note: if your tree is not splitting at all, try decreasing the parameter <code>minsize</code> that controls the minimum size of each leaf. The next snippet plots the learned tree. The values in the cell are the estimated treatment effect and an estimate of the fraction of the population that falls within each leaf. Both are estimated using the <code>estimation</code> sample.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="hte-i-binary-treatment.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(</span>
<span id="cb15-2"><a href="hte-i-binary-treatment.html#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x=</span>ct.pruned,        <span class="co"># Pruned tree</span></span>
<span id="cb15-3"><a href="hte-i-binary-treatment.html#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type=</span><span class="dv">3</span>,             <span class="co"># Draw separate split labels for the left and right directions</span></span>
<span id="cb15-4"><a href="hte-i-binary-treatment.html#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fallen=</span><span class="cn">TRUE</span>,        <span class="co"># Position the leaf nodes at the bottom of the graph</span></span>
<span id="cb15-5"><a href="hte-i-binary-treatment.html#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">leaf.round=</span><span class="dv">1</span>,       <span class="co"># Rounding of the corners of the leaf node boxes</span></span>
<span id="cb15-6"><a href="hte-i-binary-treatment.html#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">extra=</span><span class="dv">100</span>,          <span class="co"># Display the percentage of observations in the node</span></span>
<span id="cb15-7"><a href="hte-i-binary-treatment.html#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">branch=</span>.<span class="dv">1</span>,          <span class="co"># Shape of the branch lines</span></span>
<span id="cb15-8"><a href="hte-i-binary-treatment.html#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">box.palette=</span><span class="st">&quot;RdBu&quot;</span>) <span class="co"># Palette for coloring the node</span></span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>The next snippet tests if the treatment effect in leaves <span class="math inline">\(\geq 2\)</span> is larger than the treatment effect in the first leaf. The code follows closely what we saw in the previous subsection.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="hte-i-binary-treatment.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is only valid in randomized datasets.</span></span>
<span id="cb16-2"><a href="hte-i-binary-treatment.html#cb16-2" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outcome, <span class="st">&#39; ~ &#39;</span>, <span class="fu">paste0</span>(treatment, <span class="st">&#39;* leaf&#39;</span>))</span>
<span id="cb16-3"><a href="hte-i-binary-treatment.html#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (num.leaves <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb16-4"><a href="hte-i-binary-treatment.html#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;Skipping since there&#39;s a single leaf.&quot;</span>)</span>
<span id="cb16-5"><a href="hte-i-binary-treatment.html#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="hte-i-binary-treatment.html#cb16-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (num.leaves <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb16-7"><a href="hte-i-binary-treatment.html#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if there are only two leaves, no need to correct for multiple hypotheses</span></span>
<span id="cb16-8"><a href="hte-i-binary-treatment.html#cb16-8" aria-hidden="true" tabindex="-1"></a>  ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data[indices<span class="sc">$</span>est,], <span class="at">leaf=</span>leaf))</span>
<span id="cb16-9"><a href="hte-i-binary-treatment.html#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&#39;HC2&#39;</span>))[<span class="dv">4</span>,,drop<span class="ot">=</span>F]</span>
<span id="cb16-10"><a href="hte-i-binary-treatment.html#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="hte-i-binary-treatment.html#cb16-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-12"><a href="hte-i-binary-treatment.html#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if there are three or more leaves, use Romano-Wolf test correction </span></span>
<span id="cb16-13"><a href="hte-i-binary-treatment.html#cb16-13" aria-hidden="true" tabindex="-1"></a>  ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data[indices<span class="sc">$</span>est,], <span class="at">leaf=</span>leaf))</span>
<span id="cb16-14"><a href="hte-i-binary-treatment.html#cb16-14" aria-hidden="true" tabindex="-1"></a>  interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="fu">paste0</span>(treatment, <span class="st">&quot;:&quot;</span>), x)))</span>
<span id="cb16-15"><a href="hte-i-binary-treatment.html#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>interact, <span class="at">cov.type =</span> <span class="st">&#39;HC2&#39;</span>)</span>
<span id="cb16-16"><a href="hte-i-binary-treatment.html#cb16-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>##           Estimate Std. Error Orig. p-value Adj. p-value
## w:leaf2 0.04261544 0.02675955  1.112984e-01       0.1137
## w:leaf3 0.08304080 0.03903846  3.343291e-02       0.0629
## w:leaf4 0.08649780 0.02999722  3.941285e-03       0.0113
## w:leaf5 0.10688672 0.03346314  1.406931e-03       0.0047
## w:leaf6 0.14399896 0.03708540  1.039142e-04       0.0005
## w:leaf7 0.17514244 0.03797784  4.045881e-06       0.0000
## w:leaf8 0.21914803 0.04269808  2.915505e-07       0.0000
## w:leaf9 0.23088896 0.06627687  4.967474e-04       0.0024</code></pre>
<p>In the chapter <code>Introduction to Machine Learning</code>, we cautioned against interpreting the decision tree splits, and the same is true for causal tree splits. That a tree splits on a particular variable does not mean that this variable is relevant in the underlying data-generating process – it could simply be correlated with some other variable that is. For the same reason, we should not try to interpret <em>partial effects</em> from tree output.</p>
<p>However, similar to what we have done in previous chapters, we can try to understand how the joint distribution of covariates varies for subgroups with different estimated treatment effects. The annotated heatmap below shows the average value of each covariate within each leaf. Leaves are ordered from lowest to highest treatment effect estimate. The color is a normalized distance of each leaf-specific covariate mean from the overall covariate mean, i.e.., <span class="math inline">\(\smash{\Phi^{-1}\left((\widehat{\text{E}}[X_i|L_i] - \widehat{\text{E}}[X_i])/\widehat{\text{Var}}(\widehat{\text{E}}[X_i|L_i])\right)}\)</span>. The rows are in descending order of variation, measured by <span class="math inline">\(\widehat{\text{Var}}(\widehat{\text{E}}[X_i|L_i])/\widehat{\text{Var}}(X_i)\)</span>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="hte-i-binary-treatment.html#cb18-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(covariate) {</span>
<span id="cb18-2"><a href="hte-i-binary-treatment.html#cb18-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Looping over covariate names</span></span>
<span id="cb18-3"><a href="hte-i-binary-treatment.html#cb18-3" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute average covariate value per leaf (with correct standard errors)</span></span>
<span id="cb18-4"><a href="hte-i-binary-treatment.html#cb18-4" aria-hidden="true" tabindex="-1"></a>      fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(covariate, <span class="st">&quot;~ 0 + leaf&quot;</span>))</span>
<span id="cb18-5"><a href="hte-i-binary-treatment.html#cb18-5" aria-hidden="true" tabindex="-1"></a>      ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data[indices<span class="sc">$</span>est,], <span class="at">leaf=</span>leaf))</span>
<span id="cb18-6"><a href="hte-i-binary-treatment.html#cb18-6" aria-hidden="true" tabindex="-1"></a>      ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb18-7"><a href="hte-i-binary-treatment.html#cb18-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-8"><a href="hte-i-binary-treatment.html#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Retrieve results</span></span>
<span id="cb18-9"><a href="hte-i-binary-treatment.html#cb18-9" aria-hidden="true" tabindex="-1"></a>      avg <span class="ot">&lt;-</span> ols.res[,<span class="dv">1</span>]</span>
<span id="cb18-10"><a href="hte-i-binary-treatment.html#cb18-10" aria-hidden="true" tabindex="-1"></a>      stderr <span class="ot">&lt;-</span> ols.res[,<span class="dv">2</span>]</span>
<span id="cb18-11"><a href="hte-i-binary-treatment.html#cb18-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-12"><a href="hte-i-binary-treatment.html#cb18-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Tally up results</span></span>
<span id="cb18-13"><a href="hte-i-binary-treatment.html#cb18-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(covariate, avg, stderr, <span class="at">leaf=</span><span class="fu">paste0</span>(<span class="st">&quot;Leaf&quot;</span>, <span class="fu">seq</span>(num.leaves)), </span>
<span id="cb18-14"><a href="hte-i-binary-treatment.html#cb18-14" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># Used for coloring</span></span>
<span id="cb18-15"><a href="hte-i-binary-treatment.html#cb18-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">scaling=</span><span class="fu">pnorm</span>((avg <span class="sc">-</span> <span class="fu">mean</span>(avg))<span class="sc">/</span><span class="fu">sd</span>(avg)), </span>
<span id="cb18-16"><a href="hte-i-binary-treatment.html#cb18-16" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># We will order based on how much variation is &#39;explain&#39; by the averages</span></span>
<span id="cb18-17"><a href="hte-i-binary-treatment.html#cb18-17" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># relative to the total variation of the covariate in the data</span></span>
<span id="cb18-18"><a href="hte-i-binary-treatment.html#cb18-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">variation=</span><span class="fu">sd</span>(avg) <span class="sc">/</span> <span class="fu">sd</span>(data[,covariate]),</span>
<span id="cb18-19"><a href="hte-i-binary-treatment.html#cb18-19" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># String to print in each cell in heatmap below</span></span>
<span id="cb18-20"><a href="hte-i-binary-treatment.html#cb18-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels=</span><span class="fu">paste0</span>(<span class="fu">signif</span>(avg, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;(&quot;</span>, <span class="fu">signif</span>(stderr, <span class="dv">3</span>), <span class="st">&quot;)&quot;</span>))</span>
<span id="cb18-21"><a href="hte-i-binary-treatment.html#cb18-21" aria-hidden="true" tabindex="-1"></a>}, covariates, <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-22"><a href="hte-i-binary-treatment.html#cb18-22" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df)</span>
<span id="cb18-23"><a href="hte-i-binary-treatment.html#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="hte-i-binary-treatment.html#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co"># a small optional trick to ensure heatmap will be in decreasing order of &#39;variation&#39;</span></span>
<span id="cb18-25"><a href="hte-i-binary-treatment.html#cb18-25" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>covariate <span class="ot">&lt;-</span> <span class="fu">reorder</span>(df<span class="sc">$</span>covariate, <span class="fu">order</span>(df<span class="sc">$</span>variation))</span>
<span id="cb18-26"><a href="hte-i-binary-treatment.html#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="hte-i-binary-treatment.html#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot heatmap</span></span>
<span id="cb18-28"><a href="hte-i-binary-treatment.html#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb18-29"><a href="hte-i-binary-treatment.html#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(leaf, covariate) <span class="sc">+</span></span>
<span id="cb18-30"><a href="hte-i-binary-treatment.html#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> scaling)) <span class="sc">+</span> </span>
<span id="cb18-31"><a href="hte-i-binary-treatment.html#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> labels)) <span class="sc">+</span></span>
<span id="cb18-32"><a href="hte-i-binary-treatment.html#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;#E1BE6A&quot;</span>, <span class="at">high =</span> <span class="st">&quot;#40B0A6&quot;</span>) <span class="sc">+</span></span>
<span id="cb18-33"><a href="hte-i-binary-treatment.html#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Average covariate values within each leaf&quot;</span>)) <span class="sc">+</span></span>
<span id="cb18-34"><a href="hte-i-binary-treatment.html#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb18-35"><a href="hte-i-binary-treatment.html#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb18-36"><a href="hte-i-binary-treatment.html#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb18-37"><a href="hte-i-binary-treatment.html#cb18-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p><font size=1>
Interpret the heatmap above. What describes the subgroups with strongest and weakest estimated treatment effect?
</font></p>
</div>
<div id="via-grf" class="section level3" number="22.2.2">
<h3><span class="header-section-number">22.2.2</span> Via grf</h3>
<p>The function <code>causal_forest</code> from the package <code>grf</code> allows us to get estimates of the CATE <a href="hte-i-binary-treatment.html#eq:cate">(22.1)</a>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="hte-i-binary-treatment.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from forest fitted above.</span></span>
<span id="cb19-2"><a href="hte-i-binary-treatment.html#cb19-2" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau)<span class="sc">$</span>predictions  <span class="co"># tau(X) estimates</span></span></code></pre></div>
<p>Having fit a non-parametric method such as a causal forest, a researcher may (incorrectly) start by looking at the distribution of its predictions of the treatment effect. One might be tempted to think: “if the histogram is concentrated at a point, then there is no heterogeneity; if the histogram is spread out, then our estimator has found interesting heterogeneity.” However, this may be false.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="hte-i-binary-treatment.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not use this for assessing heterogeneity. See text above.</span></span>
<span id="cb20-2"><a href="hte-i-binary-treatment.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(tau.hat, <span class="at">main=</span><span class="st">&quot;CATE estimates&quot;</span>, <span class="at">freq=</span>F)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>If the histogram is concentrated at a point, we may simply be underpowered: our method was not able to detect any heterogeneity, but maybe it would detect it if we had more data. If the histogram is spread out, we may be overfitting: our model is producing very noisy estimates <span class="math inline">\(\widehat{\tau}(x)\)</span>, but in fact the true <span class="math inline">\(\tau(x)\)</span> can be much smoother as a function of <span class="math inline">\(x\)</span>.</p>
<p>The <code>grf</code> package also produces a measure of variable importance that indicates how often a variable was used in a tree split. Again, much like the histogram above, this can be a rough diagnostic, but it should not be interpreted as indicating that, for example, variable with low importance is not related to heterogeneity. The reasoning is the same as the one presented in the causal trees section: if two covariates are highly correlated, the trees might split on one covariate but not the other, even though both (or maybe neither) are relevant in the true data-generating process.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="hte-i-binary-treatment.html#cb21-1" aria-hidden="true" tabindex="-1"></a>var_imp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">variable_importance</span>(forest.tau))</span>
<span id="cb21-2"><a href="hte-i-binary-treatment.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(var_imp) <span class="ot">&lt;-</span> covariates</span>
<span id="cb21-3"><a href="hte-i-binary-treatment.html#cb21-3" aria-hidden="true" tabindex="-1"></a>sorted_var_imp <span class="ot">&lt;-</span> <span class="fu">sort</span>(var_imp, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-4"><a href="hte-i-binary-treatment.html#cb21-4" aria-hidden="true" tabindex="-1"></a>sorted_var_imp[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]  <span class="co"># showing only first few</span></span></code></pre></div>
<pre><code>##   polviews     income        age       educ    marital 
## 0.44150136 0.33501972 0.09863612 0.07523106 0.04151206</code></pre>
<div id="data-driven-subgroups" class="section level4" number="22.2.2.1">
<h4><span class="header-section-number">22.2.2.1</span> Data-driven subgroups</h4>
<p>Just as with causal trees, we can use causal forests to divide our observations into subgroups. In place of leaves, we’ll rank observation into (say) quintiles according to their estimated CATE prediction; see, e.g., <a href="https://arxiv.org/abs/1712.04802">Chernozhukov, Demirer, Duflo, Fernández-Val (2020)</a> for similar ideas.</p>
<p>There’s a subtle but important point that needs to be addressed here. As we have mentioned before, when predicting the conditional average treatment effect <span class="math inline">\(\widehat{\tau}(X_i)\)</span> for observation <span class="math inline">\(i\)</span> we should in general avoid using a model that was fitted using observation <span class="math inline">\(i\)</span>. This sort of sample splitting (which we called <strong>honesty</strong> above) is one of the required ingredients to get unbiased estimates of the CATE using the methods described here. However, when ranking estimates of two observations <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, we need something a little stronger: we must ensure that the model was not fit using <em>either</em> <span class="math inline">\(i\)</span> <em>or</em> <span class="math inline">\(j\)</span>’s data.</p>
<p>One way of overcoming this obstacle is simple. First, divide the data into <span class="math inline">\(K\)</span> folds (subsets). Then, cycle through the folds, fitting a CATE model on <span class="math inline">\(K-1\)</span> folds. Next, for each held-out fold, <em>separately</em> rank the unseen observations into <span class="math inline">\(Q\)</span> groups based on their prediction (i.e., if <span class="math inline">\(Q=5\)</span>, then we rank observations by estimated CATE into “top quintile”, “second quintile”, and so on). After concatenating the independent rankings together, we can study the differences in observations in each rank-group.</p>
<p><a href="https://gist.github.com/halflearned/bea4e5137c0c81fd18a75f682da466c8">This gist</a> computes the above for <code>grf</code>, and it should not be hard to modify it so as to replace forests by any other non-parametric method. However, for <code>grf</code> specifically, there’s a small trick that allows us to obtain a valid ranking: we can pass a vector of fold indices to the argument <code>clusters</code> and rank observations within each fold. This works because estimates for each fold (“cluster”) trees are computed using trees that were not fit using observations from that fold. Here’s how to do it.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="hte-i-binary-treatment.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid randomized data and observational data with unconfoundedness+overlap.</span></span>
<span id="cb23-2"><a href="hte-i-binary-treatment.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: read the comments below carefully. </span></span>
<span id="cb23-3"><a href="hte-i-binary-treatment.html#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># In randomized settings, do not estimate forest.e and e.hat; use known assignment probs.</span></span>
<span id="cb23-4"><a href="hte-i-binary-treatment.html#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="hte-i-binary-treatment.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare dataset</span></span>
<span id="cb23-6"><a href="hte-i-binary-treatment.html#cb23-6" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~ 0 + &quot;</span>, <span class="fu">paste0</span>(covariates, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb23-7"><a href="hte-i-binary-treatment.html#cb23-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data)</span>
<span id="cb23-8"><a href="hte-i-binary-treatment.html#cb23-8" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> data[,treatment]</span>
<span id="cb23-9"><a href="hte-i-binary-treatment.html#cb23-9" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,outcome]</span>
<span id="cb23-10"><a href="hte-i-binary-treatment.html#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="hte-i-binary-treatment.html#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of rankings that the predictions will be ranking on </span></span>
<span id="cb23-12"><a href="hte-i-binary-treatment.html#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g., 2 for above/below median estimated CATE, 5 for estimated CATE quintiles, etc.)</span></span>
<span id="cb23-13"><a href="hte-i-binary-treatment.html#cb23-13" aria-hidden="true" tabindex="-1"></a>num.rankings <span class="ot">&lt;-</span> <span class="dv">5</span>  </span>
<span id="cb23-14"><a href="hte-i-binary-treatment.html#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="hte-i-binary-treatment.html#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare for data.splitting</span></span>
<span id="cb23-16"><a href="hte-i-binary-treatment.html#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign a fold number to each observation.</span></span>
<span id="cb23-17"><a href="hte-i-binary-treatment.html#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The argument &#39;clusters&#39; in the next step will mimick K-fold cross-fitting.</span></span>
<span id="cb23-18"><a href="hte-i-binary-treatment.html#cb23-18" aria-hidden="true" tabindex="-1"></a>num.folds <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb23-19"><a href="hte-i-binary-treatment.html#cb23-19" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">seq</span>(n) <span class="sc">%%</span> num.folds) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb23-20"><a href="hte-i-binary-treatment.html#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="hte-i-binary-treatment.html#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment or uncomment depending on your setting.</span></span>
<span id="cb23-22"><a href="hte-i-binary-treatment.html#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Observational setting with unconfoundedness+overlap (unknown assignment probs):</span></span>
<span id="cb23-23"><a href="hte-i-binary-treatment.html#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co"># forest &lt;- causal_forest(X, Y, W, clusters = folds)</span></span>
<span id="cb23-24"><a href="hte-i-binary-treatment.html#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomized settings with fixed and known probabilities (here: 0.5).</span></span>
<span id="cb23-25"><a href="hte-i-binary-treatment.html#cb23-25" aria-hidden="true" tabindex="-1"></a>forest <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(X, Y, W, <span class="at">W.hat=</span>.<span class="dv">5</span>, <span class="at">clusters =</span> folds)</span>
<span id="cb23-26"><a href="hte-i-binary-treatment.html#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="hte-i-binary-treatment.html#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve out-of-bag predictions.</span></span>
<span id="cb23-28"><a href="hte-i-binary-treatment.html#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions for observation in fold k will be computed using </span></span>
<span id="cb23-29"><a href="hte-i-binary-treatment.html#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co"># trees that were not trained using observations for that fold.</span></span>
<span id="cb23-30"><a href="hte-i-binary-treatment.html#cb23-30" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest)<span class="sc">$</span>predictions</span>
<span id="cb23-31"><a href="hte-i-binary-treatment.html#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="hte-i-binary-treatment.html#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Rank observations *within each fold* into quintiles according to their CATE predictions.</span></span>
<span id="cb23-33"><a href="hte-i-binary-treatment.html#cb23-33" aria-hidden="true" tabindex="-1"></a>ranking <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n)</span>
<span id="cb23-34"><a href="hte-i-binary-treatment.html#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (fold <span class="cf">in</span> <span class="fu">seq</span>(num.folds)) {</span>
<span id="cb23-35"><a href="hte-i-binary-treatment.html#cb23-35" aria-hidden="true" tabindex="-1"></a>  tau.hat.quantiles <span class="ot">&lt;-</span> <span class="fu">quantile</span>(tau.hat[folds <span class="sc">==</span> fold], <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by=</span><span class="dv">1</span><span class="sc">/</span>num.rankings))</span>
<span id="cb23-36"><a href="hte-i-binary-treatment.html#cb23-36" aria-hidden="true" tabindex="-1"></a>  ranking[folds <span class="sc">==</span> fold] <span class="ot">&lt;-</span> <span class="fu">cut</span>(tau.hat[folds <span class="sc">==</span> fold], tau.hat.quantiles, <span class="at">include.lowest=</span><span class="cn">TRUE</span>,<span class="at">labels=</span><span class="fu">seq</span>(num.rankings))</span>
<span id="cb23-37"><a href="hte-i-binary-treatment.html#cb23-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The next snippet computes the average treatment effect within each group defined above, i.e., <span class="math inline">\(\mathop{\mathrm{E}}[Y_i(1) - Y_i(0)|G_i = g]\)</span>. This can done in two ways. First, by computing a simple difference-in-means estimate of the ATE based on observations within each group. This is valid only in randomized settings.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="hte-i-binary-treatment.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid only in randomized settings.</span></span>
<span id="cb24-2"><a href="hte-i-binary-treatment.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Average difference-in-means within each ranking</span></span>
<span id="cb24-3"><a href="hte-i-binary-treatment.html#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="hte-i-binary-treatment.html#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Formula y ~ 0 + ranking + ranking:w</span></span>
<span id="cb24-5"><a href="hte-i-binary-treatment.html#cb24-5" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outcome, <span class="st">&quot; ~ 0 + ranking + ranking:&quot;</span>, treatment)</span>
<span id="cb24-6"><a href="hte-i-binary-treatment.html#cb24-6" aria-hidden="true" tabindex="-1"></a>ols.ate <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">ranking=</span><span class="fu">factor</span>(ranking)))</span>
<span id="cb24-7"><a href="hte-i-binary-treatment.html#cb24-7" aria-hidden="true" tabindex="-1"></a>ols.ate <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols.ate, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols.ate, <span class="at">type=</span><span class="st">&#39;HC2&#39;</span>))</span>
<span id="cb24-8"><a href="hte-i-binary-treatment.html#cb24-8" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">&quot;:&quot;</span>, <span class="fu">rownames</span>(ols.ate)))</span>
<span id="cb24-9"><a href="hte-i-binary-treatment.html#cb24-9" aria-hidden="true" tabindex="-1"></a>ols.ate <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;ols&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="fu">seq</span>(num.rankings)), ols.ate[interact, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb24-10"><a href="hte-i-binary-treatment.html#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ols.ate) <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># just for display</span></span>
<span id="cb24-11"><a href="hte-i-binary-treatment.html#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ols.ate) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;method&quot;</span>, <span class="st">&quot;ranking&quot;</span>, <span class="st">&quot;estimate&quot;</span>, <span class="st">&quot;std.err&quot;</span>)</span>
<span id="cb24-12"><a href="hte-i-binary-treatment.html#cb24-12" aria-hidden="true" tabindex="-1"></a>ols.ate</span></code></pre></div>
<pre><code>##   method ranking   estimate     std.err
## 1    ols      Q1 -0.4330772 0.011339998
## 2    ols      Q2 -0.4017728 0.011166163
## 3    ols      Q3 -0.3591399 0.011090804
## 4    ols      Q4 -0.3269298 0.010437065
## 5    ols      Q5 -0.2169829 0.009797121</code></pre>
<p>Another option is to average the AIPW scores within each group. This valid for both randomized settings and observational settings with unconfoundedness and overlap. Moreover, AIPW-based estimators should produce estimates with tighter confidence intervals in large samples.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="hte-i-binary-treatment.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Computing AIPW scores.</span></span>
<span id="cb26-2"><a href="hte-i-binary-treatment.html#cb26-2" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest)<span class="sc">$</span>predictions</span>
<span id="cb26-3"><a href="hte-i-binary-treatment.html#cb26-3" aria-hidden="true" tabindex="-1"></a>e.hat <span class="ot">&lt;-</span> forest<span class="sc">$</span>W.hat <span class="co"># P[W=1|X]</span></span>
<span id="cb26-4"><a href="hte-i-binary-treatment.html#cb26-4" aria-hidden="true" tabindex="-1"></a>m.hat <span class="ot">&lt;-</span> forest<span class="sc">$</span>Y.hat <span class="co"># E[Y|X]</span></span>
<span id="cb26-5"><a href="hte-i-binary-treatment.html#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="hte-i-binary-treatment.html#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimating mu.hat(X, 1) and mu.hat(X, 0) for obs in held-out sample</span></span>
<span id="cb26-7"><a href="hte-i-binary-treatment.html#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: to understand this, read equations 6-8 in this vignette:</span></span>
<span id="cb26-8"><a href="hte-i-binary-treatment.html#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># https://grf-labs.github.io/grf/articles/muhats.html</span></span>
<span id="cb26-9"><a href="hte-i-binary-treatment.html#cb26-9" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.0</span> <span class="ot">&lt;-</span> m.hat <span class="sc">-</span> e.hat <span class="sc">*</span> tau.hat        <span class="co"># E[Y|X,W=0] = E[Y|X] - e(X)*tau(X)</span></span>
<span id="cb26-10"><a href="hte-i-binary-treatment.html#cb26-10" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.1</span> <span class="ot">&lt;-</span> m.hat <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> tau.hat  <span class="co"># E[Y|X,W=1] = E[Y|X] + (1 - e(X))*tau(X)</span></span>
<span id="cb26-11"><a href="hte-i-binary-treatment.html#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="hte-i-binary-treatment.html#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"># AIPW scores</span></span>
<span id="cb26-13"><a href="hte-i-binary-treatment.html#cb26-13" aria-hidden="true" tabindex="-1"></a>aipw.scores <span class="ot">&lt;-</span> tau.hat <span class="sc">+</span> W <span class="sc">/</span> e.hat <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.1</span>) <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> W) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.0</span>)</span>
<span id="cb26-14"><a href="hte-i-binary-treatment.html#cb26-14" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(aipw.scores <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">factor</span>(ranking))</span>
<span id="cb26-15"><a href="hte-i-binary-treatment.html#cb26-15" aria-hidden="true" tabindex="-1"></a>forest.ate <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;aipw&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="fu">seq</span>(num.rankings)), <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb26-16"><a href="hte-i-binary-treatment.html#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(forest.ate) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;method&quot;</span>, <span class="st">&quot;ranking&quot;</span>, <span class="st">&quot;estimate&quot;</span>, <span class="st">&quot;std.err&quot;</span>)</span>
<span id="cb26-17"><a href="hte-i-binary-treatment.html#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(forest.ate) <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># just for display</span></span>
<span id="cb26-18"><a href="hte-i-binary-treatment.html#cb26-18" aria-hidden="true" tabindex="-1"></a>forest.ate</span></code></pre></div>
<pre><code>##   method ranking   estimate    std.err
## 1   aipw      Q1 -0.4332696 0.01105454
## 2   aipw      Q2 -0.4023673 0.01074722
## 3   aipw      Q3 -0.3590226 0.01064744
## 4   aipw      Q4 -0.3284966 0.01022877
## 5   aipw      Q5 -0.2135068 0.00932228</code></pre>
<p>The code below plots the estimates.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="hte-i-binary-treatment.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate the two results.</span></span>
<span id="cb28-2"><a href="hte-i-binary-treatment.html#cb28-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(forest.ate, ols.ate)</span>
<span id="cb28-3"><a href="hte-i-binary-treatment.html#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="hte-i-binary-treatment.html#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the point estimate of average treatment effect </span></span>
<span id="cb28-5"><a href="hte-i-binary-treatment.html#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># and 95% confidence intervals around it.</span></span>
<span id="cb28-6"><a href="hte-i-binary-treatment.html#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res) <span class="sc">+</span></span>
<span id="cb28-7"><a href="hte-i-binary-treatment.html#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> ranking, <span class="at">y =</span> estimate, <span class="at">group=</span>method, <span class="at">color=</span>method) <span class="sc">+</span> </span>
<span id="cb28-8"><a href="hte-i-binary-treatment.html#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb28-9"><a href="hte-i-binary-treatment.html#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>estimate<span class="dv">-2</span><span class="sc">*</span>std.err, <span class="at">ymax=</span>estimate<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>std.err), <span class="at">width=</span>.<span class="dv">2</span>, <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb28-10"><a href="hte-i-binary-treatment.html#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb28-11"><a href="hte-i-binary-treatment.html#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Average CATE within each ranking (as defined by predicted CATE)&quot;</span>) <span class="sc">+</span></span>
<span id="cb28-12"><a href="hte-i-binary-treatment.html#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-13"><a href="hte-i-binary-treatment.html#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>When there isn’t much detectable heterogeneity, the plot above can end up being non-monotonic. This can mean that the number of observations is too small for us to be able to detect subgroups with relevant differences in treatment effect.</p>
<p><font size=1>
As an exercise, try running the previous two snippets on few data points (e.g., the first thousand observations only). You will likely see the “non-monotonicity” phenomenon just described.
</font></p>
<p>Next, as we did for leaves in a causal tree, we can test e.g., if the prediction for groups 2, 3, etc. are larger than the one in the first group. Here’s how to do it based on a difference-in-means estimator. Note the Romano-Wolf multiple-hypothesis testing correction.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="hte-i-binary-treatment.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid in randomized settings only.</span></span>
<span id="cb29-2"><a href="hte-i-binary-treatment.html#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="hte-i-binary-treatment.html#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># y ~ ranking + w + ranking:w</span></span>
<span id="cb29-4"><a href="hte-i-binary-treatment.html#cb29-4" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outcome, <span class="st">&quot;~ ranking + &quot;</span>, treatment, <span class="st">&quot; + ranking:&quot;</span>, treatment) </span>
<span id="cb29-5"><a href="hte-i-binary-treatment.html#cb29-5" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">ranking=</span><span class="fu">factor</span>(ranking)))</span>
<span id="cb29-6"><a href="hte-i-binary-treatment.html#cb29-6" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="st">&quot;:&quot;</span>, x)))</span>
<span id="cb29-7"><a href="hte-i-binary-treatment.html#cb29-7" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>interact)</span>
<span id="cb29-8"><a href="hte-i-binary-treatment.html#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(res) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Rank&quot;</span>, <span class="dv">2</span><span class="sc">:</span>num.rankings, <span class="st">&quot;- Rank 1&quot;</span>) <span class="co"># just for display</span></span>
<span id="cb29-9"><a href="hte-i-binary-treatment.html#cb29-9" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div>
<pre><code>##                   Estimate Std. Error Orig. p-value Adj. p-value
## Rank 2 - Rank 1 0.03130439 0.01476320  3.397798e-02       0.0323
## Rank 3 - Rank 1 0.07393727 0.01476042  5.499333e-07       0.0000
## Rank 4 - Rank 1 0.10614741 0.01474544  6.230333e-13       0.0000
## Rank 5 - Rank 1 0.21609423 0.01476237  2.397466e-48       0.0000</code></pre>
<p>Here’s how to do it for AIPW-based estimates, again with Romano-Wolf correction for multiple hypothesis testing.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="hte-i-binary-treatment.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid in randomized and observational settings with unconfoundedness+overlap.</span></span>
<span id="cb31-2"><a href="hte-i-binary-treatment.html#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="hte-i-binary-treatment.html#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using AIPW scores computed above</span></span>
<span id="cb31-4"><a href="hte-i-binary-treatment.html#cb31-4" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(aipw.scores <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">factor</span>(ranking))</span>
<span id="cb31-5"><a href="hte-i-binary-treatment.html#cb31-5" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span><span class="dv">2</span><span class="sc">:</span>num.rankings)</span>
<span id="cb31-6"><a href="hte-i-binary-treatment.html#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(res) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Rank&quot;</span>, <span class="dv">2</span><span class="sc">:</span>num.rankings, <span class="st">&quot;- Rank 1&quot;</span>) <span class="co"># just for display</span></span>
<span id="cb31-7"><a href="hte-i-binary-treatment.html#cb31-7" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div>
<pre><code>##                   Estimate Std. Error Orig. p-value Adj. p-value
## Rank 2 - Rank 1 0.03090227 0.01473089  3.593262e-02       0.0376
## Rank 3 - Rank 1 0.07424698 0.01473024  4.672755e-07       0.0000
## Rank 4 - Rank 1 0.10477301 0.01473217  1.171808e-12       0.0000
## Rank 5 - Rank 1 0.21976274 0.01473089  3.855342e-50       0.0000</code></pre>
<p>Finally, we can also check if different groups have different average covariate levels across rankings.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="hte-i-binary-treatment.html#cb33-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(covariate) {</span>
<span id="cb33-2"><a href="hte-i-binary-treatment.html#cb33-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Looping over covariate names</span></span>
<span id="cb33-3"><a href="hte-i-binary-treatment.html#cb33-3" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute average covariate value per ranking (with correct standard errors)</span></span>
<span id="cb33-4"><a href="hte-i-binary-treatment.html#cb33-4" aria-hidden="true" tabindex="-1"></a>      fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(covariate, <span class="st">&quot;~ 0 + ranking&quot;</span>))</span>
<span id="cb33-5"><a href="hte-i-binary-treatment.html#cb33-5" aria-hidden="true" tabindex="-1"></a>      ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">ranking=</span><span class="fu">factor</span>(ranking)))</span>
<span id="cb33-6"><a href="hte-i-binary-treatment.html#cb33-6" aria-hidden="true" tabindex="-1"></a>      ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb33-7"><a href="hte-i-binary-treatment.html#cb33-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-8"><a href="hte-i-binary-treatment.html#cb33-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Retrieve results</span></span>
<span id="cb33-9"><a href="hte-i-binary-treatment.html#cb33-9" aria-hidden="true" tabindex="-1"></a>      avg <span class="ot">&lt;-</span> ols.res[,<span class="dv">1</span>]</span>
<span id="cb33-10"><a href="hte-i-binary-treatment.html#cb33-10" aria-hidden="true" tabindex="-1"></a>      stderr <span class="ot">&lt;-</span> ols.res[,<span class="dv">2</span>]</span>
<span id="cb33-11"><a href="hte-i-binary-treatment.html#cb33-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb33-12"><a href="hte-i-binary-treatment.html#cb33-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Tally up results</span></span>
<span id="cb33-13"><a href="hte-i-binary-treatment.html#cb33-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(covariate, avg, stderr, <span class="at">ranking=</span><span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="fu">seq</span>(num.rankings)), </span>
<span id="cb33-14"><a href="hte-i-binary-treatment.html#cb33-14" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># Used for coloring</span></span>
<span id="cb33-15"><a href="hte-i-binary-treatment.html#cb33-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">scaling=</span><span class="fu">pnorm</span>((avg <span class="sc">-</span> <span class="fu">mean</span>(avg))<span class="sc">/</span><span class="fu">sd</span>(avg)), </span>
<span id="cb33-16"><a href="hte-i-binary-treatment.html#cb33-16" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># We will order based on how much variation is &#39;explain&#39; by the averages</span></span>
<span id="cb33-17"><a href="hte-i-binary-treatment.html#cb33-17" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># relative to the total variation of the covariate in the data</span></span>
<span id="cb33-18"><a href="hte-i-binary-treatment.html#cb33-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">variation=</span><span class="fu">sd</span>(avg) <span class="sc">/</span> <span class="fu">sd</span>(data[,covariate]),</span>
<span id="cb33-19"><a href="hte-i-binary-treatment.html#cb33-19" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># String to print in each cell in heatmap below</span></span>
<span id="cb33-20"><a href="hte-i-binary-treatment.html#cb33-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels=</span><span class="fu">paste0</span>(<span class="fu">signif</span>(avg, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;(&quot;</span>, <span class="fu">signif</span>(stderr, <span class="dv">3</span>), <span class="st">&quot;)&quot;</span>))</span>
<span id="cb33-21"><a href="hte-i-binary-treatment.html#cb33-21" aria-hidden="true" tabindex="-1"></a>}, covariates, <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-22"><a href="hte-i-binary-treatment.html#cb33-22" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df)</span>
<span id="cb33-23"><a href="hte-i-binary-treatment.html#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="hte-i-binary-treatment.html#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co"># a small optional trick to ensure heatmap will be in decreasing order of &#39;variation&#39;</span></span>
<span id="cb33-25"><a href="hte-i-binary-treatment.html#cb33-25" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>covariate <span class="ot">&lt;-</span> <span class="fu">reorder</span>(df<span class="sc">$</span>covariate, <span class="fu">order</span>(df<span class="sc">$</span>variation))</span>
<span id="cb33-26"><a href="hte-i-binary-treatment.html#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="hte-i-binary-treatment.html#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot heatmap</span></span>
<span id="cb33-28"><a href="hte-i-binary-treatment.html#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb33-29"><a href="hte-i-binary-treatment.html#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(ranking, covariate) <span class="sc">+</span></span>
<span id="cb33-30"><a href="hte-i-binary-treatment.html#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> scaling)) <span class="sc">+</span> </span>
<span id="cb33-31"><a href="hte-i-binary-treatment.html#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> labels)) <span class="sc">+</span></span>
<span id="cb33-32"><a href="hte-i-binary-treatment.html#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;#E1BE6A&quot;</span>, <span class="at">high =</span> <span class="st">&quot;#40B0A6&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-33"><a href="hte-i-binary-treatment.html#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Average covariate values within group (based on CATE estimate ranking)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb33-34"><a href="hte-i-binary-treatment.html#cb33-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb33-35"><a href="hte-i-binary-treatment.html#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;CATE estimate ranking&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-36"><a href="hte-i-binary-treatment.html#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb33-37"><a href="hte-i-binary-treatment.html#cb33-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p><font size=1>
Interpret the heatmap above. What describes the subgroups with strongest and weakest estimated treatment effect? Are there variables that seem to increase or decrease monotonically across rankings?
</font></p>
</div>
<div id="best-linear-projection" class="section level4" number="22.2.2.2">
<h4><span class="header-section-number">22.2.2.2</span> Best linear projection</h4>
<p>This function provides a doubly robust fit to the linear model <span class="math inline">\(\widehat{\tau}(X_i) = \beta_0 + A_i&#39;\beta_1\)</span>, where <span class="math inline">\(A_i\)</span> can be a subset of the covariate columns. The coefficients in this regression are suggestive of general trends, but they should not be interpret as partial effects – that would only be true if the true model were really linear in covariates, and that’s an assumption we shouldn’t be willing to make in general.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="hte-i-binary-treatment.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Best linear projection of the conditional average treatment effect on covariates</span></span>
<span id="cb34-2"><a href="hte-i-binary-treatment.html#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">best_linear_projection</span>(forest.tau, X)</span></code></pre></div>
<pre><code>## 
## Best linear projection of the conditional average treatment effect.
## Confidence intervals are cluster- and heteroskedasticity-robust (HC3):
## 
##                Estimate  Std. Error  t value  Pr(&gt;|t|)    
## (Intercept) -0.17601485  0.04249419  -4.1421 3.451e-05 ***
## age          0.00145586  0.00031069   4.6858 2.801e-06 ***
## polviews    -0.03553649  0.00356996  -9.9543 &lt; 2.2e-16 ***
## income      -0.02094034  0.00202198 -10.3564 &lt; 2.2e-16 ***
## educ         0.00886020  0.00172935   5.1234 3.020e-07 ***
## marital      0.01017645  0.00331452   3.0703  0.002141 ** 
## sex         -0.00684053  0.01000337  -0.6838  0.494093    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
<div id="assessing-heterogeneity" class="section level4" number="22.2.2.3">
<h4><span class="header-section-number">22.2.2.3</span> Assessing heterogeneity</h4>
<p>The function <code>test_calibration</code> computes an estimate of the best linear predictor of true CATE based on out-of-bag predictions <span class="math inline">\(\hat{\tau}^{-i}(\cdot)\)</span>. The exact implementation seeks to fit the following linear model:
<span class="math display">\[\begin{equation}
Y_{i} - \hat{m}^{-i}(X_{i}) = \alpha\bar{\tau}\left(W_{i} - \hat{e}^{-i}(X_{i})\right) + \beta \left(\hat{\tau}^{-i}(X_{i}) - \bar{\tau} \right) \left(W_{i} - \hat{e}^{-i}(X_{i}) \right) + \epsilon,
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\bar{\tau} := n^{-1}\sum_{i=1}^{n} \hat{\tau}^{-i}(X_{i})\)</span>. The coefficients <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> allow us to evaluate the performance of our estimates. If <span class="math inline">\(\alpha = 1\)</span>, then the average prediction produced by the forest is correct. Meanwhile, if <span class="math inline">\(\beta = 1\)</span>, then the forest predictions adequately capture the underlying heterogeneity.</p>
<p>The slope <span class="math inline">\(\beta\)</span> is a measure of how the CATE predictions covary with true CATE. Therefore, the p-value on the estimate of coefficient also acts as an omnibus test for the presence of heterogeneity. If the coefficient is significantly greater than zero, then we can reject the null of no heterogeneity. However, coefficients smaller than 0 are not meaningful and show not be interpreted.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="hte-i-binary-treatment.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_calibration</span>(forest.tau)</span></code></pre></div>
<pre><code>## 
## Best linear fit using forest predictions (on held-out data)
## as well as the mean forest prediction as regressors, along
## with one-sided heteroskedasticity-robust (HC3) SEs:
## 
##                                Estimate Std. Error t value    Pr(&gt;t)    
## mean.forest.prediction         0.999643   0.013689  73.024 &lt; 2.2e-16 ***
## differential.forest.prediction 0.909231   0.048158  18.880 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><font size=1>
Interpret the test above. Is the forest producing correct estimate of the average treatment effect? Is it capturing the underlying heterogeneity?
</font></p>
</div>
<div id="partial-dependence" class="section level4" number="22.2.2.4">
<h4><span class="header-section-number">22.2.2.4</span> Partial dependence</h4>
<p>It may also be interesting to examine how our CATE estimates behave when we change a single covariate, while keeping all the other covariates at a some fixed value. In the plot below we evaluate a variable of interest across quantiles, while keeping all other covariates at their median.</p>
<p>It is important to recognize that by keeping some variables at their median we may be evaluating the CATE at <span class="math inline">\(x\)</span> values in regions where there are few or no data points. Also, it may be the case that varying some particular variable while keeping others fixed may just not be very interesting.</p>
<p>In what follows we’ll again use <code>causal_forest</code> predictions, along with their variance estimates (set <code>estimate.variances=TRUE</code> when predicting to we get estimates of the asymptotic variance of the prediction for each point). Since <code>grf</code> predictions are asymptotically normal, we can construct 95% confidence intervals in the usual manner (i.e., <span class="math inline">\(\hat{\tau}(x) \pm 1.96\sqrt{\widehat{\text{Var}}(\hat{\tau}(x))}\)</span>).</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="hte-i-binary-treatment.html#cb38-1" aria-hidden="true" tabindex="-1"></a>selected.covariate <span class="ot">&lt;-</span> <span class="st">&quot;polviews&quot;</span></span>
<span id="cb38-2"><a href="hte-i-binary-treatment.html#cb38-2" aria-hidden="true" tabindex="-1"></a>other.covariates <span class="ot">&lt;-</span> covariates[<span class="fu">which</span>(covariates <span class="sc">!=</span> selected.covariate)]</span>
<span id="cb38-3"><a href="hte-i-binary-treatment.html#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="hte-i-binary-treatment.html#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a forest </span></span>
<span id="cb38-5"><a href="hte-i-binary-treatment.html#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (commented for convenience; no need re-fit if already fitted above)</span></span>
<span id="cb38-6"><a href="hte-i-binary-treatment.html#cb38-6" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~ 0 + &quot;</span>, <span class="fu">paste0</span>(covariates, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb38-7"><a href="hte-i-binary-treatment.html#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: For smaller confidence intervals, set num.trees ~ sample size</span></span>
<span id="cb38-8"><a href="hte-i-binary-treatment.html#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># X &lt;- model.matrix(fmla, data)</span></span>
<span id="cb38-9"><a href="hte-i-binary-treatment.html#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># W &lt;- data[,treatment]</span></span>
<span id="cb38-10"><a href="hte-i-binary-treatment.html#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Y &lt;- data[,outcome]</span></span>
<span id="cb38-11"><a href="hte-i-binary-treatment.html#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># forest.tau &lt;- causal_forest(X, Y, W, W.hat=.5)  # few trees for speed here</span></span>
<span id="cb38-12"><a href="hte-i-binary-treatment.html#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="hte-i-binary-treatment.html#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute a grid of values appropriate for the selected covariate</span></span>
<span id="cb38-14"><a href="hte-i-binary-treatment.html#cb38-14" aria-hidden="true" tabindex="-1"></a>grid.size <span class="ot">&lt;-</span> <span class="dv">7</span> </span>
<span id="cb38-15"><a href="hte-i-binary-treatment.html#cb38-15" aria-hidden="true" tabindex="-1"></a>covariate.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(data[,selected.covariate]), <span class="fu">max</span>(data[,selected.covariate]), <span class="at">length.out=</span>grid.size)</span>
<span id="cb38-16"><a href="hte-i-binary-treatment.html#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="hte-i-binary-treatment.html#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Other options for constructing a grid:</span></span>
<span id="cb38-18"><a href="hte-i-binary-treatment.html#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co"># For a binary variable, simply use 0 and 1</span></span>
<span id="cb38-19"><a href="hte-i-binary-treatment.html#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="co"># grid.size &lt;- 2</span></span>
<span id="cb38-20"><a href="hte-i-binary-treatment.html#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="co"># covariate.grid &lt;- c(0, 1)  </span></span>
<span id="cb38-21"><a href="hte-i-binary-treatment.html#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="hte-i-binary-treatment.html#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co"># For a continuous variable, select appropriate percentiles</span></span>
<span id="cb38-23"><a href="hte-i-binary-treatment.html#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="co"># percentiles &lt;- c(.1, .25, .5, .75, .9)</span></span>
<span id="cb38-24"><a href="hte-i-binary-treatment.html#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="co"># grid.size &lt;- length(percentiles)</span></span>
<span id="cb38-25"><a href="hte-i-binary-treatment.html#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="co"># covariate.grid &lt;- quantile(data[,selected.covariate], probs=percentiles)</span></span>
<span id="cb38-26"><a href="hte-i-binary-treatment.html#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="hte-i-binary-treatment.html#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Take median of other covariates </span></span>
<span id="cb38-28"><a href="hte-i-binary-treatment.html#cb38-28" aria-hidden="true" tabindex="-1"></a>medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(data[, other.covariates, F], <span class="dv">2</span>, median)</span>
<span id="cb38-29"><a href="hte-i-binary-treatment.html#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="hte-i-binary-treatment.html#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a dataset</span></span>
<span id="cb38-31"><a href="hte-i-binary-treatment.html#cb38-31" aria-hidden="true" tabindex="-1"></a>data.grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">sapply</span>(medians, <span class="cf">function</span>(x) <span class="fu">rep</span>(x, grid.size)), covariate.grid)</span>
<span id="cb38-32"><a href="hte-i-binary-treatment.html#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data.grid) <span class="ot">&lt;-</span> <span class="fu">c</span>(other.covariates, selected.covariate)</span>
<span id="cb38-33"><a href="hte-i-binary-treatment.html#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="hte-i-binary-treatment.html#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand the data</span></span>
<span id="cb38-35"><a href="hte-i-binary-treatment.html#cb38-35" aria-hidden="true" tabindex="-1"></a>X.grid <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data.grid)</span>
<span id="cb38-36"><a href="hte-i-binary-treatment.html#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="hte-i-binary-treatment.html#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Point predictions of the CATE and standard errors </span></span>
<span id="cb38-38"><a href="hte-i-binary-treatment.html#cb38-38" aria-hidden="true" tabindex="-1"></a>forest.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau, <span class="at">newdata =</span> X.grid, <span class="at">estimate.variance=</span><span class="cn">TRUE</span>)</span>
<span id="cb38-39"><a href="hte-i-binary-treatment.html#cb38-39" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> forest.pred<span class="sc">$</span>predictions</span>
<span id="cb38-40"><a href="hte-i-binary-treatment.html#cb38-40" aria-hidden="true" tabindex="-1"></a>tau.hat.se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(forest.pred<span class="sc">$</span>variance.estimates)</span>
<span id="cb38-41"><a href="hte-i-binary-treatment.html#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="hte-i-binary-treatment.html#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot predictions for each group and 95% confidence intervals around them.</span></span>
<span id="cb38-43"><a href="hte-i-binary-treatment.html#cb38-43" aria-hidden="true" tabindex="-1"></a>data.pred <span class="ot">&lt;-</span> <span class="fu">transform</span>(data.grid, <span class="at">tau.hat=</span>tau.hat, <span class="at">ci.low =</span> tau.hat <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>tau.hat.se, <span class="at">ci.high =</span> tau.hat <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>tau.hat.se)</span>
<span id="cb38-44"><a href="hte-i-binary-treatment.html#cb38-44" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.pred) <span class="sc">+</span></span>
<span id="cb38-45"><a href="hte-i-binary-treatment.html#cb38-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes_string</span>(<span class="at">x=</span>selected.covariate, <span class="at">y=</span><span class="st">&quot;tau.hat&quot;</span>, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">color=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-46"><a href="hte-i-binary-treatment.html#cb38-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes_string</span>(<span class="at">x=</span>selected.covariate, <span class="at">ymin=</span><span class="st">&quot;ci.low&quot;</span>, <span class="at">ymax=</span><span class="st">&quot;ci.high&quot;</span>, <span class="at">width=</span>.<span class="dv">2</span>), <span class="at">color=</span><span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-47"><a href="hte-i-binary-treatment.html#cb38-47" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-48"><a href="hte-i-binary-treatment.html#cb38-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Predicted treatment effect varying &#39;&quot;</span>, selected.covariate, <span class="st">&quot;&#39; (other variables fixed at median)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb38-49"><a href="hte-i-binary-treatment.html#cb38-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;polviews&quot;</span>, <span class="at">breaks=</span>covariate.grid, <span class="at">labels=</span><span class="fu">signif</span>(covariate.grid, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb38-50"><a href="hte-i-binary-treatment.html#cb38-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb38-51"><a href="hte-i-binary-treatment.html#cb38-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>Note that, in this example, we got fairly large confidence intervals. This can be explained in two ways. First, as we mentioned above, there’s a data scarcity problem. For example, even though the number of observations with <code>polviews</code> equal to <code>6</code> is not small,</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="hte-i-binary-treatment.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(data, <span class="fu">mean</span>(polviews <span class="sc">==</span> <span class="dv">6</span>))</span></code></pre></div>
<pre><code>## [1] 0.1545388</code></pre>
<p>there’s a much smaller fraction of individuals with <code>polviews</code> equal to <code>6</code> and (say) age close to the median age,</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="hte-i-binary-treatment.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">with</span>(data, (polviews <span class="sc">==</span> <span class="dv">6</span>) <span class="sc">&amp;</span> (<span class="fu">abs</span>(age <span class="sc">-</span> <span class="fu">median</span>(age)) <span class="sc">&lt;=</span> <span class="dv">3</span>))) <span class="co"># at most 3 yrs away</span></span></code></pre></div>
<pre><code>## [1] 0.02247583</code></pre>
<p>and an even smaller fraction of observations with <code>polviews</code> equal to <code>6</code> and every other variable close to the median. The second cause of wide confidence intervals is statistical. Since <code>grf</code> is a non-parametric model, we should expect fairly wide confidence intervals, especially in high-dimensional problems – that is an unavoidable consequence of avoiding modeling assumptions.</p>
<p><font size=2>
As documented in the original paper on generalized random forests (<a href="https://arxiv.org/abs/1610.01271">Athey, Tibshirani and Wager, 2019</a>), the coverage of <code>grf</code> confidence intervals can drop if the signal is too dense or too complex relative to the number of observations. Also, to a point, it’s possible to get tighter confidence intervals by increasing the number of trees; see this <a href="https://grf-labs.github.io/grf/articles/ci_and_num.trees.html">short vignette</a> for more information.
</font></p>
<p>We can vary more than one variable at a time. The next snippet shows predictions and standard errors varying two variables.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="hte-i-binary-treatment.html#cb43-1" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="st">&#39;polviews&#39;</span></span>
<span id="cb43-2"><a href="hte-i-binary-treatment.html#cb43-2" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="st">&#39;age&#39;</span></span>
<span id="cb43-3"><a href="hte-i-binary-treatment.html#cb43-3" aria-hidden="true" tabindex="-1"></a>selected.covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(x1, x2)</span>
<span id="cb43-4"><a href="hte-i-binary-treatment.html#cb43-4" aria-hidden="true" tabindex="-1"></a>other.covariates <span class="ot">&lt;-</span> covariates[<span class="sc">-</span><span class="fu">which</span>(covariates <span class="sc">%in%</span> selected.covariates)]</span>
<span id="cb43-5"><a href="hte-i-binary-treatment.html#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="hte-i-binary-treatment.html#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute a grid of values appropriate for the selected covariate</span></span>
<span id="cb43-7"><a href="hte-i-binary-treatment.html#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># See other options for constructing grids in the snippet above.</span></span>
<span id="cb43-8"><a href="hte-i-binary-treatment.html#cb43-8" aria-hidden="true" tabindex="-1"></a>x1.grid.size <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb43-9"><a href="hte-i-binary-treatment.html#cb43-9" aria-hidden="true" tabindex="-1"></a>x2.grid.size <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb43-10"><a href="hte-i-binary-treatment.html#cb43-10" aria-hidden="true" tabindex="-1"></a>x1.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(data[,x1]), <span class="fu">max</span>(data[,x1]), <span class="at">length.out=</span>x1.grid.size)</span>
<span id="cb43-11"><a href="hte-i-binary-treatment.html#cb43-11" aria-hidden="true" tabindex="-1"></a>x2.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(data[,x2]), <span class="fu">max</span>(data[,x2]), <span class="at">length.out=</span>x2.grid.size)</span>
<span id="cb43-12"><a href="hte-i-binary-treatment.html#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="hte-i-binary-treatment.html#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Take median of other covariates </span></span>
<span id="cb43-14"><a href="hte-i-binary-treatment.html#cb43-14" aria-hidden="true" tabindex="-1"></a>medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(data[, other.covariates, F], <span class="dv">2</span>, median)</span>
<span id="cb43-15"><a href="hte-i-binary-treatment.html#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="hte-i-binary-treatment.html#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct dataset</span></span>
<span id="cb43-17"><a href="hte-i-binary-treatment.html#cb43-17" aria-hidden="true" tabindex="-1"></a>data.grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb43-18"><a href="hte-i-binary-treatment.html#cb43-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sapply</span>(medians, <span class="cf">function</span>(x) <span class="fu">rep</span>(x, grid.size)), </span>
<span id="cb43-19"><a href="hte-i-binary-treatment.html#cb43-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">expand.grid</span>(x1.grid, x2.grid))</span>
<span id="cb43-20"><a href="hte-i-binary-treatment.html#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data.grid) <span class="ot">&lt;-</span> <span class="fu">c</span>(other.covariates, selected.covariates)</span>
<span id="cb43-21"><a href="hte-i-binary-treatment.html#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="hte-i-binary-treatment.html#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand the data according to formula used to fit forest</span></span>
<span id="cb43-23"><a href="hte-i-binary-treatment.html#cb43-23" aria-hidden="true" tabindex="-1"></a>X.grid <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data.grid)</span>
<span id="cb43-24"><a href="hte-i-binary-treatment.html#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="hte-i-binary-treatment.html#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Forest-based point estimates of CATE and standard errors around them</span></span>
<span id="cb43-26"><a href="hte-i-binary-treatment.html#cb43-26" aria-hidden="true" tabindex="-1"></a>forest.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau, <span class="at">newdata =</span> X.grid, <span class="at">estimate.variance=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-27"><a href="hte-i-binary-treatment.html#cb43-27" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> forest.pred<span class="sc">$</span>predictions</span>
<span id="cb43-28"><a href="hte-i-binary-treatment.html#cb43-28" aria-hidden="true" tabindex="-1"></a>tau.hat.se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(forest.pred<span class="sc">$</span>variance.estimates)</span>
<span id="cb43-29"><a href="hte-i-binary-treatment.html#cb43-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-30"><a href="hte-i-binary-treatment.html#cb43-30" aria-hidden="true" tabindex="-1"></a><span class="co"># A vector of labels for plotting below</span></span>
<span id="cb43-31"><a href="hte-i-binary-treatment.html#cb43-31" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(est, se) <span class="fu">paste0</span>(<span class="fu">signif</span>(est, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;(&quot;</span>, <span class="fu">signif</span>(se, <span class="dv">3</span>), <span class="st">&quot;)&quot;</span>), tau.hat, tau.hat.se)</span>
<span id="cb43-32"><a href="hte-i-binary-treatment.html#cb43-32" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X.grid, tau.hat, labels)</span>
<span id="cb43-33"><a href="hte-i-binary-treatment.html#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="hte-i-binary-treatment.html#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb43-35"><a href="hte-i-binary-treatment.html#cb43-35" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb43-36"><a href="hte-i-binary-treatment.html#cb43-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(age, polviews) <span class="sc">+</span></span>
<span id="cb43-37"><a href="hte-i-binary-treatment.html#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> tau.hat)) <span class="sc">+</span> </span>
<span id="cb43-38"><a href="hte-i-binary-treatment.html#cb43-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> labels)) <span class="sc">+</span></span>
<span id="cb43-39"><a href="hte-i-binary-treatment.html#cb43-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">high =</span> <span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-40"><a href="hte-i-binary-treatment.html#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;polviews&quot;</span>, <span class="at">breaks=</span>x1.grid, <span class="at">labels=</span><span class="fu">signif</span>(x1.grid, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb43-41"><a href="hte-i-binary-treatment.html#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">&quot;age&quot;</span>, <span class="at">breaks=</span>x2.grid, <span class="at">labels=</span><span class="fu">signif</span>(x2.grid, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb43-42"><a href="hte-i-binary-treatment.html#cb43-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Predicted treatment effect varying &#39;&quot;</span>, x1, <span class="st">&quot;&#39; and &#39;&quot;</span>, x2, <span class="st">&quot;&#39; (other variables fixed at median)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb43-43"><a href="hte-i-binary-treatment.html#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb43-44"><a href="hte-i-binary-treatment.html#cb43-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="further-reading" class="section level2" number="22.3">
<h2><span class="header-section-number">22.3</span> Further reading</h2>
<p>A readable summary of different method for hypothesis testing correction is laid out in the introduction to <a href="http://ftp.iza.org/dp12845.pdf">Clarke, Romano and Wolf (2009)</a>.</p>
<p><a href="https://arxiv.org/abs/1902.07409">Athey and Wager (2019)</a> shows an application of causal forests to heterogeity analysis in a setting with clustering.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="a-simple-example-of-properties-of-iv-estimator-when-instruments-are-weak.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/alexanderquispe/ml_book/edit/master/33-heterogeneous-treatment-effect-1.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/alexanderquispe/ml_book/blob/master/33-heterogeneous-treatment-effect-1.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
